From ca7d131f7feed75d0a78486c0272bb3431065128 Mon Sep 17 00:00:00 2001
From: Lars Wendler <polynomial-c@gmx.de>
Date: Wed, 7 May 2025 14:09:14 +0200
Subject: [PATCH 4/4] Revert "trivial: Remove -Dplugin_uefi_pk build option"

This reverts commit 22458a6ee90c31aec678a5a08c1dc4bb40c5143a.
---
 contrib/fwupd.spec.in       | 2 ++
 meson_options.txt           | 4 ++++
 plugins/tpm/meson.build     | 3 +--
 plugins/uefi-pk/meson.build | 5 +++++
 4 files changed, 12 insertions(+), 2 deletions(-)

diff --git a/contrib/fwupd.spec.in b/contrib/fwupd.spec.in
index 8a70315d1..8fd66a681 100644
--- a/contrib/fwupd.spec.in
+++ b/contrib/fwupd.spec.in
@@ -248,9 +248,11 @@ fwupd wrapper for Qubes OS
 %endif
 %if 0%{?have_uefi}
     -Dplugin_uefi_capsule=enabled \
+    -Dplugin_uefi_pk=enabled \
     -Dplugin_tpm=enabled \
 %else
     -Dplugin_uefi_capsule=disabled \
+    -Dplugin_uefi_pk=disabled \
     -Dplugin_tpm=disabled \
 %endif
 %if 0%{?have_modem_manager}
diff --git a/meson_options.txt b/meson_options.txt
index be7a71290..826e36746 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -150,6 +150,10 @@ option('plugin_uefi_capsule_splash',
   value: true,
   description: 'enable UEFI capsule splash support',
 )
+option('plugin_uefi_pk',
+  type: 'feature',
+  description: 'UEFI PK support',
+)
 option('polkit',
   type: 'feature',
   description: 'PolKit support in daemon',
diff --git a/plugins/tpm/meson.build b/plugins/tpm/meson.build
index 5ff9cb4c2..514d3c51e 100644
--- a/plugins/tpm/meson.build
+++ b/plugins/tpm/meson.build
@@ -3,8 +3,7 @@ tpm2tss_tpm = dependency('tss2-esys', version: '>= 2.0', required: get_option('p
 if hsi and \
    tpm2tss_tpm.found() and \
    host_machine.system() == 'linux' and \
-   get_option('plugin_tpm').require(enable_udev,
-    error_message: 'udev is needed for plugin_tpm').allowed()
+   get_option('plugin_tpm').enabled()
 cargs = ['-DG_LOG_DOMAIN="FuPluginTpm"']
 plugins += {meson.current_source_dir().split('/')[-1]: true}
 
diff --git a/plugins/uefi-pk/meson.build b/plugins/uefi-pk/meson.build
index efd55b570..8de9444d3 100644
--- a/plugins/uefi-pk/meson.build
+++ b/plugins/uefi-pk/meson.build
@@ -1,3 +1,6 @@
+if hsi and \
+   get_option('plugin_uefi_pk').require(gnutls.found(),
+   error_message: 'gnutls is needed for plugin_uefi_pk').allowed()
 cargs = ['-DG_LOG_DOMAIN="FuPluginUefiPk"']
 plugins += {meson.current_source_dir().split('/')[-1]: true}
 
@@ -14,3 +17,5 @@ plugin_builtins += static_library('fu_plugin_uefi_pk',
 )
 enumeration_data += files('tests/uefi-pk-setup.json')
 device_tests += files('tests/uefi-pk.json')
+
+endif
-- 
2.49.0

