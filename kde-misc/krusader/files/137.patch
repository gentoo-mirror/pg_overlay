From 4988620e78c5e4196a9c436503b9a1eb109d8a7e Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 21:26:34 +0300
Subject: [PATCH 01/68] Adapt CMakeFiles to kf6 and qt6 builds

Changes include:
* Changing the KF5 namespace to KF6
* Remove definitions that can impact the build
* Remove some useless defines, and reenable the i18n install of files
* Update the install paths for ui files, krarc and iso plugins
---
 CMakeLists.txt                     | 18 +++++++++++-------
 app/ActionMan/CMakeLists.txt       | 21 ++++++++++++---------
 app/Archive/CMakeLists.txt         | 10 +++++-----
 app/BookMan/CMakeLists.txt         | 22 +++++++++++-----------
 app/CMakeLists.txt                 | 14 +++++++-------
 app/Dialogs/CMakeLists.txt         | 25 +++++++++++++------------
 app/DiskUsage/CMakeLists.txt       | 14 +++++++-------
 app/FileSystem/CMakeLists.txt      |  9 +++++----
 app/Filter/CMakeLists.txt          | 10 +++++-----
 app/GUI/CMakeLists.txt             | 23 +++++++++++++----------
 app/JobMan/CMakeLists.txt          | 10 +++++-----
 app/KViewer/CMakeLists.txt         | 29 +++++++++++++++++------------
 app/Konfigurator/CMakeLists.txt    | 21 +++++++++++----------
 app/Locate/CMakeLists.txt          | 22 ++++++++++++----------
 app/MountMan/CMakeLists.txt        | 12 ++++++------
 app/Panel/CMakeLists.txt           | 23 ++++++++++++-----------
 app/Panel/PanelView/CMakeLists.txt | 20 ++++++++++----------
 app/Search/CMakeLists.txt          |  7 ++++---
 app/Splitter/CMakeLists.txt        |  8 ++++----
 app/Synchronizer/CMakeLists.txt    | 16 +++++++++-------
 app/UserAction/CMakeLists.txt      | 23 +++++++++++++----------
 plugins/iso/CMakeLists.txt         | 10 +++++-----
 plugins/krarc/CMakeLists.txt       | 17 +++++++++--------
 23 files changed, 206 insertions(+), 178 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 6d7fce459..a9307923f 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -5,15 +5,15 @@ project(krusader)
 set(VERSION "2.9.0-dev")
 set(RELEASE_NAME "Bleeding Edge")
 
-set(MIN_QT_VERSION 5.12)
-set(MIN_KF_VERSION 5.108)
+set(MIN_QT_VERSION "6.4.0")
+set(KF6_MIN_VERSION "5.240.0")
 
 
 # ===== Packages =====
 
-find_package(ECM ${MIN_KF_VERSION} REQUIRED NO_MODULE)
+find_package(ECM ${KF6_MIN_VERSION} CONFIG REQUIRED)
 set(CMAKE_MODULE_PATH ${ECM_MODULE_PATH})
-set(KDE_COMPILERSETTINGS_LEVEL "5.68")
+set(KDE_COMPILERSETTINGS_LEVEL "5.200")
 
 include(KDEInstallDirs)
 include(KDECMakeSettings)
@@ -23,11 +23,12 @@ include(KDEGitCommitHooks)
 
 include(ECMInstallIcons)
 include(ECMAddAppIcon)
+include(ECMQtDeclareLoggingCategory)
 
 include(FeatureSummary)
 include(CheckIncludeFiles)
 
-find_package(Qt5 ${MIN_QT_VERSION} CONFIG REQUIRED
+find_package(Qt6 ${MIN_QT_VERSION} CONFIG REQUIRED COMPONENTS
   Concurrent
   Core
   Gui
@@ -35,9 +36,10 @@ find_package(Qt5 ${MIN_QT_VERSION} CONFIG REQUIRED
   Widgets
   PrintSupport
   Xml
+  Core5Compat
 )
 
-find_package(KF5 ${MIN_KF_VERSION} REQUIRED COMPONENTS
+find_package(KF6 ${KF6_MIN_VERSION} REQUIRED COMPONENTS
   Archive
   Bookmarks
   Codecs
@@ -58,6 +60,7 @@ find_package(KF5 ${MIN_KF_VERSION} REQUIRED COMPONENTS
   WindowSystem
   XmlGui
   GuiAddons
+  StatusNotifierItem
 )
 
 
@@ -145,6 +148,7 @@ if (CMAKE_COMPILER_IS_GNUCXX)
                          -Wnon-virtual-dtor -Wctor-dtor-privacy -Wzero-as-null-pointer-constant" CACHE STRING "" FORCE)
 endif()
 
+remove_definitions(-DQT_NO_KEYWORDS  -DQT_NO_CAST_FROM_ASCII -DQT_NO_CAST_TO_ASCII)
 
 # ===== Subdirectories =====
 
@@ -157,7 +161,7 @@ add_subdirectory(plugins/krarc)
 # ===== Translations =====
 
 ki18n_install(po)
-kdoctools_install(po)
+# kdoctools_install(po)
 
 # ==== clang-format target and commit hook ====
 
diff --git a/app/ActionMan/CMakeLists.txt b/app/ActionMan/CMakeLists.txt
index 11d849cdc..d3da4cd4a 100644
--- a/app/ActionMan/CMakeLists.txt
+++ b/app/ActionMan/CMakeLists.txt
@@ -13,13 +13,16 @@ ki18n_wrap_ui (
 add_library(ActionMan STATIC ${ActionMan_SRCS})
 
 target_link_libraries(ActionMan
-    KF5::ConfigCore
-    KF5::I18n
-    KF5::IconThemes
-    KF5::KIOCore
-    KF5::KIOWidgets
-    KF5::Notifications
-    KF5::Parts
-    KF5::WidgetsAddons
-    Qt5::Xml
+    KF6::ConfigCore
+    KF6::I18n
+    KF6::IconThemes
+    KF6::IconWidgets
+    KF6::KIOCore
+    KF6::KIOWidgets
+    KF6::Notifications
+    KF6::Parts
+    KF6::WidgetsAddons
+    KF6::TextWidgets
+    KF6::StatusNotifierItem
+    Qt6::Xml
 )
diff --git a/app/Archive/CMakeLists.txt b/app/Archive/CMakeLists.txt
index 63e2ab791..9421372c6 100644
--- a/app/Archive/CMakeLists.txt
+++ b/app/Archive/CMakeLists.txt
@@ -10,9 +10,9 @@ set(Archive_SRCS
 add_library(Archive STATIC ${Archive_SRCS})
 
 target_link_libraries(Archive
-    KF5::Archive
-    KF5::I18n
-    KF5::KIOCore
-    KF5::KIOWidgets
-    KF5::Wallet
+    KF6::Archive
+    KF6::I18n
+    KF6::KIOCore
+    KF6::KIOWidgets
+    KF6::Wallet
 )
diff --git a/app/BookMan/CMakeLists.txt b/app/BookMan/CMakeLists.txt
index db68f750f..be54cc859 100644
--- a/app/BookMan/CMakeLists.txt
+++ b/app/BookMan/CMakeLists.txt
@@ -7,15 +7,15 @@ set(BookMan_SRCS
 add_library(BookMan STATIC ${BookMan_SRCS})
 
 target_link_libraries(BookMan
-    KF5::Archive
-    KF5::Bookmarks
-    KF5::Completion
-    KF5::ConfigCore
-    KF5::ConfigWidgets
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::IconThemes
-    KF5::KIOCore
-    KF5::XmlGui
-    Qt5::Xml
+    KF6::Archive
+    KF6::Bookmarks
+    KF6::Completion
+    KF6::ConfigCore
+    KF6::ConfigWidgets
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::IconThemes
+    KF6::KIOCore
+    KF6::XmlGui
+    Qt6::Xml
 )
diff --git a/app/CMakeLists.txt b/app/CMakeLists.txt
index 5b3493b9a..29e2e3eac 100644
--- a/app/CMakeLists.txt
+++ b/app/CMakeLists.txt
@@ -43,7 +43,7 @@ set(krusader_SRCS
 file(GLOB ICONS_SRCS "${CMAKE_CURRENT_SOURCE_DIR}/icons/*-apps-krusader_user.png")
 ecm_add_app_icon(krusader_SRCS ICONS ${ICONS_SRCS})
 
-qt5_add_resources(krusader_RC_SRCS "${CMAKE_CURRENT_SOURCE_DIR}/resources.qrc" )
+qt6_add_resources(krusader_RC_SRCS "${CMAKE_CURRENT_SOURCE_DIR}/resources.qrc" )
 
 add_executable(krusader ${krusader_SRCS} ${krusader_RC_SRCS})
 
@@ -69,11 +69,11 @@ target_link_libraries(krusader
                       GUI
                       Archive
                       JobMan
-                      KF5::Notifications
-                      KF5::Parts
-                      KF5::WindowSystem
-                      Qt5::PrintSupport
-                      Qt5::Concurrent
+                      KF6::Notifications
+                      KF6::Parts
+                      KF6::WindowSystem
+                      Qt6::PrintSupport
+                      Qt6::Concurrent
 )
 
 if(SYNCHRONIZER_ENABLED)
@@ -86,7 +86,7 @@ install(PROGRAMS org.kde.krusader.desktop
 install(FILES krusaderui.rc
               krusaderlisterui.rc
               krviewer.rc
-        DESTINATION ${KDE_INSTALL_KXMLGUI5DIR}/krusader)
+        DESTINATION ${KDE_INSTALL_KXMLGUIDIR}/krusader)
 install(FILES midnight_commander.color
               total_commander.color
               total_commander.keymap
diff --git a/app/Dialogs/CMakeLists.txt b/app/Dialogs/CMakeLists.txt
index 6f5286ac9..321226f66 100644
--- a/app/Dialogs/CMakeLists.txt
+++ b/app/Dialogs/CMakeLists.txt
@@ -17,16 +17,17 @@ set(Dialogs_SRCS
 add_library(Dialogs STATIC ${Dialogs_SRCS})
 
 target_link_libraries(Dialogs
-    KF5::Archive
-    KF5::Completion
-    KF5::ConfigWidgets
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::IconThemes
-    KF5::ItemViews
-    KF5::KIOCore
-    KF5::KIOWidgets
-    KF5::Notifications
-    KF5::Parts
-    KF5::WidgetsAddons
+    KF6::Archive
+    KF6::Completion
+    KF6::ConfigWidgets
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::IconThemes
+    KF6::ItemViews
+    KF6::KIOCore
+    KF6::KIOWidgets
+    KF6::Notifications
+    KF6::Parts
+    KF6::WidgetsAddons
+    KF6::StatusNotifierItem
 )
diff --git a/app/DiskUsage/CMakeLists.txt b/app/DiskUsage/CMakeLists.txt
index 4cb4eb17b..f027c4dec 100644
--- a/app/DiskUsage/CMakeLists.txt
+++ b/app/DiskUsage/CMakeLists.txt
@@ -13,11 +13,11 @@ set(DiskUsage_SRCS
 add_library(DiskUsage STATIC ${DiskUsage_SRCS} ${radialMap_SRCS} ${filelightParts_SRCS})
 
 target_link_libraries(DiskUsage
-    KF5::Archive
-    KF5::ConfigWidgets
-    KF5::I18n
-    KF5::IconThemes
-    KF5::KIOCore
-    KF5::KIOWidgets
-    KF5::WidgetsAddons
+    KF6::Archive
+    KF6::ConfigWidgets
+    KF6::I18n
+    KF6::IconThemes
+    KF6::KIOCore
+    KF6::KIOWidgets
+    KF6::WidgetsAddons
 )
diff --git a/app/FileSystem/CMakeLists.txt b/app/FileSystem/CMakeLists.txt
index 2f9a756b3..a582775a6 100644
--- a/app/FileSystem/CMakeLists.txt
+++ b/app/FileSystem/CMakeLists.txt
@@ -14,10 +14,11 @@ set(FileSystem_SRCS
 add_library(FileSystem STATIC ${FileSystem_SRCS})
 
 target_link_libraries(FileSystem
-    KF5::Archive
-    KF5::I18n
-    KF5::KIOCore
-    KF5::KIOWidgets
+    KF6::Archive
+    KF6::I18n
+    KF6::KIOCore
+    KF6::KIOWidgets
+    Qt6::Core5Compat # For QRegExp
 )
 
 if(ACL_FOUND)
diff --git a/app/Filter/CMakeLists.txt b/app/Filter/CMakeLists.txt
index 24ea86517..1e92bf4c1 100644
--- a/app/Filter/CMakeLists.txt
+++ b/app/Filter/CMakeLists.txt
@@ -9,9 +9,9 @@ add_library(Filter STATIC ${Filter_SRCS})
 
 target_link_libraries(Filter
     Dialogs
-    KF5::Codecs
-    KF5::ConfigCore
-    KF5::I18n
-    KF5::IconThemes
-    KF5::WidgetsAddons
+    KF6::Codecs
+    KF6::ConfigCore
+    KF6::I18n
+    KF6::IconThemes
+    KF6::WidgetsAddons
 )
diff --git a/app/GUI/CMakeLists.txt b/app/GUI/CMakeLists.txt
index ae3428d02..38d0eeebd 100644
--- a/app/GUI/CMakeLists.txt
+++ b/app/GUI/CMakeLists.txt
@@ -17,14 +17,17 @@ set(GUI_SRCS
 add_library(GUI STATIC ${GUI_SRCS})
 
 target_link_libraries(GUI
-    KF5::Archive
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::IconThemes
-    KF5::Parts
-    KF5::Service
-    KF5::Solid
-    KF5::WidgetsAddons
-    KF5::KIOFileWidgets
+    KF6::Archive
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::Codecs
+    KF6::I18n
+    KF6::IconThemes
+    KF6::Parts
+    KF6::Service
+    KF6::Solid
+    KF6::WidgetsAddons
+    KF6::KIOFileWidgets
+    Qt6::Widgets
+    Qt6::Core5Compat
 )
diff --git a/app/JobMan/CMakeLists.txt b/app/JobMan/CMakeLists.txt
index 2c34dc466..93b93ed02 100644
--- a/app/JobMan/CMakeLists.txt
+++ b/app/JobMan/CMakeLists.txt
@@ -5,9 +5,9 @@ set(JobMan_SRCS
 add_library(JobMan STATIC ${JobMan_SRCS})
 
 target_link_libraries(JobMan
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::KIOWidgets
-    KF5::WidgetsAddons
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::KIOWidgets
+    KF6::WidgetsAddons
 )
diff --git a/app/KViewer/CMakeLists.txt b/app/KViewer/CMakeLists.txt
index 5718bd7db..704f1372e 100644
--- a/app/KViewer/CMakeLists.txt
+++ b/app/KViewer/CMakeLists.txt
@@ -8,16 +8,21 @@ set(KViewer_SRCS
 add_library(KViewer STATIC ${KViewer_SRCS})
 
 target_link_libraries(KViewer
-    Qt5::PrintSupport
-    KF5::Archive
-    KF5::ConfigCore
-    KF5::ConfigWidgets
-    KF5::CoreAddons
-    KF5::IconThemes
-    KF5::KIOCore
-    KF5::KIOFileWidgets
-    KF5::WindowSystem
-    KF5::Parts
-    KF5::WidgetsAddons
-    KF5::XmlGui
+    Qt6::PrintSupport
+    Qt6::Core5Compat
+    KF6::Archive
+    KF6::Codecs
+    KF6::ConfigCore
+    KF6::ConfigWidgets
+    KF6::CoreAddons
+    KF6::IconThemes
+    KF6::KIOWidgets
+    KF6::KIOCore
+    KF6::KIOFileWidgets
+    KF6::TextWidgets
+    KF6::Service
+    KF6::WindowSystem
+    KF6::Parts
+    KF6::WidgetsAddons
+    KF6::XmlGui
 )
diff --git a/app/Konfigurator/CMakeLists.txt b/app/Konfigurator/CMakeLists.txt
index b4e3970fd..a37bbb91d 100644
--- a/app/Konfigurator/CMakeLists.txt
+++ b/app/Konfigurator/CMakeLists.txt
@@ -18,14 +18,15 @@ set(Konfigurator_SRCS
 add_library(Konfigurator STATIC ${Konfigurator_SRCS})
 
 target_link_libraries(Konfigurator
-    KF5::Archive
-    KF5::I18n
-    KF5::IconThemes
-    KF5::KIOCore
-    KF5::KIOWidgets
-    KF5::ConfigCore
-    KF5::ConfigWidgets
-    KF5::WidgetsAddons
-    KF5::GuiAddons
-    Qt5::Xml
+    KF6::Archive
+    KF6::I18n
+    KF6::IconThemes
+    KF6::KIOCore
+    KF6::KIOWidgets
+    KF6::ConfigCore
+    KF6::ConfigWidgets
+    KF6::WidgetsAddons
+    KF6::GuiAddons
+    Qt6::Xml
+    Qt6::Core5Compat
 )
diff --git a/app/Locate/CMakeLists.txt b/app/Locate/CMakeLists.txt
index 3866eaedb..02616e3b0 100644
--- a/app/Locate/CMakeLists.txt
+++ b/app/Locate/CMakeLists.txt
@@ -4,14 +4,16 @@ set(Locate_SRCS
 add_library(Locate STATIC ${Locate_SRCS})
 
 target_link_libraries(Locate
-    KF5::Archive
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::Completion
-    KF5::KIOCore
-    KF5::I18n
-    KF5::IconThemes
-    KF5::Parts
-    KF5::TextWidgets
-    KF5::WidgetsAddons
+    KF6::Archive
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::Completion
+    KF6::KIOCore
+    KF6::I18n
+    KF6::IconThemes
+    KF6::Parts
+    KF6::TextWidgets
+    KF6::WidgetsAddons
+    KF6::Service
+    Qt6::Core5Compat
 )
diff --git a/app/MountMan/CMakeLists.txt b/app/MountMan/CMakeLists.txt
index 4e34ac095..71dd8d7d6 100644
--- a/app/MountMan/CMakeLists.txt
+++ b/app/MountMan/CMakeLists.txt
@@ -6,10 +6,10 @@ add_library(MountMan STATIC ${MountMan_SRCS})
 
 target_link_libraries(MountMan
     Dialogs
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::KIOCore
-    KF5::WidgetsAddons
-    KF5::Solid
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::KIOCore
+    KF6::WidgetsAddons
+    KF6::Solid
 )
diff --git a/app/Panel/CMakeLists.txt b/app/Panel/CMakeLists.txt
index 7687be017..8b19c6e67 100644
--- a/app/Panel/CMakeLists.txt
+++ b/app/Panel/CMakeLists.txt
@@ -27,15 +27,16 @@ target_link_libraries(Panel
     Dialogs
     GUI
     KViewer
-    KF5::Archive
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::IconThemes
-    KF5::KIOFileWidgets
-    KF5::KIOWidgets
-    KF5::Service
-    KF5::WidgetsAddons
-    KF5::XmlGui
-    Qt5::Xml
+    KF6::Archive
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::IconThemes
+    KF6::KIOFileWidgets
+    KF6::KIOWidgets
+    KF6::Service
+    KF6::WidgetsAddons
+    KF6::XmlGui
+    Qt6::Xml
+    Qt6::Core5Compat
 )
diff --git a/app/Panel/PanelView/CMakeLists.txt b/app/Panel/PanelView/CMakeLists.txt
index 8b396844f..e01a43315 100644
--- a/app/Panel/PanelView/CMakeLists.txt
+++ b/app/Panel/PanelView/CMakeLists.txt
@@ -19,14 +19,14 @@ target_link_libraries(PanelView
     Dialogs
     GUI
     KViewer
-    KF5::Archive
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::IconThemes
-    KF5::KIOFileWidgets
-    KF5::KIOWidgets
-    KF5::Service
-    KF5::WidgetsAddons
-    KF5::XmlGui
+    KF6::Archive
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::IconThemes
+    KF6::KIOFileWidgets
+    KF6::KIOWidgets
+    KF6::Service
+    KF6::WidgetsAddons
+    KF6::XmlGui
 )
diff --git a/app/Search/CMakeLists.txt b/app/Search/CMakeLists.txt
index 29a672803..dabe4f175 100644
--- a/app/Search/CMakeLists.txt
+++ b/app/Search/CMakeLists.txt
@@ -6,7 +6,8 @@ add_library(Search STATIC ${Search_SRCS})
 
 target_link_libraries(Search
     Dialogs
-    KF5::I18n
-    KF5::KIOCore
-    KF5::WidgetsAddons
+    KF6::I18n
+    KF6::KIOCore
+    KF6::WidgetsAddons
+    Qt6::Core5Compat
 )
diff --git a/app/Splitter/CMakeLists.txt b/app/Splitter/CMakeLists.txt
index 2249a61fc..edbb96285 100644
--- a/app/Splitter/CMakeLists.txt
+++ b/app/Splitter/CMakeLists.txt
@@ -7,8 +7,8 @@ set(Splitter_SRCS
 add_library(Splitter STATIC ${Splitter_SRCS})
 
 target_link_libraries(Splitter
-    KF5::ConfigCore
-    KF5::I18n
-    KF5::KIOWidgets
-    KF5::WidgetsAddons
+    KF6::ConfigCore
+    KF6::I18n
+    KF6::KIOWidgets
+    KF6::WidgetsAddons
 )
diff --git a/app/Synchronizer/CMakeLists.txt b/app/Synchronizer/CMakeLists.txt
index ffe872a99..2421d7215 100644
--- a/app/Synchronizer/CMakeLists.txt
+++ b/app/Synchronizer/CMakeLists.txt
@@ -10,11 +10,13 @@ add_library(Synchronizer STATIC ${Synchronizer_SRCS})
 
 target_link_libraries(Synchronizer
     Dialogs
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::KIOWidgets
-    KF5::WidgetsAddons
-    KF5::GuiAddons
-    KF5::KIOFileWidgets
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::KIOWidgets
+    KF6::WidgetsAddons
+    KF6::GuiAddons
+    KF6::KIOFileWidgets
+    KF6::Parts
+    Qt6::Core5Compat
 )
diff --git a/app/UserAction/CMakeLists.txt b/app/UserAction/CMakeLists.txt
index 23a7ff30a..d39ae27dc 100644
--- a/app/UserAction/CMakeLists.txt
+++ b/app/UserAction/CMakeLists.txt
@@ -8,14 +8,17 @@ set(UserAction_SRCS
 add_library(UserAction STATIC ${UserAction_SRCS})
 
 target_link_libraries(UserAction
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::IconThemes
-    KF5::Notifications
-    KF5::Parts
-    KF5::WidgetsAddons
-    KF5::XmlGui
-    KF5::KIOFileWidgets
-    Qt5::Xml
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::IconThemes
+    KF6::Notifications
+    KF6::Parts
+    KF6::WidgetsAddons
+    KF6::XmlGui
+    KF6::TextWidgets
+    KF6::KIOFileWidgets
+    KF6::StatusNotifierItem
+    Qt6::Xml
+    Qt6::Core5Compat
 )
diff --git a/plugins/iso/CMakeLists.txt b/plugins/iso/CMakeLists.txt
index d85f8c891..53f98114e 100644
--- a/plugins/iso/CMakeLists.txt
+++ b/plugins/iso/CMakeLists.txt
@@ -11,16 +11,16 @@ set(kio_iso_PART_SRCS
     ../../app/krdebuglogger.cpp
 )
 
-kcoreaddons_add_plugin(kio_iso SOURCES ${kio_iso_PART_SRCS} ${libisofs_SRCS} INSTALL_NAMESPACE "kf5/kio")
+kcoreaddons_add_plugin(kio_iso SOURCES ${kio_iso_PART_SRCS} ${libisofs_SRCS} INSTALL_NAMESPACE "kf6/kio")
 
 #this is a library so it needs to enforce it's translation domain, not use the application's domain.
 add_definitions(-DTRANSLATION_DOMAIN="krusader")
 
 target_link_libraries(kio_iso
-    KF5::Archive
-    KF5::Completion
-    KF5::ConfigCore
-    KF5::KIOCore
+    KF6::Archive
+    KF6::Completion
+    KF6::ConfigCore
+    KF6::KIOCore
     ${ZLIB_LIBRARY}
 )
 
diff --git a/plugins/krarc/CMakeLists.txt b/plugins/krarc/CMakeLists.txt
index 2a0518fd9..3cb85bd5f 100644
--- a/plugins/krarc/CMakeLists.txt
+++ b/plugins/krarc/CMakeLists.txt
@@ -5,18 +5,19 @@ set(kio_krarc_PART_SRCS
     ../../app/krdebuglogger.cpp
 )
 
-kcoreaddons_add_plugin(kio_krarc SOURCES ${kio_krarc_PART_SRCS} INSTALL_NAMESPACE "kf5/kio")
+kcoreaddons_add_plugin(kio_krarc SOURCES ${kio_krarc_PART_SRCS} INSTALL_NAMESPACE "kf6/kio")
 
 #this is a library so it needs to enforce it's translation domain, not use the application's domain.
 add_definitions(-DTRANSLATION_DOMAIN="krusader")
 
 # TODO porting : new variables needed?
 target_link_libraries(kio_krarc
-    Qt5::Gui
-    KF5::Archive
-    KF5::Completion
-    KF5::ConfigCore
-    KF5::CoreAddons
-    KF5::I18n
-    KF5::KIOCore
+    Qt6::Gui
+    Qt6::Core5Compat
+    KF6::Archive
+    KF6::Completion
+    KF6::ConfigCore
+    KF6::CoreAddons
+    KF6::I18n
+    KF6::KIOCore
 )
-- 
GitLab


From 996934f9ee87e27b90e84784ff54d027773dac06 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 21:52:30 +0300
Subject: [PATCH 02/68] Fix UI file

Should use the Kf6 headers
---
 app/ActionMan/actionproperty.ui | 6 +++---
 1 file changed, 3 insertions(+), 3 deletions(-)

diff --git a/app/ActionMan/actionproperty.ui b/app/ActionMan/actionproperty.ui
index 549294aaf..66e1db982 100644
--- a/app/ActionMan/actionproperty.ui
+++ b/app/ActionMan/actionproperty.ui
@@ -991,7 +991,7 @@ Please consult the handbook to learn more about the syntax.</string>
   <customwidget>
    <class>KIconButton</class>
    <extends>QPushButton</extends>
-   <header>kiconbutton.h</header>
+   <header>KIconButton</header>
   </customwidget>
   <customwidget>
    <class>KComboBox</class>
@@ -1045,11 +1045,11 @@ Please consult the handbook to learn more about the syntax.</string>
   <include location="local">klineedit.h</include>
   <include location="local">kcombobox.h</include>
   <include location="local">klineedit.h</include>
-  <include location="local">kicondialog.h</include>
+  <include >KIconDialog</include>
   <include location="local">klineedit.h</include>
   <include location="local">klineedit.h</include>
   <include location="local">klineedit.h</include>
-  <include location="local">ktextedit.h</include>
+  <include location="local">KTextEdit</include>
   <include location="local">kkeysequencewidget.h</include>
   <include location="local">../GUI/krlistwidget.h</include>
   <include location="local">../GUI/krlistwidget.h</include>
-- 
GitLab


From ef7c3af9b68927f2f50f0e896f436710b0083a81 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 21:54:32 +0300
Subject: [PATCH 03/68] Fix the ISO plugin

Adapt to the new qt6 APIs -> toSecsSinceEpoch instead of toTime_t and a
.data() call on QStrings since QT_NO_CAST_FROM_BYTEARRAY will be
deprecated
---
 plugins/iso/iso.cpp           |  8 ++++----
 plugins/iso/kiso.cpp          | 12 ++++--------
 plugins/iso/kisodirectory.cpp |  2 +-
 plugins/iso/kisofile.cpp      |  2 +-
 4 files changed, 10 insertions(+), 14 deletions(-)

diff --git a/plugins/iso/iso.cpp b/plugins/iso/iso.cpp
index 072ac7135..7fe828b2a 100644
--- a/plugins/iso/iso.cpp
+++ b/plugins/iso/iso.cpp
@@ -87,7 +87,7 @@ bool kio_isoProtocol::checkNewFile(QString fullPath, QString &path, int startsec
     if (m_isoFile && startsec == m_isoFile->startSec() && m_isoFile->fileName() == fullPath.left(m_isoFile->fileName().length())) {
         // Has it changed ?
         QT_STATBUF statbuf;
-        if (QT_STAT(QFile::encodeName(m_isoFile->fileName()), &statbuf) == 0) {
+        if (QT_STAT(QFile::encodeName(m_isoFile->fileName()).data(), &statbuf) == 0) {
             if (m_mtime == statbuf.st_mtime) {
                 path = fullPath.mid(m_isoFile->fileName().length());
                 // qDebug()   << "kio_isoProtocol::checkNewFile returning " << path << endl;
@@ -125,12 +125,12 @@ bool kio_isoProtocol::checkNewFile(QString fullPath, QString &path, int startsec
         // qDebug()   << fullPath << "  trying " << tryPath << endl;
 
         QT_STATBUF statbuf;
-        if (QT_LSTAT(QFile::encodeName(tryPath), &statbuf) == 0 && !S_ISDIR(statbuf.st_mode)) {
+        if (QT_LSTAT(QFile::encodeName(tryPath).data(), &statbuf) == 0 && !S_ISDIR(statbuf.st_mode)) {
             bool isFile = true;
             if (S_ISLNK(statbuf.st_mode)) {
                 char symDest[256];
                 memset(symDest, 0, 256);
-                ssize_t endOfName = readlink(QFile::encodeName(tryPath), symDest, 256);
+                ssize_t endOfName = readlink(QFile::encodeName(tryPath).data(), symDest, 256);
                 if (endOfName != -1) {
                     if (QDir(QString::fromLocal8Bit(symDest)).exists())
                         isFile = false;
@@ -191,7 +191,7 @@ void kio_isoProtocol::createUDSEntry(const KArchiveEntry *isoEntry, UDSEntry &en
 
     entry.fastInsert(UDSEntry::UDS_USER, isoEntry->user());
     entry.fastInsert(UDSEntry::UDS_GROUP, isoEntry->group());
-    entry.fastInsert((uint)UDSEntry::UDS_MODIFICATION_TIME, isoEntry->date().toTime_t());
+    entry.fastInsert((uint)UDSEntry::UDS_MODIFICATION_TIME, isoEntry->date().toSecsSinceEpoch());
     entry.fastInsert(UDSEntry::UDS_ACCESS_TIME,
                      isoEntry->isFile() ? (dynamic_cast<const KIsoFile *>(isoEntry))->adate() : (dynamic_cast<const KIsoDirectory *>(isoEntry))->adate());
 
diff --git a/plugins/iso/kiso.cpp b/plugins/iso/kiso.cpp
index e74a7f81e..cd1eb58aa 100644
--- a/plugins/iso/kiso.cpp
+++ b/plugins/iso/kiso.cpp
@@ -22,7 +22,7 @@
 #include <KConfig>
 #include <KConfigGroup>
 #include <KFilterBase>
-#include <KFilterDev>
+#include <KCompressionDevice>
 
 #include "libisofs/isofs.h"
 #include "qfilehack.h"
@@ -161,11 +161,7 @@ void KIso::prepareDevice(const QString &filename, const QString &mimetype, bool
             forced = true;
 
         KCompressionDevice *device;
-        if (mimetype.isEmpty()) {
-            device = new KFilterDev(filename);
-        } else {
-            device = new KCompressionDevice(filename, COMPRESSIONTYPEFORMIMETYPE(mimetype));
-        }
+        device = new KCompressionDevice(filename, COMPRESSIONTYPEFORMIMETYPE(mimetype));
         if (device->compressionType() == KCompressionDevice::None && forced) {
             delete device;
         } else {
@@ -410,14 +406,14 @@ bool KIso::openArchive(QIODevice::OpenMode mode)
     /* We'll use the permission and user/group of the 'host' file except
      * in Rock Ridge, where the permissions are stored on the file system
      */
-    if (QT_STAT(m_filename.toLocal8Bit(), &buf) < 0) {
+    if (QT_STAT(m_filename.toLocal8Bit().data(), &buf) < 0) {
         /* defaults, if stat fails */
         memset(&buf, 0, sizeof(struct stat));
         buf.st_mode = 0777;
     } else {
         /* If it's a block device, try to query the track layout (for multisession) */
         if (m_startsec == -1 && S_ISBLK(buf.st_mode))
-            trackno = getTracks(m_filename.toLatin1(), (int *)&tracks);
+            trackno = getTracks(m_filename.toLatin1().data(), (int *)&tracks);
     }
     uid.setNum(buf.st_uid);
     gid.setNum(buf.st_gid);
diff --git a/plugins/iso/kisodirectory.cpp b/plugins/iso/kisodirectory.cpp
index 890234418..86c106438 100644
--- a/plugins/iso/kisodirectory.cpp
+++ b/plugins/iso/kisodirectory.cpp
@@ -16,7 +16,7 @@ KIsoDirectory::KIsoDirectory(KArchive *archive,
                              const QString &user,
                              const QString &group,
                              const QString &symlink)
-    : KArchiveDirectory(archive, name, access, QDateTime::fromTime_t(static_cast<uint>(date)), user, group, symlink)
+    : KArchiveDirectory(archive, name, access, QDateTime::fromSecsSinceEpoch(static_cast<uint>(date)), user, group, symlink)
 {
     m_adate = adate;
     m_cdate = cdate;
diff --git a/plugins/iso/kisofile.cpp b/plugins/iso/kisofile.cpp
index ec98a11d8..ccdc678bb 100644
--- a/plugins/iso/kisofile.cpp
+++ b/plugins/iso/kisofile.cpp
@@ -18,7 +18,7 @@ KIsoFile::KIsoFile(KArchive *archive,
                    const QString &symlink,
                    long long pos,
                    long long size)
-    : KArchiveFile(archive, name, access, QDateTime::fromTime_t(static_cast<uint>(date)), user, group, symlink, pos, size)
+    : KArchiveFile(archive, name, access, QDateTime::fromSecsSinceEpoch(static_cast<uint>(date)), user, group, symlink, pos, size)
 {
     m_adate = adate;
     m_cdate = cdate;
-- 
GitLab


From 52fdfe34cd11d79ee67772a633a1a784461fadcb Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 21:55:33 +0300
Subject: [PATCH 04/68] Update the krarc plugin

Mostly remove the pre 5.96 QT code check, no point in carrying it
arround
---
 plugins/krarc/krarc.cpp | 372 +---------------------------------------
 plugins/krarc/krarc.h   |  38 ----
 2 files changed, 3 insertions(+), 407 deletions(-)

diff --git a/plugins/krarc/krarc.cpp b/plugins/krarc/krarc.cpp
index 0a322ceca..50c7aeeb8 100644
--- a/plugins/krarc/krarc.cpp
+++ b/plugins/krarc/krarc.cpp
@@ -41,11 +41,7 @@
 class KIOPluginForMetaData : public QObject
 {
     Q_OBJECT
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     Q_PLUGIN_METADATA(IID "org.kde.kio.worker.krarc" FILE "krarc.json")
-#else
-    Q_PLUGIN_METADATA(IID "org.kde.kio.slave.krarc" FILE "krarc.json")
-#endif
 };
 
 using namespace KIO;
@@ -117,22 +113,11 @@ private:
 
 #endif // KRARC_ENABLED
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 class DummyWorker : public KIO::WorkerBase
-#else
-class DummySlave : public KIO::SlaveBase
-#endif
 {
 public:
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     DummyWorker(const QByteArray &pool_socket, const QByteArray &app_socket)
         : WorkerBase("kio_krarc", pool_socket, app_socket){
-#else
-    DummySlave(const QByteArray &pool_socket, const QByteArray &app_socket)
-        : SlaveBase("kio_krarc", pool_socket, app_socket)
-    {
-        error((int)ERR_SLAVE_DEFINED, QString("krarc is disabled."));
-#endif
 
         }
 };
@@ -150,26 +135,14 @@ int Q_DECL_EXPORT kdemain(int argc, char **argv)
     app.setApplicationName(QStringLiteral("kio_krarc"));
 
 #ifdef KRARC_ENABLED
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     kio_krarcProtocol worker(argv[2], argv[3]);
-#else
-    kio_krarcProtocol slave(argv[2], argv[3]);
-#endif
 
 #else
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     DummyWorker worker(argv[2], argv[3]);
-#else
-    DummySlave slave(argv[2], argv[3]);
-#endif
 
 #endif
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     worker.dispatchLoop();
-#else
-    slave.dispatchLoop();
-#endif
 
     return 0;
 }
@@ -178,20 +151,11 @@ int Q_DECL_EXPORT kdemain(int argc, char **argv)
 
 #ifdef KRARC_ENABLED
 kio_krarcProtocol::kio_krarcProtocol(const QByteArray &pool_socket, const QByteArray &app_socket)
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     : WorkerBase("kio_krarc", pool_socket, app_socket)
     , archiveChanged(true)
     , arcFile(nullptr)
     , extArcReady(false)
-    ,
-#else
-    : SlaveBase("kio_krarc", pool_socket, app_socket)
-    , archiveChanged(true)
-    , arcFile(nullptr)
-    , extArcReady(false)
-    ,
-#endif
-    password(QString())
+    , password(QString())
     , codec(nullptr)
 {
     KRFUNC;
@@ -226,32 +190,17 @@ kio_krarcProtocol::~kio_krarcProtocol()
 
 /* ---------------------------------------------------------------------------------- */
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::checkWriteSupport()
-#else
-bool kio_krarcProtocol::checkWriteSupport()
-#endif
 {
     KRFUNC;
     krConf.reparseConfiguration();
     if (KConfigGroup(&krConf, "kio_krarc").readEntry("EnableWrite", false))
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::pass();
 
     return WorkerResult::fail(ERR_UNSUPPORTED_ACTION,
                               i18n("krarc: write support is disabled.\n"
                                    "You can enable it on the 'Archives' page in Konfigurator."));
 }
-#else
-        return true;
-    else {
-        error(ERR_UNSUPPORTED_ACTION,
-              i18n("krarc: write support is disabled.\n"
-                   "You can enable it on the 'Archives' page in Konfigurator."));
-        return false;
-    }
-}
-#endif
 
 void kio_krarcProtocol::receivedData(KProcess *, QByteArray &d)
 {
@@ -262,29 +211,19 @@ void kio_krarcProtocol::receivedData(KProcess *, QByteArray &d)
     decompressedLen += d.length();
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::mkdir(const QUrl &url, int permissions)
-#else
-void kio_krarcProtocol::mkdir(const QUrl &url, int permissions)
-#endif
 {
     KRFUNC;
     const QString path = getPath(url);
     KRDEBUG(path);
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto writeSupportResult = checkWriteSupport();
     if (!writeSupportResult.success())
         return writeSupportResult;
-#else
-    if (!checkWriteSupport())
-        return;
-#endif
 
         // In case of KIO::mkpath call there is a mkdir call for every path element.
         // Therefore the path all the way up to our archive needs to be checked for existence
         // and reported as success.
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     if (QDir().exists(path)) {
         return WorkerResult::pass();
     }
@@ -301,27 +240,6 @@ void kio_krarcProtocol::mkdir(const QUrl &url, int permissions)
     if (putCmd.isEmpty()) {
         return WorkerResult::fail(ERR_UNSUPPORTED_ACTION, i18n("Creating folders is not supported with %1 archives", arcType));
     }
-#else
-    if (QDir().exists(path)) {
-        finished();
-        return;
-    }
-
-    if (!setArcFile(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, path);
-        return;
-    }
-
-    if (newArchiveURL && !initDirDict(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, path);
-        return;
-    }
-
-    if (putCmd.isEmpty()) {
-        error(ERR_UNSUPPORTED_ACTION, i18n("Creating folders is not supported with %1 archives", arcType));
-        return;
-    }
-#endif
 
     const QString arcFilePath = getPath(arcFile->url());
 
@@ -332,12 +250,7 @@ void kio_krarcProtocol::mkdir(const QUrl &url, int permissions)
 
         if (dirDict.find(arcDir) == dirDict.end())
             addNewDir(arcDir);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::pass();
-#else
-        finished();
-        return;
-#endif
     }
 
     QString arcDir = findArcDirectory(url);
@@ -374,45 +287,26 @@ void kio_krarcProtocol::mkdir(const QUrl &url, int permissions)
     QDir().rmdir(arcTempDir);
 
     if (proc.exitStatus() != QProcess::NormalExit || !checkStatus(proc.exitCode())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::fail(ERR_CANNOT_WRITE, path + "\n\n" + proc.getErrorMsg());
-#else
-        error(ERR_CANNOT_WRITE, path + "\n\n" + proc.getErrorMsg());
-        return;
-#endif
     }
 
     //  force a refresh of archive information
     initDirDict(url, true);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     return WorkerResult::pass();
-#else
-    finished();
-#endif
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::JobFlags flags)
-#else
-void kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::JobFlags flags)
-#endif
 {
     KRFUNC;
     KRDEBUG(getPath(url));
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto writeSupportResult = checkWriteSupport();
     if (!writeSupportResult.success())
         return writeSupportResult;
-#else
-    if (!checkWriteSupport())
-        return;
-#endif
 
     bool overwrite = !!(flags & KIO::Overwrite);
     bool resume = !!(flags & KIO::Resume);
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto setArcFileResult = setArcFile(url);
     if (!setArcFileResult.success()) {
         return setArcFileResult;
@@ -427,25 +321,6 @@ void kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::JobFlags flag
     if (!overwrite && findFileEntry(url)) {
         return WorkerResult::fail(ERR_FILE_ALREADY_EXIST, getPath(url));
     }
-#else
-    if (!setArcFile(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-    if (newArchiveURL && !initDirDict(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-
-    if (putCmd.isEmpty()) {
-        error(ERR_UNSUPPORTED_ACTION, i18n("Writing to %1 archives is not supported", arcType));
-        return;
-    }
-    if (!overwrite && findFileEntry(url)) {
-        error(ERR_FILE_ALREADY_EXIST, getPath(url));
-        return;
-    }
-#endif
 
     QString arcDir = findArcDirectory(url);
     if (arcDir.isEmpty())
@@ -501,12 +376,7 @@ void kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::JobFlags flag
     ::close(fd);
 
     if (isIncomplete) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::fail(ERR_CANNOT_WRITE, getPath(url));
-#else
-        error(ERR_CANNOT_WRITE, getPath(url));
-        return;
-#endif
     }
 
     // pack the file
@@ -525,46 +395,25 @@ void kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::JobFlags flag
     QDir().rmdir(arcTempDir);
 
     if (proc.exitStatus() != QProcess::NormalExit || !checkStatus(proc.exitCode())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::fail(ERR_CANNOT_WRITE, getPath(url) + "\n\n" + proc.getErrorMsg());
-#else
-        error(ERR_CANNOT_WRITE, getPath(url) + "\n\n" + proc.getErrorMsg());
-        return;
-#endif
     }
     //  force a refresh of archive information
     initDirDict(url, true);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     return WorkerResult::pass();
-#else
-    finished();
-#endif
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::get(const QUrl &url)
-#else
-void kio_krarcProtocol::get(const QUrl &url)
-#endif
 {
     KRFUNC;
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     return get(url, TRIES_WITH_PASSWORDS);
-#else
-    get(url, TRIES_WITH_PASSWORDS);
-#endif
 }
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
+
 KIO::WorkerResult kio_krarcProtocol::get(const QUrl &url, int tries)
-#else
-void kio_krarcProtocol::get(const QUrl &url, int tries)
-#endif
 {
     KRFUNC;
     KRDEBUG(getPath(url));
     bool decompressToFile = false;
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto setArcFileResult = setArcFile(url);
     if (!setArcFileResult.success()) {
         return setArcFileResult;
@@ -583,30 +432,6 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
     if (KFileItem(*entry, url).isDir()) {
         return WorkerResult::fail(KIO::ERR_IS_DIRECTORY, getPath(url));
     }
-#else
-    if (!setArcFile(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-    if (newArchiveURL && !initDirDict(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-
-    if (getCmd.isEmpty()) {
-        error(ERR_UNSUPPORTED_ACTION, i18n("Retrieving data from %1 archives is not supported", arcType));
-        return;
-    }
-    UDSEntry *entry = findFileEntry(url);
-    if (!entry) {
-        error(KIO::ERR_DOES_NOT_EXIST, getPath(url));
-        return;
-    }
-    if (KFileItem(*entry, url).isDir()) {
-        error(KIO::ERR_IS_DIRECTORY, getPath(url));
-        return;
-    }
-#endif
 
     KIO::filesize_t expectedSize = KFileItem(*entry, url).size();
     // for RPM files extract the cpio file first
@@ -619,12 +444,7 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
         cpio.waitForFinished();
 
         if (cpio.exitStatus() != QProcess::NormalExit || !checkStatus(cpio.exitCode())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
             return WorkerResult::fail(ERR_CANNOT_READ, getPath(url) + "\n\n" + cpio.getErrorMsg());
-#else
-            error(ERR_CANNOT_READ, getPath(url) + "\n\n" + cpio.getErrorMsg());
-            return;
-#endif
         }
         extArcReady = true;
     }
@@ -638,12 +458,7 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
         dpkg.waitForFinished();
 
         if (dpkg.exitStatus() != QProcess::NormalExit || !checkStatus(dpkg.exitCode())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
             return WorkerResult::fail(ERR_CANNOT_READ, getPath(url) + "\n\n" + dpkg.getErrorMsg());
-#else
-            error(ERR_CANNOT_READ, getPath(url) + "\n\n" + dpkg.getErrorMsg());
-            return;
-#endif
         }
         extArcReady = true;
     }
@@ -688,20 +503,11 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
 
     // Wait until the external unpacker has finished
     if (!proc.waitForFinished(-1)) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::fail(KIO::ERR_SLAVE_DEFINED,
                                   i18n("An error has happened, related to the external program '%1'. "
                                        "The error message is: '%2'.",
                                        cmd,
                                        proc.errorString()));
-#else
-        error(KIO::ERR_SLAVE_DEFINED,
-              i18n("An error has happened, related to the external program '%1'. "
-                   "The error message is: '%2'.",
-                   cmd,
-                   proc.errorString()));
-        return;
-#endif
     }
 
     if (!extArcReady && !decompressToFile) {
@@ -709,17 +515,9 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
             || (arcType != "bzip2" && arcType != "lzma" && arcType != "xz" && expectedSize != decompressedLen)) {
             if (encrypted && tries) {
                 invalidatePassword();
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 return get(url, tries - 1);
             }
             return WorkerResult::fail(KIO::ERR_ACCESS_DENIED, getPath(url) + "\n\n" + proc.getErrorMsg());
-#else
-                get(url, tries - 1);
-                return;
-            }
-            error(KIO::ERR_ACCESS_DENIED, getPath(url) + "\n\n" + proc.getErrorMsg());
-            return;
-#endif
         }
     } else {
         if (proc.exitStatus() != QProcess::NormalExit || !checkStatus(proc.exitCode()) || !QFileInfo::exists(arcTempDir + file)) {
@@ -727,17 +525,9 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
                 QFile(arcTempDir + file).remove();
             if (encrypted && tries) {
                 invalidatePassword();
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 return get(url, tries - 1);
             }
             return WorkerResult::fail(KIO::ERR_ACCESS_DENIED, getPath(url));
-#else
-                get(url, tries - 1);
-                return;
-            }
-            error(KIO::ERR_ACCESS_DENIED, getPath(url));
-            return;
-#endif
         }
         // the following block is ripped from KDE file KIO::Slave
         // $Id: krarc.cpp,v 1.43 2007/01/13 13:39:51 ckarai Exp $
@@ -745,7 +535,6 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
         QT_STATBUF buff;
         if (QT_LSTAT(_path.data(), &buff) == -1) {
             if (errno == EACCES)
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 return WorkerResult::fail(KIO::ERR_ACCESS_DENIED, getPath(url));
             return WorkerResult::fail(KIO::ERR_DOES_NOT_EXIST, getPath(url));
         }
@@ -759,26 +548,6 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
         if (fd < 0) {
             return WorkerResult::fail(KIO::ERR_CANNOT_OPEN_FOR_READING, getPath(url));
         }
-#else
-                error(KIO::ERR_ACCESS_DENIED, getPath(url));
-            else
-                error(KIO::ERR_DOES_NOT_EXIST, getPath(url));
-            return;
-        }
-        if (S_ISDIR(buff.st_mode)) {
-            error(KIO::ERR_IS_DIRECTORY, getPath(url));
-            return;
-        }
-        if (!S_ISREG(buff.st_mode)) {
-            error(KIO::ERR_CANNOT_OPEN_FOR_READING, getPath(url));
-            return;
-        }
-        int fd = QT_OPEN(_path.data(), O_RDONLY);
-        if (fd < 0) {
-            error(KIO::ERR_CANNOT_OPEN_FOR_READING, getPath(url));
-            return;
-        }
-#endif
         // Determine the mimetype of the file to be retrieved, and emit it.
         // This is mandatory in all slaves (for KRun/BrowserRun to work).
         QMimeDatabase db;
@@ -808,14 +577,8 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
             if (n == -1) {
                 if (errno == EINTR)
                     continue;
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 ::close(fd);
                 return WorkerResult::fail(KIO::ERR_CANNOT_READ, getPath(url));
-#else
-                error(KIO::ERR_CANNOT_READ, getPath(url));
-                ::close(fd);
-                return;
-#endif
             }
             if (n == 0)
                 break; // Finished
@@ -832,37 +595,20 @@ void kio_krarcProtocol::get(const QUrl &url, int tries)
         ::close(fd);
         processedSize(buff.st_size);
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         if (decompressToFile)
             QFile(arcTempDir + file).remove();
         return WorkerResult::pass();
-#else
-        finished();
-
-        if (decompressToFile)
-            QFile(arcTempDir + file).remove();
-        return;
-#endif
     }
     // send empty buffer to mark EOF
     data(QByteArray());
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     return WorkerResult::pass();
-#else
-    finished();
-#endif
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::del(QUrl const &url, bool isFile)
-#else
-void kio_krarcProtocol::del(QUrl const &url, bool isFile)
-#endif
 {
     KRFUNC;
     KRDEBUG(getPath(url));
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto writeSupportResult = checkWriteSupport();
     if (!writeSupportResult.success())
         return writeSupportResult;
@@ -883,30 +629,6 @@ void kio_krarcProtocol::del(QUrl const &url, bool isFile)
             return WorkerResult::fail(KIO::ERR_DOES_NOT_EXIST, getPath(url));
         }
     }
-#else
-    if (!checkWriteSupport())
-        return;
-
-    if (!setArcFile(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-    if (newArchiveURL && !initDirDict(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-
-    if (delCmd.isEmpty()) {
-        error(ERR_UNSUPPORTED_ACTION, i18n("Deleting files from %1 archives is not supported", arcType));
-        return;
-    }
-    if (!findFileEntry(url)) {
-        if ((arcType != "arj" && arcType != "lha") || isFile) {
-            error(KIO::ERR_DOES_NOT_EXIST, getPath(url));
-            return;
-        }
-    }
-#endif
 
     QString file = getPath(url).mid(getPath(arcFile->url()).length() + 1);
     if (!isFile && file.right(1) != DIR_SEPARATOR) {
@@ -923,31 +645,18 @@ void kio_krarcProtocol::del(QUrl const &url, bool isFile)
 
     proc.waitForFinished();
     if (proc.exitStatus() != QProcess::NormalExit || !checkStatus(proc.exitCode())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::fail(ERR_CANNOT_WRITE, getPath(url) + "\n\n" + proc.getErrorMsg());
-#else
-        error(ERR_CANNOT_WRITE, getPath(url) + "\n\n" + proc.getErrorMsg());
-        return;
-#endif
     }
     //  force a refresh of archive information
     initDirDict(url, true);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     return WorkerResult::pass();
-#else
-    finished();
-#endif
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::stat(const QUrl &url)
-#else
-void kio_krarcProtocol::stat(const QUrl &url)
-#endif
 {
     KRFUNC;
     KRDEBUG(getPath(url));
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
+
     const auto setArcFileResult = setArcFile(url);
     if (!setArcFileResult.success()) {
         return setArcFileResult;
@@ -959,21 +668,6 @@ void kio_krarcProtocol::stat(const QUrl &url)
     if (listCmd.isEmpty()) {
         return WorkerResult::fail(ERR_UNSUPPORTED_ACTION, i18n("Accessing files is not supported with %1 archives", arcType));
     }
-#else
-    if (!setArcFile(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-    if (newArchiveURL && !initDirDict(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-
-    if (listCmd.isEmpty()) {
-        error(ERR_UNSUPPORTED_ACTION, i18n("Accessing files is not supported with %1 archives", arcType));
-        return;
-    }
-#endif
 
     QString path = getPath(url, QUrl::StripTrailingSlash);
     QUrl newUrl = url;
@@ -993,43 +687,23 @@ void kio_krarcProtocol::stat(const QUrl &url)
         if (result.isValid())
             mime = result.name();
         statEntry(KFileItem(QUrl::fromLocalFile(path), mime, buff.st_mode).entry());
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::pass();
-#else
-        finished();
-        return;
-#endif
     }
     UDSEntry *entry = findFileEntry(newUrl);
     if (entry) {
         statEntry(*entry);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::pass();
     }
     return WorkerResult::fail(KIO::ERR_DOES_NOT_EXIST, path);
-#else
-        finished();
-    } else
-        error(KIO::ERR_DOES_NOT_EXIST, path);
-#endif
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::copy(const QUrl &url, const QUrl &dest, int, KIO::JobFlags flags)
-#else
-void kio_krarcProtocol::copy(const QUrl &url, const QUrl &dest, int, KIO::JobFlags flags)
-#endif
 {
     KRDEBUG("source: " << url.path() << " dest: " << dest.path());
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto writeSupportResult = checkWriteSupport();
     if (!writeSupportResult.success())
         return writeSupportResult;
-#else
-    if (!checkWriteSupport())
-        return;
-#endif
 
     bool overwrite = !!(flags & KIO::Overwrite);
 
@@ -1045,7 +719,6 @@ void kio_krarcProtocol::copy(const QUrl &url, const QUrl &dest, int, KIO::JobFla
 
             // the file exists and we don't want to overwrite
             if ((!overwrite) && (QFile(getPath(dest)).exists())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 return WorkerResult::fail((int)ERR_FILE_ALREADY_EXIST, QString(QFile::encodeName(getPath(dest))));
             };
 
@@ -1056,20 +729,6 @@ void kio_krarcProtocol::copy(const QUrl &url, const QUrl &dest, int, KIO::JobFla
             if (newArchiveURL && !initDirDict(url)) {
                 return WorkerResult::fail(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
             }
-#else
-                error((int)ERR_FILE_ALREADY_EXIST, QString(QFile::encodeName(getPath(dest))));
-                return;
-            };
-
-            if (!setArcFile(url)) {
-                error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-                return;
-            }
-            if (newArchiveURL && !initDirDict(url)) {
-                error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-                return;
-            }
-#endif
 
             UDSEntry *entry = findFileEntry(url);
             if (copyCmd.isEmpty() || !entry)
@@ -1102,32 +761,15 @@ void kio_krarcProtocol::copy(const QUrl &url, const QUrl &dest, int, KIO::JobFla
             proc.start();
             proc.waitForFinished();
             if (proc.exitStatus() != QProcess::NormalExit || !checkStatus(proc.exitCode())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 return WorkerResult::fail(KIO::ERR_CANNOT_WRITE, getPath(dest, QUrl::StripTrailingSlash) + "\n\n" + proc.getErrorMsg());
-#else
-                error(KIO::ERR_CANNOT_WRITE, getPath(dest, QUrl::StripTrailingSlash) + "\n\n" + proc.getErrorMsg());
-                return;
-#endif
             }
             if (!QFileInfo::exists(getPath(dest, QUrl::StripTrailingSlash))) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 return WorkerResult::fail(KIO::ERR_CANNOT_WRITE, getPath(dest, QUrl::StripTrailingSlash));
-#else
-                error(KIO::ERR_CANNOT_WRITE, getPath(dest, QUrl::StripTrailingSlash));
-                return;
-#endif
             }
 
             processedSize(KFileItem(*entry, url).size());
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
             QDir::setCurrent(QDir::rootPath()); /* for being able to umount devices after copying*/
             return WorkerResult::pass();
-#else
-            finished();
-            QDir::setCurrent(QDir::rootPath()); /* for being able to umount devices after copying*/
-            return;
-#endif
-
         } while (0);
 
     if (encrypted)
@@ -1136,18 +778,10 @@ void kio_krarcProtocol::copy(const QUrl &url, const QUrl &dest, int, KIO::JobFla
         KRDEBUG("ERROR: " << url.path() << " is not a local file.");
 
         // CMD_COPY is no more in KF5 - replaced with 74 value (as stated in https://invent.kde.org/frameworks/kio/-/blob/master/src/core/commands_p.h)
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     return WorkerResult::fail(ERR_UNSUPPORTED_ACTION, unsupportedActionErrorString("kio_krarc", 74));
-#else
-    error(ERR_UNSUPPORTED_ACTION, unsupportedActionErrorString(mProtocol, 74));
-#endif
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::rename(const QUrl &src, const QUrl &dest, KIO::JobFlags flags)
-#else
-void kio_krarcProtocol::rename(const QUrl &src, const QUrl &dest, KIO::JobFlags flags)
-#endif
 {
     Q_UNUSED(flags);
 
diff --git a/plugins/krarc/krarc.h b/plugins/krarc/krarc.h
index aa423cabb..fcd55f8fb 100644
--- a/plugins/krarc/krarc.h
+++ b/plugins/krarc/krarc.h
@@ -16,12 +16,7 @@
 #include <QUrl>
 
 #include <KIO/Global>
-#include <kservice_version.h>
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 #include <KIO/WorkerBase>
-#else
-#include <KIO/SlaveBase>
-#endif
 
 #include <KProcess>
 
@@ -33,17 +28,12 @@ class KFileItem;
 class QByteArray;
 class QTextCodec;
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 class kio_krarcProtocol : public QObject, public KIO::WorkerBase, public KrArcBaseManager
-#else
-class kio_krarcProtocol : public QObject, public KIO::SlaveBase, public KrArcBaseManager
-#endif
 {
     Q_OBJECT
 public:
     kio_krarcProtocol(const QByteArray &pool_socket, const QByteArray &app_socket);
     ~kio_krarcProtocol() override;
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     KIO::WorkerResult stat(const QUrl &url) override;
     KIO::WorkerResult get(const QUrl &url) override;
     KIO::WorkerResult put(const QUrl &url, int permissions, KIO::JobFlags flags) override;
@@ -52,36 +42,16 @@ public:
     KIO::WorkerResult del(QUrl const &url, bool isFile) override;
     KIO::WorkerResult copy(const QUrl &src, const QUrl &dest, int permissions, KIO::JobFlags flags) override;
     KIO::WorkerResult rename(const QUrl &src, const QUrl &dest, KIO::JobFlags flags) override;
-#else
-    void stat(const QUrl &url) override;
-    void get(const QUrl &url) override;
-    void put(const QUrl &url, int permissions, KIO::JobFlags flags) override;
-    void mkdir(const QUrl &url, int permissions) override;
-    void listDir(const QUrl &url) override;
-    void del(QUrl const &url, bool isFile) override;
-    void copy(const QUrl &src, const QUrl &dest, int permissions, KIO::JobFlags flags) override;
-    void rename(const QUrl &src, const QUrl &dest, KIO::JobFlags flags) override;
-#endif
 public slots:
     void receivedData(KProcess *, QByteArray &);
     void check7zOutputForPassword(KProcess *, QByteArray &);
 
 protected:
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     Q_REQUIRED_RESULT virtual bool initDirDict(const QUrl &url, bool forced = false);
     Q_REQUIRED_RESULT virtual KIO::WorkerResult initArcParameters();
-#else
-    virtual bool initDirDict(const QUrl &url, bool forced = false);
-    virtual bool initArcParameters();
-#endif
     void checkIf7zIsEncrypted(bool &, QString) override;
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     Q_REQUIRED_RESULT virtual KIO::WorkerResult setArcFile(const QUrl &url);
     Q_REQUIRED_RESULT virtual QString getPassword();
-#else
-    virtual bool setArcFile(const QUrl &url);
-    virtual QString getPassword();
-#endif
     virtual void invalidatePassword();
     QString getPath(const QUrl &url, QUrl::FormattingOptions options = nullptr);
     /** parses a text line from the listing of an archive. */
@@ -101,11 +71,7 @@ protected:
     QStringList renCmd; ///< rename file command.
 
 private:
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     KIO::WorkerResult get(const QUrl &url, int tries);
-#else
-    void get(const QUrl &url, int tries);
-#endif
     /** checks if a returned status ("exit code") of an archiving-related process is OK. */
     bool checkStatus(int exitCode);
     /** service function for parseLine. */
@@ -118,11 +84,7 @@ private:
     KIO::UDSEntry *findFileEntry(const QUrl &url);
     /** add a new directory (file list container). */
     KIO::UDSEntryList *addNewDir(const QString &path);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     Q_REQUIRED_RESULT KIO::WorkerResult checkWriteSupport();
-#else
-    bool checkWriteSupport();
-#endif
 
     QHash<QString, KIO::UDSEntryList *> dirDict; //< the directories data structure.
     bool encrypted; //< tells whether the archive is encrypted
-- 
GitLab


From 85a92cfc13f170fc68df13ec7692046814f4d556 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:01:52 +0300
Subject: [PATCH 05/68] Fix the kr7z encryption code

setupChildProcess() is not available anymore for KProcess, should use
setChildProcessModifier() instead
---
 app/Archive/kr7zencryptionchecker.cpp | 12 +++++-------
 app/Archive/kr7zencryptionchecker.h   |  3 ---
 2 files changed, 5 insertions(+), 10 deletions(-)

diff --git a/app/Archive/kr7zencryptionchecker.cpp b/app/Archive/kr7zencryptionchecker.cpp
index aaf0dcdbc..9ff4f3f1e 100644
--- a/app/Archive/kr7zencryptionchecker.cpp
+++ b/app/Archive/kr7zencryptionchecker.cpp
@@ -13,18 +13,16 @@ Kr7zEncryptionChecker::Kr7zEncryptionChecker()
     , lastData()
 {
     setOutputChannelMode(KProcess::SeparateChannels); // without this output redirection has no effect!
+    this->setChildProcessModifier([] {
+        // This function is called after the fork but for the exec. We create a process group
+        // to work around a broken wrapper script of 7z. Without this only the wrapper is killed.
+        setsid(); // make this process leader of a new process group
+    });
     connect(this, &Kr7zEncryptionChecker::readyReadStandardOutput, this, [=]() {
         receivedOutput();
     });
 }
 
-void Kr7zEncryptionChecker::setupChildProcess()
-{
-    // This function is called after the fork but for the exec. We create a process group
-    // to work around a broken wrapper script of 7z. Without this only the wrapper is killed.
-    setsid(); // make this process leader of a new process group
-}
-
 void Kr7zEncryptionChecker::receivedOutput()
 {
     // Reminder: If that function is modified, it's important to research if the
diff --git a/app/Archive/kr7zencryptionchecker.h b/app/Archive/kr7zencryptionchecker.h
index 43bb7d20c..4baf6ef49 100644
--- a/app/Archive/kr7zencryptionchecker.h
+++ b/app/Archive/kr7zencryptionchecker.h
@@ -24,9 +24,6 @@ class Kr7zEncryptionChecker : public KProcess
 public:
     Kr7zEncryptionChecker();
 
-protected:
-    void setupChildProcess() override;
-
 public slots:
     void receivedOutput();
     bool isEncrypted();
-- 
GitLab


From 480025f25ae123931ae9375e74ce73fd7b96d9c7 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:03:46 +0300
Subject: [PATCH 06/68] Change the screen geometry code to QScreen

TODO: Is primaryScreen OK here?

QApplication::desktop() -> QApplication::primaryScreen()
---
 app/DiskUsage/radialMap/segmentTip.cpp | 4 ++--
 app/defaults.h                         | 2 +-
 2 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/app/DiskUsage/radialMap/segmentTip.cpp b/app/DiskUsage/radialMap/segmentTip.cpp
index 766900b42..00e53982b 100644
--- a/app/DiskUsage/radialMap/segmentTip.cpp
+++ b/app/DiskUsage/radialMap/segmentTip.cpp
@@ -13,7 +13,7 @@
 #include <QPainter>
 // QtWidgets
 #include <QApplication> //installing eventFilters
-#include <QDesktopWidget>
+#include <QScreen>
 #include <QToolTip> //for its palette
 
 #include <KLocalizedString>
@@ -40,7 +40,7 @@ void SegmentTip::moveto(QPoint p, QWidget &canvas, bool placeAbove)
     p.rx() -= rect().center().x();
     p.ry() -= (placeAbove ? 8 + height() : m_cursorHeight - 8);
 
-    const QRect screen = QApplication::desktop()->screenGeometry(parentWidget());
+    const QRect screen = QApplication::primaryScreen()->geometry();
 
     const int x = p.x();
     const int y = p.y();
diff --git a/app/defaults.h b/app/defaults.h
index e92c74678..592080124 100644
--- a/app/defaults.h
+++ b/app/defaults.h
@@ -211,7 +211,7 @@
 
 /////////////////////// [Private]
 // Start Position /////
-#define _StartPosition QPoint(QApplication::desktop()->width() / 2 - MAIN_VIEW->sizeHint().width() / 2, QApplication::desktop()->height() / 2 - 250)
+#define _StartPosition QPoint(QApplication::primaryScreen()->geometry().width() / 2 - MAIN_VIEW->sizeHint().width() / 2, QApplication::primaryScreen()->geometry().height() / 2 - 250)
 // Start Size /////////
 #define _StartSize QSize(MAIN_VIEW->sizeHint().width(), 500)
 // Panel Size /////////
-- 
GitLab


From 051fb90190bb2932c87d7510f29c3c6708e1c0a8 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:05:26 +0300
Subject: [PATCH 07/68] Update the wallet calling code

QApplication::desktop() is not available anymore, use effectiveWinId
---
 app/Archive/krarchandler.cpp | 7 ++++---
 1 file changed, 4 insertions(+), 3 deletions(-)

diff --git a/app/Archive/krarchandler.cpp b/app/Archive/krarchandler.cpp
index 0612aff46..297b2717a 100644
--- a/app/Archive/krarchandler.cpp
+++ b/app/Archive/krarchandler.cpp
@@ -655,10 +655,11 @@ bool KrArcHandler::openWallet()
     if (!wallet) {
         // find a suitable parent window
         QWidget *actWindow = QApplication::activeWindow();
-        if (!actWindow)
-            actWindow = (QWidget *)QApplication::desktop();
+        WId w = 0;
+        if (actWindow)
+            w = actWindow->effectiveWinId();
+        wallet = KWallet::Wallet::openWallet(KWallet::Wallet::NetworkWallet(), w);
 
-        wallet = KWallet::Wallet::openWallet(KWallet::Wallet::NetworkWallet(), actWindow->effectiveWinId());
     }
     return (wallet != nullptr);
 }
-- 
GitLab


From 5dd4cf77e913b635ae88ef210c09ef374afa28d4 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:11:29 +0300
Subject: [PATCH 08/68] Change MidButton to MiddleButton

Item renamed in Qt6
---
 app/BookMan/krbookmarkhandler.cpp      | 2 +-
 app/KViewer/viewertabbar.cpp           | 2 +-
 app/Panel/PanelView/krmousehandler.cpp | 2 +-
 app/paneltabbar.cpp                    | 2 +-
 4 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/app/BookMan/krbookmarkhandler.cpp b/app/BookMan/krbookmarkhandler.cpp
index 76f6f4e0e..0b8944a86 100644
--- a/app/BookMan/krbookmarkhandler.cpp
+++ b/app/BookMan/krbookmarkhandler.cpp
@@ -729,7 +729,7 @@ bool KrBookmarkHandler::eventFilter(QObject *obj, QEvent *ev)
         case Qt::LeftButton:
             _middleClick = false;
             break;
-        case Qt::MidButton:
+        case Qt::MiddleButton:
             _middleClick = true;
             break;
         default:
diff --git a/app/KViewer/viewertabbar.cpp b/app/KViewer/viewertabbar.cpp
index 289baa925..eb8f9920e 100644
--- a/app/KViewer/viewertabbar.cpp
+++ b/app/KViewer/viewertabbar.cpp
@@ -49,7 +49,7 @@ void ViewerTabBar::mousePressEvent(QMouseEvent *e)
 
     setCurrentIndex(clickedTab);
 
-    if (e->button() == Qt::MidButton) {
+    if (e->button() == Qt::MiddleButton) {
         // close the current tab
         emit closeTabSignal(clickedTab);
     }
diff --git a/app/Panel/PanelView/krmousehandler.cpp b/app/Panel/PanelView/krmousehandler.cpp
index 753a23fe9..26db11ea4 100644
--- a/app/Panel/PanelView/krmousehandler.cpp
+++ b/app/Panel/PanelView/krmousehandler.cpp
@@ -237,7 +237,7 @@ bool KrMouseHandler::mouseReleaseEvent(QMouseEvent *e)
 
     CANCEL_TWO_CLICK_RENAME;
 
-    if (e->button() == Qt::MidButton && item != nullptr) {
+    if (e->button() == Qt::MiddleButton && item != nullptr) {
         e->accept();
         if (item == nullptr)
             return true;
diff --git a/app/paneltabbar.cpp b/app/paneltabbar.cpp
index 017becf69..143925df6 100644
--- a/app/paneltabbar.cpp
+++ b/app/paneltabbar.cpp
@@ -311,7 +311,7 @@ void PanelTabBar::mousePressEvent(QMouseEvent *e)
             else
                 return;
         }
-    } else if (e->button() == Qt::MidButton) {
+    } else if (e->button() == Qt::MiddleButton) {
         if (!isActiveTab)
             setCurrentIndex(clickedTabIndex);
 
-- 
GitLab


From 94d9f7af6efaf03b69332ee3433344b77a445faf Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:18:48 +0300
Subject: [PATCH 09/68] The addition operator has been deprecate for key
 sequences

Switch to the or operator

Described in part in https://doc.qt.io/qt-6/qkeysequence.html

Second try with | instead of +

Fix the DiskUsage key shortcuts to | rather than +
---
 app/DiskUsage/diskusage.cpp           | 22 +++++-----
 app/KViewer/krviewer.cpp              | 12 +++---
 app/Panel/PanelView/krviewfactory.cpp |  4 +-
 app/Panel/listpanelactions.cpp        | 62 +++++++++++++--------------
 app/kractions.cpp                     | 43 ++++++++++---------
 app/tabactions.cpp                    | 10 ++---
 6 files changed, 77 insertions(+), 76 deletions(-)

diff --git a/app/DiskUsage/diskusage.cpp b/app/DiskUsage/diskusage.cpp
index 1dde0a999..3465cd9c1 100644
--- a/app/DiskUsage/diskusage.cpp
+++ b/app/DiskUsage/diskusage.cpp
@@ -753,29 +753,29 @@ void DiskUsage::rightClickMenu(const QPoint &pos, File *fileItem, QMenu *addPopu
         actDelete->setShortcut(Qt::Key_Delete);
         QAction *actExclude = popup.addAction(i18n("Exclude"));
         actionHash[actExclude] = EXCLUDE_ID;
-        actExclude->setShortcut(Qt::CTRL + Qt::Key_E);
+        actExclude->setShortcut(Qt::CTRL | Qt::Key_E);
         popup.addSeparator();
     }
 
     QAction *myAct = popup.addAction(i18n("Up one folder"));
     actionHash[myAct] = PARENT_DIR_ID;
-    myAct->setShortcut(Qt::SHIFT + Qt::Key_Up);
+    myAct->setShortcut(Qt::SHIFT | Qt::Key_Up);
 
     myAct = popup.addAction(i18n("New search"));
     actionHash[myAct] = NEW_SEARCH_ID;
-    myAct->setShortcut(Qt::CTRL + Qt::Key_N);
+    myAct->setShortcut(Qt::CTRL | Qt::Key_N);
 
     myAct = popup.addAction(i18n("Refresh"));
     actionHash[myAct] = REFRESH_ID;
-    myAct->setShortcut(Qt::CTRL + Qt::Key_R);
+    myAct->setShortcut(Qt::CTRL | Qt::Key_R);
 
     myAct = popup.addAction(i18n("Include all"));
     actionHash[myAct] = INCLUDE_ALL_ID;
-    myAct->setShortcut(Qt::CTRL + Qt::Key_I);
+    myAct->setShortcut(Qt::CTRL | Qt::Key_I);
 
     myAct = popup.addAction(i18n("Step into"));
     actionHash[myAct] = STEP_INTO_ID;
-    myAct->setShortcut(Qt::SHIFT + Qt::Key_Down);
+    myAct->setShortcut(Qt::SHIFT | Qt::Key_Down);
 
     popup.addSeparator();
 
@@ -788,25 +788,25 @@ void DiskUsage::rightClickMenu(const QPoint &pos, File *fileItem, QMenu *addPopu
 
     myAct = viewPopup.addAction(i18n("Lines"));
     actionHash[myAct] = LINES_VIEW_ID;
-    myAct->setShortcut(Qt::CTRL + Qt::Key_L);
+    myAct->setShortcut(Qt::CTRL | Qt::Key_L);
 
     myAct = viewPopup.addAction(i18n("Detailed"));
     actionHash[myAct] = DETAILED_VIEW_ID;
-    myAct->setShortcut(Qt::CTRL + Qt::Key_D);
+    myAct->setShortcut(Qt::CTRL | Qt::Key_D);
 
     myAct = viewPopup.addAction(i18n("Filelight"));
     actionHash[myAct] = FILELIGHT_VIEW_ID;
-    myAct->setShortcut(Qt::CTRL + Qt::Key_F);
+    myAct->setShortcut(Qt::CTRL | Qt::Key_F);
 
     viewPopup.addSeparator();
 
     myAct = viewPopup.addAction(i18n("Next"));
     actionHash[myAct] = NEXT_VIEW_ID;
-    myAct->setShortcut(Qt::SHIFT + Qt::Key_Right);
+    myAct->setShortcut(Qt::SHIFT | Qt::Key_Right);
 
     myAct = viewPopup.addAction(i18n("Previous"));
     actionHash[myAct] = PREVIOUS_VIEW_ID;
-    myAct->setShortcut(Qt::SHIFT + Qt::Key_Left);
+    myAct->setShortcut(Qt::SHIFT | Qt::Key_Left);
 
     QAction *menu = popup.addMenu(&viewPopup);
     menu->setText(i18n("View"));
diff --git a/app/KViewer/krviewer.cpp b/app/KViewer/krviewer.cpp
index ae212b86a..8e08d96cb 100644
--- a/app/KViewer/krviewer.cpp
+++ b/app/KViewer/krviewer.cpp
@@ -92,13 +92,13 @@ KrViewer::KrViewer(QWidget *parent)
     ac->setDefaultShortcut(tempAction, shortcut);                                                                                                              \
     viewerMenu->addAction(tempAction);
 
-    addCustomMenuAction("genericViewer", i18n("&Generic Viewer"), SLOT(viewGeneric()), Qt::CTRL + Qt::SHIFT + Qt::Key_G);
-    addCustomMenuAction("textViewer", i18n("&Text Viewer"), SLOT(viewText()), Qt::CTRL + Qt::SHIFT + Qt::Key_T);
-    addCustomMenuAction("hexViewer", i18n("&Hex Viewer"), SLOT(viewHex()), Qt::CTRL + Qt::SHIFT + Qt::Key_H);
-    addCustomMenuAction("lister", i18n("&Lister"), SLOT(viewLister()), Qt::CTRL + Qt::SHIFT + Qt::Key_L);
+    addCustomMenuAction("genericViewer", i18n("&Generic Viewer"), SLOT(viewGeneric()), Qt::CTRL | Qt::SHIFT | Qt::Key_G);
+    addCustomMenuAction("textViewer", i18n("&Text Viewer"), SLOT(viewText()), Qt::CTRL | Qt::SHIFT | Qt::Key_T);
+    addCustomMenuAction("hexViewer", i18n("&Hex Viewer"), SLOT(viewHex()), Qt::CTRL | Qt::SHIFT | Qt::Key_H);
+    addCustomMenuAction("lister", i18n("&Lister"), SLOT(viewLister()), Qt::CTRL | Qt::SHIFT | Qt::Key_L);
     viewerMenu->addSeparator();
 
-    addCustomMenuAction("textEditor", i18n("Text &Editor"), SLOT(editText()), Qt::CTRL + Qt::SHIFT + Qt::Key_E);
+    addCustomMenuAction("textEditor", i18n("Text &Editor"), SLOT(editText()), Qt::CTRL | Qt::SHIFT | Qt::Key_E);
     viewerMenu->addSeparator();
 
     const QList<QAction *> actList = menuBar()->actions();
@@ -148,7 +148,7 @@ KrViewer::KrViewer(QWidget *parent)
     tabPrevAction = ac->addAction("prevTab", this, SLOT(prevTab()));
     tabPrevAction->setText(i18n("&Previous Tab"));
     shortcuts = KStandardShortcut::tabPrev();
-    shortcuts.append(Qt::CTRL + Qt::SHIFT + Qt::Key_Tab); // reenforce QTabWidget shortcut
+    shortcuts.append(Qt::CTRL | Qt::SHIFT | Qt::Key_Tab); // reenforce QTabWidget shortcut
     ac->setDefaultShortcuts(tabPrevAction, shortcuts);
 
     tabWidget.setTabsClosable(true);
diff --git a/app/Panel/PanelView/krviewfactory.cpp b/app/Panel/PanelView/krviewfactory.cpp
index 1380e7fac..5af2eec98 100644
--- a/app/Panel/PanelView/krviewfactory.cpp
+++ b/app/Panel/PanelView/krviewfactory.cpp
@@ -59,9 +59,9 @@ KrViewFactory &KrViewFactory::self()
 void KrViewFactory::init()
 {
     registerView(
-        new KrViewInstanceImpl<KrInterDetailedView>(0, "KrInterDetailedView", i18n("&Detailed View"), "view-list-details", Qt::ALT + Qt::SHIFT + Qt::Key_D));
+        new KrViewInstanceImpl<KrInterDetailedView>(0, "KrInterDetailedView", i18n("&Detailed View"), "view-list-details", Qt::ALT | Qt::SHIFT | Qt::Key_D));
 
-    registerView(new KrViewInstanceImpl<KrInterBriefView>(1, "KrInterBriefView", i18n("&Brief View"), "view-list-icons", Qt::ALT + Qt::SHIFT + Qt::Key_B));
+    registerView(new KrViewInstanceImpl<KrInterBriefView>(1, "KrInterBriefView", i18n("&Brief View"), "view-list-icons", Qt::ALT | Qt::SHIFT | Qt::Key_B));
 }
 
 KrView *KrViewFactory::createView(int id, QWidget *widget, KConfig *cfg)
diff --git a/app/Panel/listpanelactions.cpp b/app/Panel/listpanelactions.cpp
index 1a9fb66d2..4c953b633 100644
--- a/app/Panel/listpanelactions.cpp
+++ b/app/Panel/listpanelactions.cpp
@@ -64,58 +64,58 @@ ListPanelActions::ListPanelActions(QObject *parent, KrMainWindow *mainWindow)
     actRenameF2 = action(i18n("Rename"), "edit-rename", Qt::Key_F2, _func, SLOT(rename()), "F2_Rename");
     actViewFileF3 = action(i18n("View File"), nullptr, Qt::Key_F3, _func, SLOT(view()), "F3_View");
     actEditFileF4 = action(i18n("Edit File"), nullptr, Qt::Key_F4, _func, SLOT(editFile()), "F4_Edit");
-    actNewFileShiftF4 = action(i18n("&New Text File..."), "document-new", Qt::SHIFT + Qt::Key_F4, _func, SLOT(askEditFile()), "edit_new_file");
+    actNewFileShiftF4 = action(i18n("&New Text File..."), "document-new", Qt::SHIFT | Qt::Key_F4, _func, SLOT(askEditFile()), "edit_new_file");
     actCopyF5 = action(i18n("Copy to other panel"), nullptr, Qt::Key_F5, _func, SLOT(copyFiles()), "F5_Copy");
     actMoveF6 = action(i18n("Move to other panel"), nullptr, Qt::Key_F6, _func, SLOT(moveFiles()), "F6_Move");
-    actCopyDelayedF5 = action(i18n("Copy delayed..."), nullptr, Qt::SHIFT + Qt::Key_F5, _func, SLOT(copyFilesDelayed()), "F5_Copy_Queue");
-    actMoveDelayedShiftF6 = action(i18n("Move delayed..."), nullptr, Qt::SHIFT + Qt::Key_F6, _func, SLOT(moveFilesDelayed()), "F6_Move_Queue");
+    actCopyDelayedF5 = action(i18n("Copy delayed..."), nullptr, Qt::SHIFT | Qt::Key_F5, _func, SLOT(copyFilesDelayed()), "F5_Copy_Queue");
+    actMoveDelayedShiftF6 = action(i18n("Move delayed..."), nullptr, Qt::SHIFT | Qt::Key_F6, _func, SLOT(moveFilesDelayed()), "F6_Move_Queue");
     actNewFolderF7 = action(i18n("New Folder..."), "folder-new", Qt::Key_F7, _func, SLOT(mkdir()), "F7_Mkdir");
     actDeleteF8 = action(i18n("Delete"), "edit-delete", Qt::Key_F8, _func, SLOT(defaultDeleteFiles()), "F8_Delete");
     actTerminalF9 = action(i18n("Start Terminal Here"), "utilities-terminal", Qt::Key_F9, _func, SLOT(terminal()), "F9_Terminal");
-    action(i18n("F3 View Dialog"), nullptr, Qt::SHIFT + Qt::Key_F3, _func, SLOT(viewDlg()), "F3_ViewDlg");
+    action(i18n("F3 View Dialog"), nullptr, Qt::SHIFT | Qt::Key_F3, _func, SLOT(viewDlg()), "F3_ViewDlg");
 
     // file operations
     action(i18n("Right-click Menu"), nullptr, Qt::Key_Menu, _gui, SLOT(rightclickMenu()), "rightclick menu");
-    actProperties = action(i18n("&Properties..."), "document-properties", Qt::ALT + Qt::Key_Return, _func, SLOT(properties()), "properties");
-    actCompDirs = action(i18n("&Compare Folders"), "kr_comparedirs", Qt::ALT + Qt::SHIFT + Qt::Key_C, _gui, SLOT(compareDirs()), "compare dirs");
+    actProperties = action(i18n("&Properties..."), "document-properties", Qt::ALT | Qt::Key_Return, _func, SLOT(properties()), "properties");
+    actCompDirs = action(i18n("&Compare Folders"), "kr_comparedirs", Qt::ALT | Qt::SHIFT | Qt::Key_C, _gui, SLOT(compareDirs()), "compare dirs");
     actCalculate = action(i18n("Calculate &Occupied Space"), "accessories-calculator", 0, _func, SLOT(calcSpace()), "calculate");
-    actPack = action(i18n("Pac&k..."), "archive-insert", Qt::ALT + Qt::SHIFT + Qt::Key_P, _func, SLOT(pack()), "pack");
-    actUnpack = action(i18n("&Unpack..."), "archive-extract", Qt::ALT + Qt::SHIFT + Qt::Key_U, _func, SLOT(unpack()), "unpack");
+    actPack = action(i18n("Pac&k..."), "archive-insert", Qt::ALT | Qt::SHIFT | Qt::Key_P, _func, SLOT(pack()), "pack");
+    actUnpack = action(i18n("&Unpack..."), "archive-extract", Qt::ALT | Qt::SHIFT | Qt::Key_U, _func, SLOT(unpack()), "unpack");
     actCreateChecksum = action(i18n("Create Checksum..."), "document-edit-sign", 0, _func, SLOT(createChecksum()), "create checksum");
     actMatchChecksum = action(i18n("Verify Checksum..."), "document-edit-decrypt-verify", 0, _func, SLOT(matchChecksum()), "match checksum");
-    action(i18n("New Symlink..."), nullptr, Qt::CTRL + Qt::ALT + Qt::Key_S, _func, SLOT(krlink()), "new symlink");
-    actTest = action(i18n("T&est Archive"), "archive-extract", Qt::ALT + Qt::SHIFT + Qt::Key_E, _func, SLOT(testArchive()), "test archives");
+    action(i18n("New Symlink..."), nullptr, Qt::CTRL | Qt::ALT | Qt::Key_S, _func, SLOT(krlink()), "new symlink");
+    actTest = action(i18n("T&est Archive"), "archive-extract", Qt::ALT | Qt::SHIFT | Qt::Key_E, _func, SLOT(testArchive()), "test archives");
     action(i18n("Alternative Delete"), "edit-delete", Qt::Key_Delete + Qt::CTRL, _func, SLOT(alternativeDeleteFiles()), "alternative delete");
 
     // navigation
-    actRoot = action(i18n("Root"), "folder-red", Qt::CTRL + Qt::Key_Backspace, _func, SLOT(root()), "root");
-    actCdToOther = action(i18n("Go to Other Panel's Folder"), nullptr, Qt::CTRL + Qt::Key_Equal, _func, SLOT(cdToOtherPanel()), "cd to other panel");
-    action(i18n("&Reload"), "view-refresh", Qt::CTRL + Qt::Key_R, _func, SLOT(refresh()), "std_redisplay");
+    actRoot = action(i18n("Root"), "folder-red", Qt::CTRL | Qt::Key_Backspace, _func, SLOT(root()), "root");
+    actCdToOther = action(i18n("Go to Other Panel's Folder"), nullptr, Qt::CTRL | Qt::Key_Equal, _func, SLOT(cdToOtherPanel()), "cd to other panel");
+    action(i18n("&Reload"), "view-refresh", Qt::CTRL | Qt::Key_R, _func, SLOT(refresh()), "std_redisplay");
     actCancelRefresh = action(i18n("Cancel Refresh of View"), "dialog-cancel", 0, _gui, SLOT(cancelProgress()), "cancel refresh");
-    actFTPNewConnect = action(i18n("New Net &Connection..."), "network-connect", Qt::CTRL + Qt::Key_N, _func, SLOT(newFTPconnection()), "ftp new connection");
+    actFTPNewConnect = action(i18n("New Net &Connection..."), "network-connect", Qt::CTRL | Qt::Key_N, _func, SLOT(newFTPconnection()), "ftp new connection");
     actFTPDisconnect =
-        action(i18n("Disconnect &from Net"), "network-disconnect", Qt::SHIFT + Qt::CTRL + Qt::Key_D, _func, SLOT(FTPDisconnect()), "ftp disconnect");
-    action(i18n("Sync Panels"), nullptr, Qt::ALT + Qt::SHIFT + Qt::Key_O, _func, SLOT(syncOtherPanel()), "sync panels");
-    actJumpBack = action(i18n("Jump Back"), "go-jump", Qt::CTRL + Qt::Key_J, _gui, SLOT(jumpBack()), "jump_back");
-    actSetJumpBack = action(i18n("Set Jump Back Point"), "go-jump-definition", Qt::CTRL + Qt::SHIFT + Qt::Key_J, _gui, SLOT(setJumpBack()), "set_jump_back");
+        action(i18n("Disconnect &from Net"), "network-disconnect", Qt::SHIFT | Qt::CTRL | Qt::Key_D, _func, SLOT(FTPDisconnect()), "ftp disconnect");
+    action(i18n("Sync Panels"), nullptr, Qt::ALT | Qt::SHIFT | Qt::Key_O, _func, SLOT(syncOtherPanel()), "sync panels");
+    actJumpBack = action(i18n("Jump Back"), "go-jump", Qt::CTRL | Qt::Key_J, _gui, SLOT(jumpBack()), "jump_back");
+    actSetJumpBack = action(i18n("Set Jump Back Point"), "go-jump-definition", Qt::CTRL | Qt::SHIFT | Qt::Key_J, _gui, SLOT(setJumpBack()), "set_jump_back");
     actSyncBrowse =
-        action(i18n("S&ynchron Folder Changes"), "kr_syncbrowse_off", Qt::ALT + Qt::SHIFT + Qt::Key_Y, _gui, SLOT(toggleSyncBrowse()), "sync browse");
-    actLocationBar = action(i18n("Go to Location Bar"), nullptr, Qt::CTRL + Qt::Key_L, _gui, SLOT(editLocation()), "location_bar");
-    toggleAction(i18n("Toggle Sidebar"), nullptr, Qt::ALT + Qt::Key_Down, _gui, SLOT(toggleSidebar()), "toggle sidebar");
-    action(i18n("Bookmarks"), nullptr, Qt::CTRL + Qt::Key_D, _gui, SLOT(openBookmarks()), "bookmarks");
+        action(i18n("S&ynchron Folder Changes"), "kr_syncbrowse_off", Qt::ALT | Qt::SHIFT | Qt::Key_Y, _gui, SLOT(toggleSyncBrowse()), "sync browse");
+    actLocationBar = action(i18n("Go to Location Bar"), nullptr, Qt::CTRL | Qt::Key_L, _gui, SLOT(editLocation()), "location_bar");
+    toggleAction(i18n("Toggle Sidebar"), nullptr, Qt::ALT | Qt::Key_Down, _gui, SLOT(toggleSidebar()), "toggle sidebar");
+    action(i18n("Bookmarks"), nullptr, Qt::CTRL | Qt::Key_D, _gui, SLOT(openBookmarks()), "bookmarks");
     action(i18n("Left Bookmarks"), nullptr, 0, this, SLOT(openLeftBookmarks()), "left bookmarks");
     action(i18n("Right Bookmarks"), nullptr, 0, this, SLOT(openRightBookmarks()), "right bookmarks");
-    action(i18n("History"), nullptr, Qt::CTRL + Qt::Key_H, _gui, SLOT(openHistory()), "history");
-    action(i18n("Left History"), nullptr, Qt::ALT + Qt::CTRL + Qt::Key_Left, this, SLOT(openLeftHistory()), "left history");
-    action(i18n("Right History"), nullptr, Qt::ALT + Qt::CTRL + Qt::Key_Right, this, SLOT(openRightHistory()), "right history");
-    action(i18n("Media"), nullptr, Qt::CTRL + Qt::Key_M, _gui, SLOT(openMedia()), "media");
-    action(i18n("Left Media"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_Left, this, SLOT(openLeftMedia()), "left media");
-    action(i18n("Right Media"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_Right, this, SLOT(openRightMedia()), "right media");
+    action(i18n("History"), nullptr, Qt::CTRL | Qt::Key_H, _gui, SLOT(openHistory()), "history");
+    action(i18n("Left History"), nullptr, Qt::ALT | Qt::CTRL | Qt::Key_Left, this, SLOT(openLeftHistory()), "left history");
+    action(i18n("Right History"), nullptr, Qt::ALT | Qt::CTRL | Qt::Key_Right, this, SLOT(openRightHistory()), "right history");
+    action(i18n("Media"), nullptr, Qt::CTRL | Qt::Key_M, _gui, SLOT(openMedia()), "media");
+    action(i18n("Left Media"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_Left, this, SLOT(openLeftMedia()), "left media");
+    action(i18n("Right Media"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_Right, this, SLOT(openRightMedia()), "right media");
 
     // quick search bar
-    action(i18n("Find in folder..."), nullptr, Qt::CTRL + Qt::Key_F, _gui, SLOT(showSearchBar()), "search bar");
-    action(i18n("Select in folder..."), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_S, _gui, SLOT(showSearchBarSelection()), "search bar selection");
-    action(i18n("Filter in folder..."), nullptr, Qt::CTRL + Qt::Key_I, _gui, SLOT(showSearchBarFilter()), "search bar filter");
+    action(i18n("Find in folder..."), nullptr, Qt::CTRL | Qt::Key_F, _gui, SLOT(showSearchBar()), "search bar");
+    action(i18n("Select in folder..."), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_S, _gui, SLOT(showSearchBarSelection()), "search bar selection");
+    action(i18n("Filter in folder..."), nullptr, Qt::CTRL | Qt::Key_I, _gui, SLOT(showSearchBarFilter()), "search bar filter");
 
     // and at last we can set the tool-tips
     actRoot->setToolTip(i18n("ROOT (/)"));
diff --git a/app/kractions.cpp b/app/kractions.cpp
index 70e4eece2..eeba0c74f 100644
--- a/app/kractions.cpp
+++ b/app/kractions.cpp
@@ -10,6 +10,7 @@
 
 // QtWidgets
 #include <QAction>
+#include <QActionGroup>
 #include <QMenu>
 
 #include <KActionCollection>
@@ -195,7 +196,7 @@ void KrActions::setupActions(Krusader *krusaderApp)
     NEW_KTOGGLEACTION(actToggleTerminal,
                       i18n("Show &Embedded Terminal"),
                       nullptr,
-                      Qt::CTRL + Qt::ALT + Qt::Key_E,
+                      Qt::CTRL | Qt::ALT | Qt::Key_E,
                       SLOTS,
                       SLOT(toggleTerminal()),
                       "toggle terminal emulator");
@@ -203,26 +204,26 @@ void KrActions::setupActions(Krusader *krusaderApp)
     NEW_KTOGGLEACTION(actToggleHidden,
                       i18n("Show &Hidden Files"),
                       nullptr,
-                      Qt::ALT + Qt::Key_Period,
+                      Qt::ALT | Qt::Key_Period,
                       SLOTS,
                       SLOT(showHiddenFiles(bool)),
                       "toggle hidden files");
 
-    NEW_KACTION(actSwapPanels, i18n("S&wap Panels"), nullptr, Qt::CTRL + Qt::Key_U, SLOTS, SLOT(swapPanels()), "swap panels");
+    NEW_KACTION(actSwapPanels, i18n("S&wap Panels"), nullptr, Qt::CTRL | Qt::Key_U, SLOTS, SLOT(swapPanels()), "swap panels");
 
     NEW_KACTION(actEmptyTrash, i18n("Empty Trash"), "trash-empty", 0, SLOTS, SLOT(emptyTrash()), "emptytrash");
 
     NEW_KACTION(actTrashBin, i18n("Trash Popup Menu"), KrTrashHandler::trashIconName(), 0, SLOTS, SLOT(trashPopupMenu()), "trashbin");
 
-    NEW_KACTION(actSwapSides, i18n("Sw&ap Sides"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_U, SLOTS, SLOT(toggleSwapSides()), "toggle swap sides");
+    NEW_KACTION(actSwapSides, i18n("Sw&ap Sides"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_U, SLOTS, SLOT(toggleSwapSides()), "toggle swap sides");
     actToggleHidden->setChecked(KConfigGroup(krConfig, "Look&Feel").readEntry("Show Hidden", _ShowHidden));
 
     // and then the DONE actions
-    NEW_KACTION(actCmdlinePopup, i18n("popup cmdline"), nullptr, Qt::CTRL + Qt::Key_Slash, SLOTS, SLOT(cmdlinePopup()), "cmdline popup");
+    NEW_KACTION(actCmdlinePopup, i18n("popup cmdline"), nullptr, Qt::CTRL | Qt::Key_Slash, SLOTS, SLOT(cmdlinePopup()), "cmdline popup");
 
-    NEW_KACTION(tmp, i18n("Start &Root Mode Krusader"), "krusader_root", Qt::ALT + Qt::SHIFT + Qt::Key_K, SLOTS, SLOT(rootKrusader()), "root krusader");
-    NEW_KACTION(actProfiles, i18n("Pro&files"), "user-identity", Qt::ALT + Qt::SHIFT + Qt::Key_L, MAIN_VIEW, SLOT(profiles()), "profile");
-    NEW_KACTION(actSplit, i18n("Sp&lit File..."), "split", Qt::CTRL + Qt::Key_P, SLOTS, SLOT(slotSplit()), "split");
+    NEW_KACTION(tmp, i18n("Start &Root Mode Krusader"), "krusader_root", Qt::ALT | Qt::SHIFT | Qt::Key_K, SLOTS, SLOT(rootKrusader()), "root krusader");
+    NEW_KACTION(actProfiles, i18n("Pro&files"), "user-identity", Qt::ALT | Qt::SHIFT | Qt::Key_L, MAIN_VIEW, SLOT(profiles()), "profile");
+    NEW_KACTION(actSplit, i18n("Sp&lit File..."), "split", Qt::CTRL | Qt::Key_P, SLOTS, SLOT(slotSplit()), "split");
     NEW_KACTION(actCombine, i18n("Com&bine Files..."), "kr_combine", 0, SLOTS, SLOT(slotCombine()), "combine");
     NEW_KACTION(actSelectNewerAndSingle, i18n("&Select Newer and Single"), nullptr, 0, SLOTS, SLOT(compareSetup()), "select_newer_and_single");
     NEW_KACTION(actSelectNewer, i18n("Select &Newer"), nullptr, 0, SLOTS, SLOT(compareSetup()), "select_newer");
@@ -273,14 +274,14 @@ void KrActions::setupActions(Krusader *krusaderApp)
 
     actMountMan = krMtMan.action();
     krusaderApp->actionCollection()->addAction("mountman", actMountMan);
-    krusaderApp->actionCollection()->setDefaultShortcut(actMountMan, Qt::ALT + Qt::Key_Slash);
+    krusaderApp->actionCollection()->setDefaultShortcut(actMountMan, Qt::ALT | Qt::Key_Slash);
 
-    NEW_KACTION(actFind, i18n("&Search..."), "system-search", Qt::CTRL + Qt::Key_S, SLOTS, SLOT(search()), "find");
-    NEW_KACTION(actLocate, i18n("&Locate..."), "edit-find", Qt::SHIFT + Qt::CTRL + Qt::Key_L, SLOTS, SLOT(locate()), "locate");
+    NEW_KACTION(actFind, i18n("&Search..."), "system-search", Qt::CTRL | Qt::Key_S, SLOTS, SLOT(search()), "find");
+    NEW_KACTION(actLocate, i18n("&Locate..."), "edit-find", Qt::SHIFT | Qt::CTRL | Qt::Key_L, SLOTS, SLOT(locate()), "locate");
 #ifdef SYNCHRONIZER_ENABLED
-    NEW_KACTION(actSyncDirs, i18n("Synchronize Fol&ders..."), "folder-sync", Qt::CTRL + Qt::Key_Y, SLOTS, SLOT(slotSynchronizeDirs()), "sync dirs");
+    NEW_KACTION(actSyncDirs, i18n("Synchronize Fol&ders..."), "folder-sync", Qt::CTRL | Qt::Key_Y, SLOTS, SLOT(slotSynchronizeDirs()), "sync dirs");
 #endif
-    NEW_KACTION(actDiskUsage, i18n("D&isk Usage..."), "kr_diskusage", Qt::ALT + Qt::SHIFT + Qt::Key_S, SLOTS, SLOT(slotDiskUsage()), "disk usage");
+    NEW_KACTION(actDiskUsage, i18n("D&isk Usage..."), "kr_diskusage", Qt::ALT | Qt::SHIFT | Qt::Key_S, SLOTS, SLOT(slotDiskUsage()), "disk usage");
     NEW_KACTION(actKonfigurator,
                 i18n("Configure &Krusader..."),
                 "configure",
@@ -290,13 +291,13 @@ void KrActions::setupActions(Krusader *krusaderApp)
                 "konfigurator");
     NEW_KACTION(actSavePosition, i18n("Save &Position"), nullptr, 0, krusaderApp, SLOT(savePosition()), "save position");
     NEW_KACTION(actCompare, i18n("Compare b&y Content..."), "kr_comparedirs", 0, SLOTS, SLOT(compareContent()), "compare");
-    NEW_KACTION(actMultiRename, i18n("Multi &Rename..."), "edit-rename", Qt::SHIFT + Qt::Key_F2, SLOTS, SLOT(multiRename()), "multirename");
+    NEW_KACTION(actMultiRename, i18n("Multi &Rename..."), "edit-rename", Qt::SHIFT | Qt::Key_F2, SLOTS, SLOT(multiRename()), "multirename");
 
     NEW_KACTION(actAddBookmark, i18n("Add Bookmark"), "bookmark-new", KStandardShortcut::addBookmark(), SLOTS, SLOT(addBookmark()), "add bookmark");
     NEW_KACTION(actVerticalMode,
                 i18n("Vertical Mode"),
                 "view-split-top-bottom",
-                Qt::ALT + Qt::CTRL + Qt::Key_R,
+                Qt::ALT | Qt::CTRL | Qt::Key_R,
                 MAIN_VIEW,
                 SLOT(toggleVerticalMode()),
                 "toggle vertical mode");
@@ -312,29 +313,29 @@ void KrActions::setupActions(Krusader *krusaderApp)
     NEW_KACTION(actF10Quit, i18n("Quit"), nullptr, Qt::Key_F10, krusaderApp, SLOT(quit()), "F10_Quit");
     actF10Quit->setToolTip(i18n("Quit Krusader."));
 
-    NEW_KACTION(actPopularUrls, i18n("Popular URLs..."), nullptr, Qt::CTRL + Qt::Key_Z, krusaderApp->popularUrls(), SLOT(showDialog()), "Popular_Urls");
+    NEW_KACTION(actPopularUrls, i18n("Popular URLs..."), nullptr, Qt::CTRL | Qt::Key_Z, krusaderApp->popularUrls(), SLOT(showDialog()), "Popular_Urls");
     NEW_KACTION(actSwitchFullScreenTE,
                 i18n("Toggle Fullscreen Embedded Terminal"),
                 nullptr,
-                Qt::CTRL + Qt::ALT + Qt::Key_F,
+                Qt::CTRL | Qt::ALT | Qt::Key_F,
                 MAIN_VIEW,
                 SLOT(toggleFullScreenTerminalEmulator()),
                 "switch_fullscreen_te");
 
-    NEW_KACTION(tmp, i18n("Move Focus Up"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_Up, MAIN_VIEW, SLOT(focusUp()), "move_focus_up");
-    NEW_KACTION(tmp, i18n("Move Focus Down"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_Down, MAIN_VIEW, SLOT(focusDown()), "move_focus_down");
+    NEW_KACTION(tmp, i18n("Move Focus Up"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_Up, MAIN_VIEW, SLOT(focusUp()), "move_focus_up");
+    NEW_KACTION(tmp, i18n("Move Focus Down"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_Down, MAIN_VIEW, SLOT(focusDown()), "move_focus_down");
 
     // job manager actions
     actJobControl = krJobMan->controlAction();
     krusaderApp->actionCollection()->addAction("job control", actJobControl);
-    krusaderApp->actionCollection()->setDefaultShortcut(actJobControl, Qt::CTRL + Qt::ALT + Qt::Key_P);
+    krusaderApp->actionCollection()->setDefaultShortcut(actJobControl, Qt::CTRL | Qt::ALT | Qt::Key_P);
     actJobProgress = krJobMan->progressAction();
     krusaderApp->actionCollection()->addAction("job progress", actJobProgress);
     actJobMode = krJobMan->modeAction();
     krusaderApp->actionCollection()->addAction("job mode", actJobMode);
     actJobUndo = krJobMan->undoAction();
     krusaderApp->actionCollection()->addAction("job undo", actJobUndo);
-    krusaderApp->actionCollection()->setDefaultShortcut(actJobUndo, Qt::CTRL + Qt::ALT + Qt::Key_Z);
+    krusaderApp->actionCollection()->setDefaultShortcut(actJobUndo, Qt::CTRL | Qt::ALT | Qt::Key_Z);
 
     // and at last we can set the tool-tips
     actKonfigurator->setToolTip(i18n("Setup Krusader the way you like it"));
diff --git a/app/tabactions.cpp b/app/tabactions.cpp
index fb62a6b19..b7630a301 100644
--- a/app/tabactions.cpp
+++ b/app/tabactions.cpp
@@ -21,16 +21,16 @@
 TabActions::TabActions(QObject *parent, KrMainWindow *mainWindow)
     : ActionsBase(parent, mainWindow)
 {
-    actNewTab = action(i18n("New Tab"), "tab-new", Qt::ALT + Qt::CTRL + Qt::SHIFT + Qt::Key_N, SLOT(newTab()), "new_tab");
+    actNewTab = action(i18n("New Tab"), "tab-new", Qt::ALT | Qt::CTRL | Qt::SHIFT | Qt::Key_N, SLOT(newTab()), "new_tab");
     actDupTab =
         action(i18n("Duplicate Current Tab"), "tab-duplicate", QKeySequence::keyBindings(QKeySequence::AddTab), this, SLOT(duplicateTab()), "duplicate tab");
     actMoveTabToOtherSide =
-        action(i18n("Move Current Tab to Other Side"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_O, SLOT(moveTabToOtherSide()), "move_tab_to_other_side");
-    actMoveTabToLeft = action(i18n("Move Current Tab to the Left"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_PageUp, SLOT(moveTabToLeft()), "move_tab_to_left");
+        action(i18n("Move Current Tab to Other Side"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_O, SLOT(moveTabToOtherSide()), "move_tab_to_other_side");
+    actMoveTabToLeft = action(i18n("Move Current Tab to the Left"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_PageUp, SLOT(moveTabToLeft()), "move_tab_to_left");
     actMoveTabToRight =
-        action(i18n("Move Current Tab to the Right"), nullptr, Qt::CTRL + Qt::SHIFT + Qt::Key_PageDown, SLOT(moveTabToRight()), "move_tab_to_right");
+        action(i18n("Move Current Tab to the Right"), nullptr, Qt::CTRL | Qt::SHIFT | Qt::Key_PageDown, SLOT(moveTabToRight()), "move_tab_to_right");
     actCloseTab = action(i18n("Close Current Tab"), "tab-close", KStandardShortcut::close(), this, SLOT(closeTab()), "close tab");
-    actUndoCloseTab = action(i18n("Undo Close Tab"), "edit-undo", Qt::CTRL + Qt::SHIFT + Qt::Key_T, this, SLOT(undoCloseTab()), "undo_close_tab");
+    actUndoCloseTab = action(i18n("Undo Close Tab"), "edit-undo", Qt::CTRL | Qt::SHIFT | Qt::Key_T, this, SLOT(undoCloseTab()), "undo_close_tab");
     actUndoCloseTab->setEnabled(false);
     actNextTab = action(i18n("Next Tab"), QString(), KStandardShortcut::tabNext(), this, SLOT(nextTab()), "next tab");
     actPreviousTab = action(i18n("Previous Tab"), QString(), KStandardShortcut::tabPrev(), this, SLOT(previousTab()), "previous tab");
-- 
GitLab


From 30b018c14ed2bbb2b581b801d22ef758f96c9b4a Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:21:21 +0300
Subject: [PATCH 10/68] Change from I18N_NOOP to KLazyLocalizedString

I18N_NOOP has been already removed, switch to KLazyLocalizedString
---
 app/ActionMan/useractionpage.cpp |  7 ++++---
 app/BookMan/krbookmark.cpp       | 19 ++++++++++---------
 app/Filter/generalfilter.cpp     | 31 ++++++++++++++++---------------
 app/main.cpp                     |  5 +++--
 4 files changed, 33 insertions(+), 29 deletions(-)

diff --git a/app/ActionMan/useractionpage.cpp b/app/ActionMan/useractionpage.cpp
index 874b71a22..353c5f298 100644
--- a/app/ActionMan/useractionpage.cpp
+++ b/app/ActionMan/useractionpage.cpp
@@ -22,6 +22,7 @@
 
 #include <KLineEdit>
 #include <KLocalizedString>
+#include <KLazyLocalizedString>
 #include <KMessageBox>
 #include <KStandardGuiItem>
 
@@ -34,7 +35,7 @@
 #include "useractionlistview.h"
 
 // This is the filter in the QFileDialog of Import/Export:
-static const char *FILE_FILTER = I18N_NOOP("*.xml|XML files\n*|All files");
+static const KLazyLocalizedString FILE_FILTER = kli18n("*.xml|XML files\n*|All files");
 
 UserActionPage::UserActionPage(QWidget *parent)
     : QWidget(parent)
@@ -224,7 +225,7 @@ void UserActionPage::slotRemoveAction()
 
 void UserActionPage::slotImport()
 {
-    QString filename = QFileDialog::getOpenFileName(this, QString(), QString(), i18n(FILE_FILTER));
+    QString filename = QFileDialog::getOpenFileName(this, QString(), QString(),  KLocalizedString(FILE_FILTER).toString());
     if (filename.isEmpty())
         return;
 
@@ -245,7 +246,7 @@ void UserActionPage::slotExport()
     if (!dynamic_cast<UserActionListViewItem *>(actionTree->currentItem()))
         return;
 
-    QString filename = QFileDialog::getSaveFileName(this, QString(), QString(), i18n(FILE_FILTER));
+    QString filename = QFileDialog::getSaveFileName(this, QString(), QString(),  KLocalizedString(FILE_FILTER).toString());
     if (filename.isEmpty())
         return;
 
diff --git a/app/BookMan/krbookmark.cpp b/app/BookMan/krbookmark.cpp
index aca207ae9..fadbcc6ca 100644
--- a/app/BookMan/krbookmark.cpp
+++ b/app/BookMan/krbookmark.cpp
@@ -15,13 +15,14 @@
 
 #include <KActionCollection>
 #include <KLocalizedString>
+#include <KLazyLocalizedString>
 #include <utility>
 
 #define BM_NAME(X) (QString("Bookmark:") + X)
 
-static const char *NAME_TRASH = I18N_NOOP("Trash bin");
-static const char *NAME_VIRTUAL = I18N_NOOP("Virtual Filesystem");
-static const char *NAME_LAN = I18N_NOOP("Local Network");
+static const KLazyLocalizedString NAME_TRASH = kli18n("Trash bin");
+static const KLazyLocalizedString NAME_VIRTUAL = kli18n("Virtual Filesystem");
+static const KLazyLocalizedString NAME_LAN = kli18n("Local Network");
 
 KrBookmark::KrBookmark(const QString &name, QUrl url, KActionCollection *parent, const QString &iconName, const QString &actionName)
     : QAction(parent)
@@ -79,9 +80,9 @@ KrBookmark *KrBookmark::getExistingBookmark(const QString &actionName, KActionCo
 
 KrBookmark *KrBookmark::trash(KActionCollection *collection)
 {
-    KrBookmark *bm = getExistingBookmark(i18n(NAME_TRASH), collection);
+    KrBookmark *bm =  getExistingBookmark(KLocalizedString(NAME_TRASH).toString(), collection);
     if (!bm)
-        bm = new KrBookmark(i18n(NAME_TRASH), QUrl("trash:/"), collection);
+        bm = new KrBookmark(KLocalizedString(NAME_TRASH).toString(), QUrl("trash:/"), collection);
 
     bm->setIcon(Icon(KrTrashHandler::trashIconName()));
     return bm;
@@ -89,9 +90,9 @@ KrBookmark *KrBookmark::trash(KActionCollection *collection)
 
 KrBookmark *KrBookmark::virt(KActionCollection *collection)
 {
-    KrBookmark *bm = getExistingBookmark(i18n(NAME_VIRTUAL), collection);
+    KrBookmark *bm = getExistingBookmark(KLocalizedString(NAME_VIRTUAL).toString(), collection);
     if (!bm) {
-        bm = new KrBookmark(i18n(NAME_VIRTUAL), QUrl("virt:/"), collection);
+        bm = new KrBookmark(KLocalizedString(NAME_VIRTUAL).toString(), QUrl("virt:/"), collection);
         bm->setIcon(Icon("document-open-remote"));
     }
     return bm;
@@ -99,9 +100,9 @@ KrBookmark *KrBookmark::virt(KActionCollection *collection)
 
 KrBookmark *KrBookmark::lan(KActionCollection *collection)
 {
-    KrBookmark *bm = getExistingBookmark(i18n(NAME_LAN), collection);
+    KrBookmark *bm = getExistingBookmark(KLocalizedString(NAME_LAN).toString(), collection);
     if (!bm) {
-        bm = new KrBookmark(i18n(NAME_LAN), QUrl("remote:/"), collection);
+        bm = new KrBookmark(KLocalizedString(NAME_LAN).toString(), QUrl("remote:/"), collection);
         bm->setIcon(Icon("network-workgroup"));
     }
     return bm;
diff --git a/app/Filter/generalfilter.cpp b/app/Filter/generalfilter.cpp
index 2f553ef19..e27f9dc20 100644
--- a/app/Filter/generalfilter.cpp
+++ b/app/Filter/generalfilter.cpp
@@ -23,30 +23,31 @@
 
 #include <KCharsets>
 #include <KLocalizedString>
+#include <KLazyLocalizedString>
 #include <KMessageBox>
 #include <KSharedConfig>
 #include <KShell>
 
 typedef struct {
-    const char *description;
+    KLazyLocalizedString description;
     const char *regExp;
     int cursorAdjustment;
 } term;
 
 static const term items[] = {
-    {I18N_NOOP("Any Character"), ".", 0},
-    {I18N_NOOP("Start of Line"), "^", 0},
-    {I18N_NOOP("End of Line"), "$", 0},
-    {I18N_NOOP("Set of Characters"), "[]", -1},
-    {I18N_NOOP("Repeats, Zero or More Times"), "*", 0},
-    {I18N_NOOP("Repeats, One or More Times"), "+", 0},
-    {I18N_NOOP("Optional"), "?", 0},
-    {I18N_NOOP("Escape"), "\\", 0},
-    {I18N_NOOP("TAB"), "\\t", 0},
-    {I18N_NOOP("Newline"), "\\n", 0},
-    {I18N_NOOP("Carriage Return"), "\\r", 0},
-    {I18N_NOOP("White Space"), "\\s", 0},
-    {I18N_NOOP("Digit"), "\\d", 0},
+    {kli18n("Any Character"), ".", 0},
+    {kli18n("Start of Line"), "^", 0},
+    {kli18n("End of Line"), "$", 0},
+    {kli18n("Set of Characters"), "[]", -1},
+    {kli18n("Repeats, Zero or More Times"), "*", 0},
+    {kli18n("Repeats, One or More Times"), "+", 0},
+    {kli18n("Optional"), "?", 0},
+    {kli18n("Escape"), "\\", 0},
+    {kli18n("TAB"), "\\t", 0},
+    {kli18n("Newline"), "\\n", 0},
+    {kli18n("Carriage Return"), "\\r", 0},
+    {kli18n("White Space"), "\\s", 0},
+    {kli18n("Digit"), "\\d", 0},
 };
 
 class RegExpAction : public QAction
@@ -295,7 +296,7 @@ GeneralFilter::GeneralFilter(FilterTabs *tabs, int properties, QWidget *parent,
     // Populate the popup menu.
     auto *patterns = new QMenu(containsRegExp);
     for (int i = 0; (unsigned)i < sizeof(items) / sizeof(items[0]); i++) {
-        patterns->addAction(new RegExpAction(patterns, i18n(items[i].description), items[i].regExp, items[i].cursorAdjustment));
+        patterns->addAction(new RegExpAction(patterns, KLocalizedString(items[i].description).toString(), items[i].regExp, items[i].cursorAdjustment));
     }
     connect(containsRegExp, &QToolButton::toggled, this, &GeneralFilter::slotDisable);
     connect(containsRegExp, &QToolButton::triggered, this, &GeneralFilter::slotRegExpTriggered);
diff --git a/app/main.cpp b/app/main.cpp
index 4b9740fb8..b40f0e22f 100644
--- a/app/main.cpp
+++ b/app/main.cpp
@@ -29,6 +29,7 @@
 #include <KAboutData>
 #include <KActionMenu>
 #include <KLocalizedString>
+#include <KLazyLocalizedString>
 #include <KSharedConfig>
 #include <KStartupInfo>
 
@@ -43,7 +44,7 @@
 #include "krusaderview.h"
 #include "panelmanager.h"
 
-static const char *description = I18N_NOOP("Krusader\nTwin-Panel File Manager by KDE");
+static const KLazyLocalizedString description = kli18n("Krusader\nTwin-Panel File Manager by KDE");
 
 static void sigterm_handler(int i)
 {
@@ -112,7 +113,7 @@ int main(int argc, char *argv[])
     KAboutData aboutData(QStringLiteral("krusader"),
                          (geteuid() ? i18n("Krusader") : i18n("Krusader - ROOT PRIVILEGES")),
                          versionName,
-                         i18n(description),
+                         KLocalizedString(description).toString(),
                          KAboutLicense::GPL_V2,
                          i18n(" 2000-2003 Shie Erlich, Rafi Yanai\n 2004-2022 Krusader Krew"),
                          i18n("Feedback:\nhttps://forum.kde.org/viewforum.php?f=225"),
-- 
GitLab


From 81328ae0d410a216fd6e539e3e39cdb5ae46a2e8 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:28:31 +0300
Subject: [PATCH 11/68] Fix QString consistency problem

Won't compile because char * is not implicitly cast to QString anymore,
should be at least UTF-8 strings

QString qchar inconsistency
---
 app/Dialogs/checksumdlg.cpp              |  2 +-
 app/DiskUsage/diskusage.cpp              |  2 +-
 app/DiskUsage/dulines.cpp                |  2 +-
 app/KViewer/lister.cpp                   |  2 +-
 app/Synchronizer/feedtolistboxdialog.cpp |  4 ++--
 app/Synchronizer/synchronizer.cpp        | 12 ++++++------
 app/Synchronizer/synchronizergui.cpp     | 20 ++++++++++----------
 app/paneltabbar.cpp                      |  6 +++---
 8 files changed, 25 insertions(+), 25 deletions(-)

diff --git a/app/Dialogs/checksumdlg.cpp b/app/Dialogs/checksumdlg.cpp
index 9d20f7d61..303eb50fb 100644
--- a/app/Dialogs/checksumdlg.cpp
+++ b/app/Dialogs/checksumdlg.cpp
@@ -340,7 +340,7 @@ void CreateWizard::createChecksums()
     runProcess(type, allFiles);
 
     // set suggested filename
-    m_suggestedFilePath = QDir(m_path).filePath((m_fileNames.count() > 1 ? "checksum." : (m_fileNames[0] + '.')) + type);
+    m_suggestedFilePath = QDir(m_path).filePath((m_fileNames.count() > 1 ? QString("checksum.") : (m_fileNames[0] + '.')) + type);
 }
 
 void CreateWizard::onResultPage()
diff --git a/app/DiskUsage/diskusage.cpp b/app/DiskUsage/diskusage.cpp
index 3465cd9c1..74bbfcf54 100644
--- a/app/DiskUsage/diskusage.cpp
+++ b/app/DiskUsage/diskusage.cpp
@@ -352,7 +352,7 @@ void DiskUsage::slotLoadDirectory()
                                             currentFileItem->getModificationTime(),
                                             currentFileItem->isSymLink(),
                                             mime);
-                    directoryStack.push((dirToCheck.isEmpty() ? "" : dirToCheck + '/') + currentFileItem->getName());
+                    directoryStack.push((dirToCheck.isEmpty() ? QString("") : dirToCheck + '/') + currentFileItem->getName());
                     parentStack.push(dynamic_cast<Directory *>(newItem));
                 } else {
                     newItem = new File(currentParent,
diff --git a/app/DiskUsage/dulines.cpp b/app/DiskUsage/dulines.cpp
index be587c59a..947f8ecee 100644
--- a/app/DiskUsage/dulines.cpp
+++ b/app/DiskUsage/dulines.cpp
@@ -289,7 +289,7 @@ void DULines::slotDirChanged(Directory *dirEntry)
         lastItem->setData(0, Qt::DecorationRole, createPixmap(item->intPercent(), maxPercent, header()->sectionSize(0) - 2 * textMargin));
 
         if (showFileSize)
-            lastItem->setData(2, Qt::UserRole, "  [" + KIO::convertSize(item->size()) + ']');
+            lastItem->setData(2, Qt::UserRole, QVariant(QString("  [") + KIO::convertSize(item->size()) + QString("]")).toString());
 
         QSize size = lastItem->sizeHint(0);
         size.setWidth(16);
diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index 889dbf067..3488fd42e 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -498,7 +498,7 @@ QStringList ListerTextArea::readLines(qint64 filePos, qint64 &endPos, const int
             continue;
         }
 
-        if ((chr[0] < 32) && (chr[0] != '\n') && (chr[0] != '\t')) {
+        if ((chr[0] < QChar(32)) && (chr[0] != '\n') && (chr[0] != '\t')) {
             chr = QChar(CONTROL_CHAR);
         }
 
diff --git a/app/Synchronizer/feedtolistboxdialog.cpp b/app/Synchronizer/feedtolistboxdialog.cpp
index a1c122014..b9b6c11ce 100644
--- a/app/Synchronizer/feedtolistboxdialog.cpp
+++ b/app/Synchronizer/feedtolistboxdialog.cpp
@@ -169,13 +169,13 @@ void FeedToListBoxDialog::slotOk()
             continue;
 
         if ((side == S_BOTH || side == S_LEFT) && syncItem->existsInLeft()) {
-            QString leftDirName = syncItem->leftDirectory().isEmpty() ? "" : syncItem->leftDirectory() + '/';
+            QString leftDirName = syncItem->leftDirectory().isEmpty() ? QString("") : syncItem->leftDirectory() + '/';
             QUrl leftURL = Synchronizer::fsUrl(synchronizer->leftBaseDirectory() + leftDirName + syncItem->leftName());
             urlList.push_back(leftURL);
         }
 
         if ((side == S_BOTH || side == S_RIGHT) && syncItem->existsInRight()) {
-            QString rightDirName = syncItem->rightDirectory().isEmpty() ? "" : syncItem->rightDirectory() + '/';
+            QString rightDirName = syncItem->rightDirectory().isEmpty() ? QString("") : syncItem->rightDirectory() + '/';
             QUrl leftURL = Synchronizer::fsUrl(synchronizer->rightBaseDirectory() + rightDirName + syncItem->rightName());
             urlList.push_back(leftURL);
         }
diff --git a/app/Synchronizer/synchronizer.cpp b/app/Synchronizer/synchronizer.cpp
index a3c9c762b..374e94e6f 100644
--- a/app/Synchronizer/synchronizer.cpp
+++ b/app/Synchronizer/synchronizer.cpp
@@ -694,8 +694,8 @@ SynchronizerFileItem *Synchronizer::addDuplicateItem(SynchronizerFileItem *paren
                                          isTemp);
 
     if (uncertain == TT_UNKNOWN) {
-        QUrl leftURL = Synchronizer::fsUrl(leftDir.isEmpty() ? leftBaseDir + leftName : leftBaseDir + leftDir + '/' + leftName);
-        QUrl rightURL = Synchronizer::fsUrl(rightDir.isEmpty() ? rightBaseDir + rightName : rightBaseDir + rightDir + '/' + rightName);
+        QUrl leftURL = Synchronizer::fsUrl(leftDir.isEmpty() ? (QString) (leftBaseDir + leftName): leftBaseDir + leftDir + QString('/') + leftName);
+        QUrl rightURL = Synchronizer::fsUrl(rightDir.isEmpty() ? (QString) (rightBaseDir + rightName) : rightBaseDir + rightDir + '/' + rightName);
         stack.append(new CompareContentTask(this, item, leftURL, rightURL, leftSize));
     }
 
@@ -1223,8 +1223,8 @@ void Synchronizer::slotTaskFinished(KJob *job)
     if (disableNewTasks && item == lastTask)
         disableNewTasks = false; // the blocker task finished
 
-    QString leftDirName = item->leftDirectory().isEmpty() ? "" : item->leftDirectory() + '/';
-    QString rightDirName = item->rightDirectory().isEmpty() ? "" : item->rightDirectory() + '/';
+    QString leftDirName = item->leftDirectory().isEmpty() ? QString("") : item->leftDirectory() + '/';
+    QString rightDirName = item->rightDirectory().isEmpty() ? QString("") : item->rightDirectory() + '/';
     QUrl leftURL = Synchronizer::fsUrl(leftBaseDir + leftDirName + item->leftName());
     QUrl rightURL = Synchronizer::fsUrl(rightBaseDir + rightDirName + item->rightName());
 
@@ -1558,8 +1558,8 @@ void Synchronizer::synchronizeWithKGet()
             QUrl downloadURL;
             QUrl destURL;
             QString destDir;
-            QString leftDirName = item->leftDirectory().isEmpty() ? "" : item->leftDirectory() + '/';
-            QString rightDirName = item->rightDirectory().isEmpty() ? "" : item->rightDirectory() + '/';
+            QString leftDirName = item->leftDirectory().isEmpty() ? QString("") : item->leftDirectory() + '/';
+            QString rightDirName = item->rightDirectory().isEmpty() ? QString("") : item->rightDirectory() + '/';
 
             if (progDlg == nullptr) {
                 progDlg = new KgetProgressDialog(krMainWindow, i18n("Krusader::Synchronizer"), i18n("Feeding the URLs to KGet"), true);
diff --git a/app/Synchronizer/synchronizergui.cpp b/app/Synchronizer/synchronizergui.cpp
index 3c429f66b..239f913e0 100644
--- a/app/Synchronizer/synchronizergui.cpp
+++ b/app/Synchronizer/synchronizergui.cpp
@@ -89,11 +89,11 @@ public:
             SynchronizerFileItem *item = viewItem->synchronizerItemRef();
             if (item) {
                 if (isLeft && item->existsInLeft()) {
-                    QString leftDirName = item->leftDirectory().isEmpty() ? "" : item->leftDirectory() + '/';
+                    QString leftDirName = item->leftDirectory().isEmpty() ? QString("") : item->leftDirectory() + '/';
                     QUrl leftURL = Synchronizer::fsUrl(synchronizer->leftBaseDirectory() + leftDirName + item->leftName());
                     urls.push_back(leftURL);
                 } else if (!isLeft && item->existsInRight()) {
-                    QString rightDirName = item->rightDirectory().isEmpty() ? "" : item->rightDirectory() + '/';
+                    QString rightDirName = item->rightDirectory().isEmpty() ? QString("") : item->rightDirectory() + '/';
                     QUrl rightURL = Synchronizer::fsUrl(synchronizer->rightBaseDirectory() + rightDirName + item->rightName());
                     urls.push_back(rightURL);
                 }
@@ -668,8 +668,8 @@ void SynchronizerGUI::doubleClicked(QTreeWidgetItem *itemIn)
     auto *syncItem = dynamic_cast<SyncViewItem *>(itemIn);
     SynchronizerFileItem *item = syncItem->synchronizerItemRef();
     if (item && item->existsInLeft() && item->existsInRight() && !item->isDir()) {
-        QString leftDirName = item->leftDirectory().isEmpty() ? "" : item->leftDirectory() + '/';
-        QString rightDirName = item->rightDirectory().isEmpty() ? "" : item->rightDirectory() + '/';
+        QString leftDirName = item->leftDirectory().isEmpty() ? QString("") : item->leftDirectory() + '/';
+        QString rightDirName = item->rightDirectory().isEmpty() ? QString("") : item->rightDirectory() + '/';
         QUrl leftURL = Synchronizer::fsUrl(synchronizer.leftBaseDirectory() + leftDirName + item->leftName());
         QUrl rightURL = Synchronizer::fsUrl(synchronizer.rightBaseDirectory() + rightDirName + item->rightName());
 
@@ -782,8 +782,8 @@ void SynchronizerGUI::rightMouseClicked(QTreeWidgetItem *itemIn, const QPoint &p
 void SynchronizerGUI::executeOperation(SynchronizerFileItem *item, int op)
 {
     // check out the user's option
-    QString leftDirName = item->leftDirectory().isEmpty() ? "" : item->leftDirectory() + '/';
-    QString rightDirName = item->rightDirectory().isEmpty() ? "" : item->rightDirectory() + '/';
+    QString leftDirName = item->leftDirectory().isEmpty() ? QString("") : item->leftDirectory() + '/';
+    QString rightDirName = item->rightDirectory().isEmpty() ? QString("") : item->rightDirectory() + '/';
 
     QUrl leftURL = Synchronizer::fsUrl(synchronizer.leftBaseDirectory() + leftDirName + item->leftName());
     QUrl rightURL = Synchronizer::fsUrl(synchronizer.rightBaseDirectory() + rightDirName + item->rightName());
@@ -1295,8 +1295,8 @@ void SynchronizerGUI::keyPressEvent(QKeyEvent *e)
         bool isedit = e->key() == Qt::Key_F4;
 
         SynchronizerFileItem *item = (dynamic_cast<SyncViewItem *>(listItem))->synchronizerItemRef();
-        QString leftDirName = item->leftDirectory().isEmpty() ? "" : item->leftDirectory() + '/';
-        QString rightDirName = item->rightDirectory().isEmpty() ? "" : item->rightDirectory() + '/';
+        QString leftDirName = item->leftDirectory().isEmpty() ? QString("") : item->leftDirectory() + '/';
+        QString rightDirName = item->rightDirectory().isEmpty() ? QString("") : item->rightDirectory() + '/';
 
         if (item->isDir())
             return;
@@ -1589,11 +1589,11 @@ void SynchronizerGUI::copyToClipboard(bool isLeft)
         SynchronizerFileItem *item = viewItem->synchronizerItemRef();
         if (item) {
             if (isLeft && item->existsInLeft()) {
-                QString leftDirName = item->leftDirectory().isEmpty() ? "" : item->leftDirectory() + '/';
+                QString leftDirName = item->leftDirectory().isEmpty() ? QString("") : item->leftDirectory() + '/';
                 QUrl leftURL = Synchronizer::fsUrl(synchronizer.leftBaseDirectory() + leftDirName + item->leftName());
                 urls.push_back(leftURL);
             } else if (!isLeft && item->existsInRight()) {
-                QString rightDirName = item->rightDirectory().isEmpty() ? "" : item->rightDirectory() + '/';
+                QString rightDirName = item->rightDirectory().isEmpty() ? QString("") : item->rightDirectory() + '/';
                 QUrl rightURL = Synchronizer::fsUrl(synchronizer.rightBaseDirectory() + rightDirName + item->rightName());
                 urls.push_back(rightURL);
             }
diff --git a/app/paneltabbar.cpp b/app/paneltabbar.cpp
index 143925df6..54ba04eb7 100644
--- a/app/paneltabbar.cpp
+++ b/app/paneltabbar.cpp
@@ -183,9 +183,9 @@ QString PanelTabBar::squeeze(const QUrl &url, int tabIndex)
 
     QString text;
     if (!showLongNames) {
-        const QString scheme = url.scheme().isEmpty() || url.isLocalFile() ? "" : (url.scheme() + ':');
-        const QString host = url.host().isEmpty() ? "" : (url.host() + ':');
-        const QString name = url.isLocalFile() && url.fileName().isEmpty() ? "/" : url.fileName();
+        const QString scheme = url.scheme().isEmpty() || url.isLocalFile() ? QString("") : (url.scheme() + ':');
+        const QString host = url.host().isEmpty() ? QString("") : (url.host() + ':');
+        const QString name = url.isLocalFile() && url.fileName().isEmpty() ? QString("/") : url.fileName();
         text = scheme + host + name;
     } else {
         text = longText;
-- 
GitLab


From fd8df75e0bab4e737af173e875be94d0d41572a6 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:36:27 +0300
Subject: [PATCH 12/68] QDateTime::fromTime_t -> QDateTime::fromSecsSinceEpoch
 And viceversa.

The API has been completely removed in Qt6
---
 app/FileSystem/filesystem.cpp     |  6 +++---
 app/FileSystem/krquery.cpp        |  9 +++++----
 app/Synchronizer/synchronizer.cpp |  8 ++++----
 plugins/krarc/krarc.cpp           | 18 +++++++++---------
 4 files changed, 21 insertions(+), 20 deletions(-)

diff --git a/app/FileSystem/filesystem.cpp b/app/FileSystem/filesystem.cpp
index c9b947ad1..7bcc73347 100644
--- a/app/FileSystem/filesystem.cpp
+++ b/app/FileSystem/filesystem.cpp
@@ -303,11 +303,11 @@ FileItem *FileSystem::createFileItemFromKIO(const KIO::UDSEntry &entry, const QU
     const QString fname = virt ? url.toDisplayString() : name;
 
     // get file statistics...
-    const time_t mtime = kfi.time(KFileItem::ModificationTime).toTime_t();
-    const time_t atime = kfi.time(KFileItem::AccessTime).toTime_t();
+    const time_t mtime = kfi.time(KFileItem::ModificationTime).toSecsSinceEpoch();
+    const time_t atime = kfi.time(KFileItem::AccessTime).toSecsSinceEpoch();
     const mode_t mode = kfi.mode() | kfi.permissions();
     const QDateTime creationTime = kfi.time(KFileItem::CreationTime);
-    const time_t btime = creationTime.isValid() ? creationTime.toTime_t() : (time_t)-1;
+    const time_t btime = creationTime.isValid() ? creationTime.toSecsSinceEpoch() : (time_t)-1;
 
     // NOTE: we could get the mimetype (and file icon) from the kfileitem here but this is very
     // slow. Instead, the file item class has it's own (faster) way to determine the file type.
diff --git a/app/FileSystem/krquery.cpp b/app/FileSystem/krquery.cpp
index 3dc65adac..f48d8ba8c 100644
--- a/app/FileSystem/krquery.cpp
+++ b/app/FileSystem/krquery.cpp
@@ -17,6 +17,7 @@
 #include <KFileItem>
 #include <KFormat>
 #include <KIO/Job>
+#include <KIO/TransferJob>
 #include <KLocalizedString>
 #include <KUrlCompletion>
 #include <utility>
@@ -165,8 +166,8 @@ void KrQuery::load(const KConfigGroup &cfg)
     LOAD("ContainRegExp", containRegExp);
     LOAD("MinSize", minSize);
     LOAD("MaxSize", maxSize);
-    newerThen = QDateTime::fromString(cfg.readEntry("NewerThan", QDateTime::fromTime_t(static_cast<uint>(newerThen)).toString())).toTime_t();
-    olderThen = QDateTime::fromString(cfg.readEntry("OlderThan", QDateTime::fromTime_t(static_cast<uint>(olderThen)).toString())).toTime_t();
+    newerThen = QDateTime::fromString(cfg.readEntry("NewerThan", QDateTime::fromSecsSinceEpoch(static_cast<uint>(newerThen)).toString())).toSecsSinceEpoch();
+    olderThen = QDateTime::fromString(cfg.readEntry("OlderThan", QDateTime::fromSecsSinceEpoch(static_cast<uint>(olderThen)).toString())).toSecsSinceEpoch();
     LOAD("Owner", owner);
     LOAD("Group", group);
     LOAD("Perm", perm);
@@ -210,8 +211,8 @@ void KrQuery::save(KConfigGroup cfg)
     cfg.writeEntry("ContainRegExp", containRegExp);
     cfg.writeEntry("MinSize", minSize);
     cfg.writeEntry("MaxSize", maxSize);
-    cfg.writeEntry("NewerThan", QDateTime::fromTime_t(static_cast<uint>(newerThen)).toString());
-    cfg.writeEntry("OlderThan", QDateTime::fromTime_t(static_cast<uint>(olderThen)).toString());
+    cfg.writeEntry("NewerThan", QDateTime::fromSecsSinceEpoch(static_cast<uint>(newerThen)).toString());
+    cfg.writeEntry("OlderThan", QDateTime::fromSecsSinceEpoch(static_cast<uint>(olderThen)).toString());
     cfg.writeEntry("Owner", owner);
     cfg.writeEntry("Group", group);
     cfg.writeEntry("Perm", perm);
diff --git a/app/Synchronizer/synchronizer.cpp b/app/Synchronizer/synchronizer.cpp
index 374e94e6f..5997ffcdc 100644
--- a/app/Synchronizer/synchronizer.cpp
+++ b/app/Synchronizer/synchronizer.cpp
@@ -1336,8 +1336,8 @@ void Synchronizer::slotTaskFinished(KJob *job)
                                                item->leftSize(),
                                                QDateTime(),
                                                QDateTime(),
-                                               QDateTime::fromTime_t(static_cast<uint>(item->rightDate())),
-                                               QDateTime::fromTime_t(static_cast<uint>(item->leftDate())));
+                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())),
+                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())));
                 } else {
                     result = ui->askFileRename(job,
                                                i18n("File Already Exists"),
@@ -1349,8 +1349,8 @@ void Synchronizer::slotTaskFinished(KJob *job)
                                                item->rightSize(),
                                                QDateTime(),
                                                QDateTime(),
-                                               QDateTime::fromTime_t(static_cast<uint>(item->leftDate())),
-                                               QDateTime::fromTime_t(static_cast<uint>(item->rightDate())));
+                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())),
+                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())));
                 }
 
                 switch (result) {
diff --git a/plugins/krarc/krarc.cpp b/plugins/krarc/krarc.cpp
index 50c7aeeb8..4d2355564 100644
--- a/plugins/krarc/krarc.cpp
+++ b/plugins/krarc/krarc.cpp
@@ -1000,7 +1000,7 @@ bool kio_krarcProtocol::setArcFile(const QUrl &url)
        during that period. */
     if (archiveChanging)
         archiveChanged = true;
-    archiveChanging = (currTime == (time_t)arcFile->time(KFileItem::ModificationTime).toTime_t());
+    archiveChanging = (currTime == (time_t)arcFile->time(KFileItem::ModificationTime).toSecsSinceEpoch());
 
     arcPath = getPath(arcFile->url(), QUrl::StripTrailingSlash);
     arcType = detectArchive(encrypted, arcPath);
@@ -1299,7 +1299,7 @@ UDSEntryList *kio_krarcProtocol::addNewDir(const QString &path)
     entry.fastInsert(KIO::UDSEntry::UDS_FILE_TYPE, mode & S_IFMT); // keep file type only
     entry.fastInsert(KIO::UDSEntry::UDS_ACCESS, mode & 07777); // keep permissions only
     entry.fastInsert(KIO::UDSEntry::UDS_SIZE, 0);
-    entry.fastInsert(KIO::UDSEntry::UDS_MODIFICATION_TIME, arcFile->time(KFileItem::ModificationTime).toTime_t());
+    entry.fastInsert(KIO::UDSEntry::UDS_MODIFICATION_TIME, arcFile->time(KFileItem::ModificationTime).toSecsSinceEpoch());
 
     dir->append(entry);
 
@@ -1340,7 +1340,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
         QString d = nextWord(line);
         QDate qdate(d.mid(0, 4).toInt(), d.mid(4, 2).toInt(), d.mid(6, 2).toInt());
         QTime qtime(d.mid(9, 2).toInt(), d.mid(11, 2).toInt(), d.mid(13, 2).toInt());
-        time = QDateTime(qdate, qtime).toTime_t();
+        time = QDateTime(qdate, qtime).toSecsSinceEpoch();
         // full name
         fullName = nextWord(line, '\n');
 
@@ -1361,7 +1361,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
         QDate qdate(d.left(4).toInt(), d.mid(5, 2).toInt(), d.mid(8, 2).toInt());
         QString t = nextWord(line);
         QTime qtime(t.mid(0, 2).toInt(), t.mid(3, 2).toInt(), 0);
-        time = QDateTime(qdate, qtime).toTime_t();
+        time = QDateTime(qdate, qtime).toSecsSinceEpoch();
         // checksum : ignored
         nextWord(line);
         // full name
@@ -1401,7 +1401,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
         QDate qdate(year, d.mid(3, 2).toInt(), d.mid(6, 2).toInt());
         QString t = nextWord(line);
         QTime qtime(t.mid(0, 2).toInt(), t.mid(3, 2).toInt(), 0);
-        time = QDateTime(qdate, qtime).toTime_t();
+        time = QDateTime(qdate, qtime).toSecsSinceEpoch();
         // permissions
         perm = nextWord(line);
         if (perm.length() != 10)
@@ -1498,7 +1498,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
 
         QDate qdate(year, month, day);
 
-        time = QDateTime(qdate, qtime).toTime_t();
+        time = QDateTime(qdate, qtime).toSecsSinceEpoch();
         // full name
         fullName = nextWord(line, '\n');
     }
@@ -1511,7 +1511,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
         QDate qdate(year, d.mid(3, 2).toInt(), d.mid(0, 2).toInt());
         QString t = nextWord(line);
         QTime qtime(t.mid(0, 2).toInt(), t.mid(3, 2).toInt(), 0);
-        time = QDateTime(qdate, qtime).toTime_t();
+        time = QDateTime(qdate, qtime).toSecsSinceEpoch();
         // ignore the next field
         nextWord(line);
         // size
@@ -1537,7 +1537,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
         QDate qdate(d.mid(0, 4).toInt(), d.mid(5, 2).toInt(), d.mid(8, 2).toInt());
         QString t = nextWord(line);
         QTime qtime(t.mid(0, 2).toInt(), t.mid(3, 2).toInt(), 0);
-        time = QDateTime(qdate, qtime).toTime_t();
+        time = QDateTime(qdate, qtime).toSecsSinceEpoch();
         // full name
         fullName = nextWord(line, '\n').mid(1);
         // if ( fullName.right( 1 ) == "/" ) return;
@@ -1552,7 +1552,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
         QDate qdate(d.mid(0, 4).toInt(), d.mid(5, 2).toInt(), d.mid(8, 2).toInt());
         QString t = nextWord(line);
         QTime qtime(t.mid(0, 2).toInt(), t.mid(3, 2).toInt(), t.mid(6, 2).toInt());
-        time = QDateTime(qdate, qtime).toTime_t();
+        time = QDateTime(qdate, qtime).toSecsSinceEpoch();
 
         // permissions
         perm = nextWord(line);
-- 
GitLab


From 402df6f98778256323b28220d9ee8b178cb28919 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 23:02:40 +0300
Subject: [PATCH 13/68] QStandardPaths::DataLocation has been deprecated

use QStandardPaths::AppDataLocation instead
---
 app/Konfigurator/kgcolors.cpp | 2 +-
 app/Panel/krlayoutfactory.cpp | 2 +-
 app/main.cpp                  | 2 +-
 3 files changed, 3 insertions(+), 3 deletions(-)

diff --git a/app/Konfigurator/kgcolors.cpp b/app/Konfigurator/kgcolors.cpp
index ad67e8e66..2145f99de 100644
--- a/app/Konfigurator/kgcolors.cpp
+++ b/app/Konfigurator/kgcolors.cpp
@@ -661,7 +661,7 @@ bool KgColors::apply()
 void KgColors::slotImportColors()
 {
     // find $KDEDIR/share/apps/krusader
-    QString basedir = QStandardPaths::locate(QStandardPaths::DataLocation, QStringLiteral("total_commander.keymap"));
+    QString basedir = QStandardPaths::locate(QStandardPaths::AppDataLocation, QStringLiteral("total_commander.keymap"));
     basedir = QFileInfo(basedir).absolutePath();
     // let the user select a file to load
     QString file = QFileDialog::getOpenFileName(nullptr, i18n("Select a color-scheme file"), basedir, QStringLiteral("*.color"));
diff --git a/app/Panel/krlayoutfactory.cpp b/app/Panel/krlayoutfactory.cpp
index 7678a6d4f..869e164b5 100644
--- a/app/Panel/krlayoutfactory.cpp
+++ b/app/Panel/krlayoutfactory.cpp
@@ -59,7 +59,7 @@ bool KrLayoutFactory::parseFiles()
         return false;
     }
 
-    const QStringList extraFilePaths = QStandardPaths::locateAll(QStandardPaths::DataLocation, EXTRA_FILE_MASK);
+    const QStringList extraFilePaths = QStandardPaths::locateAll(QStandardPaths::AppDataLocation, EXTRA_FILE_MASK);
 
     for (const QString &path : extraFilePaths) {
         qWarning() << "extra file: " << path;
diff --git a/app/main.cpp b/app/main.cpp
index b40f0e22f..83fc3fb02 100644
--- a/app/main.cpp
+++ b/app/main.cpp
@@ -269,7 +269,7 @@ int main(int argc, char *argv[])
     { // don't remove bracket
         KConfigGroup cfg(KSharedConfig::openConfig(), QStringLiteral("Look&Feel"));
         if (cfg.readEntry("Show splashscreen", _ShowSplashScreen)) {
-            QString splashFilename = QStandardPaths::locate(QStandardPaths::DataLocation, QStringLiteral("splash.png"));
+            QString splashFilename = QStandardPaths::locate(QStandardPaths::AppDataLocation, QStringLiteral("splash.png"));
             QPixmap pixmap(splashFilename);
             if (!pixmap.isNull()) {
                 splash = new QSplashScreen(pixmap);
-- 
GitLab


From bcd38368fc1d98f6a3a8c2e2bcba1f823c640258 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:39:42 +0300
Subject: [PATCH 14/68] Switch from KWindowSystem to KxxxExtras

For windowing API calls
---
 app/KViewer/krviewer.cpp | 14 ++++++++------
 app/krusader.cpp         |  4 ++--
 2 files changed, 10 insertions(+), 8 deletions(-)

diff --git a/app/KViewer/krviewer.cpp b/app/KViewer/krviewer.cpp
index 8e08d96cb..a581f71d5 100644
--- a/app/KViewer/krviewer.cpp
+++ b/app/KViewer/krviewer.cpp
@@ -21,6 +21,9 @@
 #include <QStatusBar>
 #include <QGuiApplication>
 
+#include <KWindowSystem>
+#include <kwaylandextras.h>
+#include <kx11extras.h>
 #include <KActionCollection>
 #include <KFileItem>
 #include <KLocalizedString>
@@ -32,7 +35,6 @@
 #include <KShortcutsDialog>
 #include <KStandardAction>
 #include <KToolBar>
-#include <KWindowSystem>
 #include <kxmlgui_version.h>
 #include <utility>
 
@@ -283,10 +285,10 @@ void KrViewer::activateWindow(QWidget *window)
         // KWindowSystem::activateWindow() will just cause the window to blink in
         // the task bar requesting attention, but never get focus or come to the
         // foreground.
-        const int launchedSerial = KWindowSystem::lastInputSerial(focusWindow);
+        const int launchedSerial = KWaylandExtras::lastInputSerial(focusWindow);
         auto conn = std::make_shared<QMetaObject::Connection>();
-        *conn = connect(KWindowSystem::self(),
-                        &KWindowSystem::xdgActivationTokenArrived,
+        *conn = connect(KWaylandExtras::self(),
+                        &KWaylandExtras::xdgActivationTokenArrived,
                         window,
                         [window, launchedSerial, conn](int tokenSerial, const QString &token) {
                             if (tokenSerial == launchedSerial) {
@@ -296,10 +298,10 @@ void KrViewer::activateWindow(QWidget *window)
                                 KWindowSystem::activateWindow(window->windowHandle());
                             }
                         });
-        KWindowSystem::requestXdgActivationToken(focusWindow, launchedSerial, {});
+        KWaylandExtras::requestXdgActivationToken(focusWindow, launchedSerial, {});
     }
     if (KrGlobal::isX11Platform) {
-        KWindowSystem::forceActiveWindow(window->winId());
+        KX11Extras::forceActiveWindow(window->winId());
     }
 }
 KrViewer *KrViewer::getViewer(bool new_window)
diff --git a/app/krusader.cpp b/app/krusader.cpp
index c6ec9d8ae..825efbfa6 100644
--- a/app/krusader.cpp
+++ b/app/krusader.cpp
@@ -18,7 +18,6 @@
 #include <QResizeEvent>
 // QtWidgets
 #include <QApplication>
-#include <QDesktopWidget>
 #include <QMenuBar>
 // QtDBus
 #include <QDBusInterface>
@@ -37,6 +36,7 @@
 #include <KWindowSystem>
 #include <KXMLGUIFactory>
 #include <utility>
+#include <kx11extras.h>
 
 #include "defaults.h"
 #include "kractions.h"
@@ -557,7 +557,7 @@ void Krusader::moveToTop()
     if (isHidden())
         show();
 
-    KWindowSystem::forceActiveWindow(winId());
+    KX11Extras::forceActiveWindow(winId());
 }
 
 bool Krusader::isRunning()
-- 
GitLab


From 9f5ae2112b48e5d5a88f47cdc3cee2aa426ac7a2 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:43:43 +0300
Subject: [PATCH 15/68] Switch to new QRegularExpressionValidator API

---
 app/Konfigurator/kgpanel.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/Konfigurator/kgpanel.cpp b/app/Konfigurator/kgpanel.cpp
index c6e6acefa..10a8c283b 100644
--- a/app/Konfigurator/kgpanel.cpp
+++ b/app/Konfigurator/kgpanel.cpp
@@ -381,7 +381,7 @@ void KgPanel::setupView(KrViewInstance *instance, QWidget *parent)
                                                QString(),
                                                PAGE_VIEW);
     delete[] iconSizes;
-    cmb->lineEdit()->setValidator(new QRegExpValidator(QRegExp("[1-9]\\d{0,1}"), cmb));
+    cmb->lineEdit()->setValidator(new QRegularExpressionValidator(QRegularExpression("[1-9]\\d{0,1}"), cmb));
     hbox->addWidget(cmb);
 
     hbox->addWidget(createSpacer(parent));
-- 
GitLab


From e3342600b410e236e38a217d90aa50847620d9aa Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:49:18 +0300
Subject: [PATCH 16/68] BrowserExtension has been renamed to
 NavigationExtension

BrowserExtension has been renamed to NavigationExtension
---
 app/KViewer/krviewer.cpp    |  6 ++++--
 app/KViewer/krviewer.h      |  2 +-
 app/KViewer/lister.cpp      |  2 +-
 app/KViewer/lister.h        |  8 ++++----
 app/KViewer/panelviewer.cpp | 14 +++++++-------
 5 files changed, 17 insertions(+), 15 deletions(-)

diff --git a/app/KViewer/krviewer.cpp b/app/KViewer/krviewer.cpp
index a581f71d5..4f41e8e23 100644
--- a/app/KViewer/krviewer.cpp
+++ b/app/KViewer/krviewer.cpp
@@ -28,6 +28,7 @@
 #include <KFileItem>
 #include <KLocalizedString>
 #include <KMessageBox>
+#include <KFileItem>
 #include <KParts/Part>
 #include <KProcess>
 #include <KSharedConfig>
@@ -37,6 +38,7 @@
 #include <KToolBar>
 #include <kxmlgui_version.h>
 #include <utility>
+#include <KParts/NavigationExtension>
 
 #include "../defaults.h"
 #include "../icon.h"
@@ -622,7 +624,7 @@ void KrViewer::print()
     if (!pvb || !pvb->part() || !isPartAdded(pvb->part()))
         return;
 
-    KParts::BrowserExtension *ext = KParts::BrowserExtension::childObject(pvb->part());
+    KParts::NavigationExtension *ext = KParts::NavigationExtension::childObject(pvb->part());
     if (ext && ext->isActionEnabled("print"))
         Invoker(ext, SLOT(print())).invoke();
 }
@@ -633,7 +635,7 @@ void KrViewer::copy()
     if (!pvb || !pvb->part() || !isPartAdded(pvb->part()))
         return;
 
-    KParts::BrowserExtension *ext = KParts::BrowserExtension::childObject(pvb->part());
+    KParts::NavigationExtension *ext = KParts::NavigationExtension::childObject(pvb->part());
     if (ext && ext->isActionEnabled("copy"))
         Invoker(ext, SLOT(copy())).invoke();
 }
diff --git a/app/KViewer/krviewer.h b/app/KViewer/krviewer.h
index 939005e88..1f1ebf523 100644
--- a/app/KViewer/krviewer.h
+++ b/app/KViewer/krviewer.h
@@ -22,7 +22,7 @@
 #include <QMenu>
 #include <QTabWidget>
 
-#include <KParts/BrowserExtension>
+#include <KParts/ReadOnlyPart>
 #include <KParts/MainWindow>
 #include <KParts/PartManager>
 
diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index 3488fd42e..78d4d6dcc 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -1144,7 +1144,7 @@ bool ListerPane::handleCloseEvent(QEvent *e)
 }
 
 ListerBrowserExtension::ListerBrowserExtension(Lister *lister)
-    : KParts::BrowserExtension(lister)
+    : KParts::NavigationExtension(lister)
 {
     _lister = lister;
 
diff --git a/app/KViewer/lister.h b/app/KViewer/lister.h
index 2ad776244..807e40029 100644
--- a/app/KViewer/lister.h
+++ b/app/KViewer/lister.h
@@ -20,7 +20,7 @@
 #include <QWidget>
 
 #include <KLineEdit>
-#include <KParts/BrowserExtension>
+#include <KParts/NavigationExtension>
 #include <KParts/Part>
 #include <KTextEdit>
 
@@ -114,8 +114,8 @@ protected:
 
     qint64 _lastPageStartPos = 0;
 
-    int _sizeX = -1;
-    int _sizeY = -1;
+    qsizetype _sizeX = -1;
+    qsizetype _sizeY = -1;
     int _pageSize = 0;
 
     int _tabWidth = 4;
@@ -141,7 +141,7 @@ protected:
     QTimer _blinkTimer;
 };
 
-class ListerBrowserExtension : public KParts::BrowserExtension
+class ListerBrowserExtension : public KParts::NavigationExtension
 {
     Q_OBJECT
 
diff --git a/app/KViewer/panelviewer.cpp b/app/KViewer/panelviewer.cpp
index c1d438384..e86637694 100644
--- a/app/KViewer/panelviewer.cpp
+++ b/app/KViewer/panelviewer.cpp
@@ -23,7 +23,7 @@
 #endif
 
 #include <KLocalizedString>
-#include <KParts/BrowserExtension>
+#include <KParts/NavigationExtension>
 #include <KParts/ReadWritePart>
 #include <KSharedConfig>
 
@@ -344,10 +344,10 @@ KParts::ReadOnlyPart *PanelViewer::createPart(QString mimetype)
 #endif
 
     if (part) {
-        KParts::BrowserExtension *ext = KParts::BrowserExtension::childObject(part);
+        KParts::NavigationExtension *ext = KParts::NavigationExtension::childObject(part);
         if (ext) {
-            connect(ext, &KParts::BrowserExtension::openUrlRequestDelayed, this, &PanelViewer::openUrl);
-            connect(ext, &KParts::BrowserExtension::openUrlRequestDelayed, this, &PanelViewer::openUrlRequest);
+            connect(ext, &KParts::NavigationExtension::openUrlRequestDelayed, this, &PanelViewer::openUrl);
+            connect(ext, &KParts::NavigationExtension::openUrlRequestDelayed, this, &PanelViewer::openUrlRequest);
         }
     }
     return part;
@@ -472,10 +472,10 @@ KParts::ReadOnlyPart *PanelEditor::createPart(QString mimetype)
 #endif
 
     if (part) {
-        KParts::BrowserExtension *ext = KParts::BrowserExtension::childObject(part);
+        KParts::NavigationExtension *ext = KParts::NavigationExtension::childObject(part);
         if (ext) {
-            connect(ext, &KParts::BrowserExtension::openUrlRequestDelayed, this, &PanelEditor::openUrl);
-            connect(ext, &KParts::BrowserExtension::openUrlRequestDelayed, this, &PanelEditor::openUrlRequest);
+            connect(ext, &KParts::NavigationExtension::openUrlRequestDelayed, this, &PanelEditor::openUrl);
+            connect(ext, &KParts::NavigationExtension::openUrlRequestDelayed, this, &PanelEditor::openUrlRequest);
         }
     }
     return part;
-- 
GitLab


From 732b0f7b6a8e99af19049a872a84b5134f22555a Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 10:55:06 +0300
Subject: [PATCH 17/68] Update to the new KIO interface

Includes new header files and adapting to the new API

Fix askFileRename
---
 app/Archive/abstractthreadedjob.h        |   1 +
 app/DiskUsage/radialMap/widgetEvents.cpp |  11 +-
 app/FileSystem/defaultfilesystem.cpp     |  11 +-
 app/FileSystem/defaultfilesystem.h       |   2 +-
 app/FileSystem/krquery.h                 |   1 +
 app/GUI/krremoteencodingmenu.cpp         |   4 +-
 app/JobMan/jobman.cpp                    |   2 +-
 app/KViewer/lister.cpp                   |   1 +
 app/KViewer/panelviewer.cpp              |   2 +
 app/Konfigurator/krresulttable.cpp       |   8 +-
 app/Konfigurator/krresulttable.h         |   2 +-
 app/MountMan/kmountman.cpp               |   2 +
 app/MountMan/kmountmangui.cpp            |  12 +-
 app/MountMan/kmountmangui.h              |   2 +-
 app/Panel/panelfunc.cpp                  |  16 +--
 app/Splitter/combiner.cpp                |   9 +-
 app/Splitter/combiner.h                  |   2 +
 app/Splitter/splitter.cpp                |   9 +-
 app/Splitter/splitter.h                  |   2 +
 app/Synchronizer/synchronizer.cpp        | 150 +++++++++++++----------
 app/Synchronizer/synchronizerdirlist.cpp |   3 +-
 app/Synchronizer/synchronizertask.h      |   1 +
 app/krslots.cpp                          |   1 +
 23 files changed, 133 insertions(+), 121 deletions(-)

diff --git a/app/Archive/abstractthreadedjob.h b/app/Archive/abstractthreadedjob.h
index 594e0bb39..74cddfddc 100644
--- a/app/Archive/abstractthreadedjob.h
+++ b/app/Archive/abstractthreadedjob.h
@@ -22,6 +22,7 @@
 #include <QWaitCondition>
 
 #include <KIO/Job>
+#include <KIO/Global>
 
 class AbstractJobThread;
 class QTemporaryDir;
diff --git a/app/DiskUsage/radialMap/widgetEvents.cpp b/app/DiskUsage/radialMap/widgetEvents.cpp
index d8e5e719c..cd84e70be 100644
--- a/app/DiskUsage/radialMap/widgetEvents.cpp
+++ b/app/DiskUsage/radialMap/widgetEvents.cpp
@@ -25,7 +25,6 @@
 #include <KIO/JobUiDelegate>
 #include <KLocalizedString>
 #include <KMessageBox>
-#include <KRun>
 #include <kio_version.h>
 #include <kservice_version.h>
 
@@ -183,14 +182,9 @@ void RadialMap::Widget::mousePressEvent(QMouseEvent *e)
                 result = (QAction *)-1; // sanity
 
             if (result == actKonq) {
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 71, 0)
                 // KJob jobs will delete themselves when they finish (see kjob.h for more info)
                 auto *job = new KIO::OpenUrlJob(url, this);
                 job->start();
-#else
-                // KRun::runCommand will show an error message if there was trouble
-                KRun::runCommand(QString("kfmclient openURL '%1'").arg(url.url()), this);
-#endif
             } else if (result == actKonsole) {
 #if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 83, 0)
                 auto *job = new KTerminalLauncherJob(QString());
@@ -230,8 +224,9 @@ void RadialMap::Widget::mousePressEvent(QMouseEvent *e)
 
             m_tip.hide(); // user expects this
 
-            if (!isDir || e->button() == Qt::MidButton) {
-                new KRun(url, this, true); // FIXME see above
+            if (!isDir || e->button() == Qt::MiddleButton) {
+                auto *job = new KIO::OpenUrlJob(url, this);
+                job->start();
             } else if (m_focus->file() != m_tree) { // is left mouse button
                 emit activated(url); // activate first, this will cause UI to prepare itself
                 if (m_focus)
diff --git a/app/FileSystem/defaultfilesystem.cpp b/app/FileSystem/defaultfilesystem.cpp
index aeb0c9fbf..a446df634 100644
--- a/app/FileSystem/defaultfilesystem.cpp
+++ b/app/FileSystem/defaultfilesystem.cpp
@@ -12,12 +12,13 @@
 #include <QDir>
 #include <QEventLoop>
 
-#include <KDiskFreeSpaceInfo>
 #include <KFileItem>
 #include <KIO/DropJob>
+#include <KIO/FileSystemFreeSpaceJob>
 #include <KIO/FileUndoManager>
 #include <KIO/JobUiDelegate>
 #include <KIO/ListJob>
+#include <KIO/MkdirJob>
 #include <KIO/MkpathJob>
 #include <KIO/FileSystemFreeSpaceJob>
 #include <KLocalizedString>
@@ -159,10 +160,10 @@ void DefaultFileSystem::updateFilesystemInfo()
     const QString path = _currentDirectory.path();
     KIO::FileSystemFreeSpaceJob *job = KIO::fileSystemFreeSpace(QUrl::fromLocalFile(path));
 
-    connect(job, &KIO::FileSystemFreeSpaceJob::result, this, &DefaultFileSystem::freeSpaceResult);
+    connect(job, &KIO::FileSystemFreeSpaceJob::finished, this, &DefaultFileSystem::freeSpaceResult);
 }
 
-void DefaultFileSystem::freeSpaceResult(KJob *job, KIO::filesize_t size, KIO::filesize_t available)
+void DefaultFileSystem::freeSpaceResult(KJob *job)
 {
     if (!job->error()) {
         KIO::FileSystemFreeSpaceJob *freeSpaceJob = qobject_cast<KIO::FileSystemFreeSpaceJob *>(job);
@@ -177,7 +178,7 @@ void DefaultFileSystem::freeSpaceResult(KJob *job, KIO::filesize_t size, KIO::fi
             fsType = "";
             _mountPoint = "";
         }
-        emit fileSystemInfoChanged("", fsType, size, available);
+        emit fileSystemInfoChanged("", fsType, freeSpaceJob->size(), freeSpaceJob->availableSize());
     } else {
         _mountPoint = "";
         emit fileSystemInfoChanged(i18n("Space information unavailable"), "", 0, 0);
@@ -205,7 +206,7 @@ bool DefaultFileSystem::refreshInternal(const QUrl &directory, bool onlyScan)
     _currentDirectory = cleanUrl(directory);
 
     // start the listing job
-    KIO::ListJob *job = KIO::listDir(_currentDirectory, KIO::HideProgressInfo, showHiddenFiles());
+    KIO::ListJob *job = KIO::listDir(_currentDirectory, KIO::HideProgressInfo, KIO::ListJob::ListFlags(showHiddenFiles() ? 1 : 0));
     connect(job, &KIO::ListJob::entries, this, &DefaultFileSystem::slotAddFiles);
     connect(job, &KIO::ListJob::redirection, this, &DefaultFileSystem::slotRedirection);
     connect(job, &KIO::ListJob::permanentRedirection, this, &DefaultFileSystem::slotRedirection);
diff --git a/app/FileSystem/defaultfilesystem.h b/app/FileSystem/defaultfilesystem.h
index c98432365..3e8a868ea 100644
--- a/app/FileSystem/defaultfilesystem.h
+++ b/app/FileSystem/defaultfilesystem.h
@@ -88,7 +88,7 @@ protected slots:
 private:
     bool refreshLocal(const QUrl &directory, bool onlyScan); // NOTE: this is very fast
     FileItem *createLocalFileItem(const QString &name);
-    void freeSpaceResult(KJob *job, KIO::filesize_t size, KIO::filesize_t available);
+    void freeSpaceResult(KJob *job);
 
     /// Returns the current path with symbolic links resolved
     QString realPath();
diff --git a/app/FileSystem/krquery.h b/app/FileSystem/krquery.h
index 9fa0e3553..9fca43dc8 100644
--- a/app/FileSystem/krquery.h
+++ b/app/FileSystem/krquery.h
@@ -15,6 +15,7 @@
 #include <QUrl>
 
 #include <KConfigGroup>
+#include <KIO/Global>
 #include <KIO/Job>
 
 class QTextCodec;
diff --git a/app/GUI/krremoteencodingmenu.cpp b/app/GUI/krremoteencodingmenu.cpp
index c15578034..4f36f8ab5 100644
--- a/app/GUI/krremoteencodingmenu.cpp
+++ b/app/GUI/krremoteencodingmenu.cpp
@@ -18,10 +18,10 @@
 #include <KCharsets>
 #include <KConfig>
 #include <KConfigGroup>
-#include <KIO/Scheduler>
 #include <KLocalizedString>
 #include <KProtocolManager>
 
+#include "../FileSystem/sizecalculator.h"
 #include "../Panel/krpanel.h"
 #include "../Panel/panelfunc.h"
 #include "../compat.h"
@@ -206,8 +206,6 @@ void KrRemoteEncodingMenu::chooseDefault()
 
 void KrRemoteEncodingMenu::updateKIOSlaves()
 {
-    KIO::Scheduler::emitReparseSlaveConfiguration();
-
     // Reload the page with the new charset
     QTimer::singleShot(500, ACTIVE_FUNC, SLOT(refresh()));
 }
diff --git a/app/JobMan/jobman.cpp b/app/JobMan/jobman.cpp
index fb223dfe1..775d9b559 100644
--- a/app/JobMan/jobman.cpp
+++ b/app/JobMan/jobman.cpp
@@ -145,7 +145,7 @@ private slots:
         connect(job, &KJob::suspended, this, &JobMenuAction::updatePauseResumeButton);
         connect(job, &KJob::resumed, this, &JobMenuAction::updatePauseResumeButton);
         connect(job, &KJob::result, this, &JobMenuAction::slotResult);
-        connect(job, &KJob::warning, this, [](KJob *, const QString &plain, const QString &) {
+        connect(job, &KJob::warning, this, [](KJob *, const QString &plain) {
             qWarning() << "unexpected job warning: " << plain;
         });
 
diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index 78d4d6dcc..8e06b092e 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -42,6 +42,7 @@
 #include <KIO/JobUiDelegate>
 #include <KIO/JobUiDelegateFactory>
 #include <KIO/TransferJob>
+#include <KIO/JobTracker>
 #include <KJobTrackerInterface>
 #include <KLocalizedString>
 #include <KMessageBox>
diff --git a/app/KViewer/panelviewer.cpp b/app/KViewer/panelviewer.cpp
index e86637694..98e762f37 100644
--- a/app/KViewer/panelviewer.cpp
+++ b/app/KViewer/panelviewer.cpp
@@ -30,6 +30,8 @@
 #if CREATE_KPART_5_82
 #include <KParts/PartLoader>
 #endif
+#include <KIO/StatJob>
+#include <KService>
 
 #include <KFileItem>
 #include <KMessageBox>
diff --git a/app/Konfigurator/krresulttable.cpp b/app/Konfigurator/krresulttable.cpp
index 99ec9bfa1..febdc80ec 100644
--- a/app/Konfigurator/krresulttable.cpp
+++ b/app/Konfigurator/krresulttable.cpp
@@ -19,6 +19,8 @@
 #include <QLabel>
 
 #include <KLocalizedString>
+#include <KIO/JobUiDelegate>
+#include <KIO/OpenUrlJob>
 #include <kio_version.h>
 
 #include "../Archive/krarchandler.h"
@@ -243,7 +245,8 @@ bool KrArchiverResultTable::addRow(SearchObject *search, QGridLayout *grid)
 
 void KrArchiverResultTable::website(const QString &url)
 {
-    (void)new KRun(QUrl(url), this);
+    auto *job = new KIO::OpenUrlJob(QUrl(url), this);
+    job->start();
 }
 
 // -----------------------------------------------------------------------------
@@ -373,5 +376,6 @@ bool KrToolResultTable::addRow(SearchObject *search, QGridLayout *grid)
 
 void KrToolResultTable::website(const QString &url)
 {
-    (void)new KRun(QUrl(url), this);
+    auto *job = new KIO::OpenUrlJob(QUrl(url), this);
+    job->start();
 }
diff --git a/app/Konfigurator/krresulttable.h b/app/Konfigurator/krresulttable.h
index 85fa21704..3985ebf3d 100644
--- a/app/Konfigurator/krresulttable.h
+++ b/app/Konfigurator/krresulttable.h
@@ -17,7 +17,7 @@
 #include <QLabel>
 #include <QLayout>
 
-#include <KRun>
+#include <KJob>
 #include <KSeparator>
 #include <KUrlLabel>
 
diff --git a/app/MountMan/kmountman.cpp b/app/MountMan/kmountman.cpp
index 4e7abb866..3f6521f01 100644
--- a/app/MountMan/kmountman.cpp
+++ b/app/MountMan/kmountman.cpp
@@ -16,6 +16,8 @@
 
 #include <KIO/JobUiDelegate>
 #include <KIO/JobUiDelegateFactory>
+#include <KIO/SimpleJob>
+#include <KIO/JobTracker>
 #include <KJobTrackerInterface>
 #include <KLocalizedString>
 #include <KMessageBox>
diff --git a/app/MountMan/kmountmangui.cpp b/app/MountMan/kmountmangui.cpp
index 7ce67d576..b9b13ea86 100644
--- a/app/MountMan/kmountmangui.cpp
+++ b/app/MountMan/kmountmangui.cpp
@@ -32,8 +32,6 @@
 #include <QMenu>
 #include <QPushButton>
 
-#include <KCodecs>
-#include <KDiskFreeSpaceInfo>
 #include <KGuiItem>
 #include <KLocalizedString>
 #include <KMessageBox>
@@ -226,8 +224,8 @@ void KMountManGUI::getSpaceData()
         data.setName(it->mountedFrom());
         data.setType(it->mountType());
         KIO::FileSystemFreeSpaceJob *job = KIO::fileSystemFreeSpace(QUrl::fromLocalFile(it->mountPoint()));
-        connect(job, &KIO::FileSystemFreeSpaceJob::result, this,
-                [this, data](KJob *job, KIO::filesize_t size, KIO::filesize_t available){ this->freeSpaceResult(job, size, available, data); });
+        connect(job, &KIO::FileSystemFreeSpaceJob::finished, this,
+                [this, data](KJob *job){ this->freeSpaceResult(job, data); });
         // Add a timeout and also wait for each info job to complete, this way they are added in sequence
         connect(job, &KIO::FileSystemFreeSpaceJob::result, &loop, &QEventLoop::quit);
         connect(&timer, &QTimer::timeout, &loop, &QEventLoop::quit);
@@ -247,14 +245,14 @@ void KMountManGUI::getSpaceData()
     updateList();
 }
 
-void KMountManGUI::freeSpaceResult(KJob *job, KIO::filesize_t size, KIO::filesize_t available, fsData data)
+void KMountManGUI::freeSpaceResult(KJob *job, fsData data)
 {
     if (!job->error()) {
         KIO::FileSystemFreeSpaceJob *freeSpaceJob = qobject_cast<KIO::FileSystemFreeSpaceJob *>(job);
         Q_ASSERT(freeSpaceJob);
         // Set the missing information, with the assumption the caller already set the rest
-        data.setTotalBlks(size / 1024);
-        data.setFreeBlks(available / 1024);
+        data.setTotalBlks(freeSpaceJob->size() / 1024);
+        data.setFreeBlks(freeSpaceJob->availableSize() / 1024);
 
         fileSystems.append(data);
     } else {
diff --git a/app/MountMan/kmountmangui.h b/app/MountMan/kmountmangui.h
index 760165920..2bb7f1b27 100644
--- a/app/MountMan/kmountmangui.h
+++ b/app/MountMan/kmountmangui.h
@@ -66,7 +66,7 @@ protected:
     void addNonMounted();
 
 private:
-    void freeSpaceResult(KJob *job, KIO::filesize_t size, KIO::filesize_t available, fsData data);
+    void freeSpaceResult(KJob *job, fsData data);
 
 
     KMountMan *mountMan;
diff --git a/app/Panel/panelfunc.cpp b/app/Panel/panelfunc.cpp
index 9bd1893f7..3837070d5 100644
--- a/app/Panel/panelfunc.cpp
+++ b/app/Panel/panelfunc.cpp
@@ -6,8 +6,6 @@
     SPDX-License-Identifier: GPL-2.0-or-later
 */
 
-#include "panelfunc.h"
-
 // QtCore
 #include <QDir>
 #include <QEventLoop>
@@ -25,6 +23,7 @@
 #include <KDesktopFile>
 #include <KIO/DesktopExecParser>
 #include <KIO/JobUiDelegate>
+#include <KIO/JobTracker>
 #include <KJobTrackerInterface>
 #include <KLocalizedString>
 #include <KProcess>
@@ -33,17 +32,14 @@
 #include <KUrlMimeData>
 
 #include <kio_version.h>
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 71, 0)
 #include <KIO/CommandLauncherJob>
 #include <KIO/OpenUrlJob>
 #include <KIO/JobUiDelegateFactory>
-#endif
+#include <KIO/StatJob>
 
-#include <KDesktopFileActions>
 #include <KOpenWithDialog>
 #include <KPropertiesDialog>
 #include <KProtocolInfo>
-#include <KRun>
 
 #include <KApplicationTrader>
 #include <kservice_version.h>
@@ -81,6 +77,8 @@
 #include "krsearchbar.h"
 #include "listpanel.h"
 #include "listpanelactions.h"
+#include "panelfunc.h"
+
 
 QPointer<ListPanelFunc> ListPanelFunc::copyToClipboardOrigin;
 
@@ -151,16 +149,12 @@ void ListPanelFunc::openFileNameInternal(const QString &name, bool externallyExe
 
     if (externallyExecutable) {
         if (mime == QLatin1String("application/x-desktop")) {
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 71, 0)
             // KJob jobs will delete themselves when they finish (see kjob.h for more info)
             auto *job = new KIO::OpenUrlJob(url, this);
             job->start();
-#else
-            KDesktopFileActions::runWithStartup(url, url.isLocalFile(), QByteArray());
-#endif
             return;
         }
-        if (KRun::isExecutableFile(url, mime)) {
+        if (KIO::OpenUrlJob::isExecutableFile(url, mime)) {
             runCommand(KShell::quoteArg(url.path()));
             return;
         }
diff --git a/app/Splitter/combiner.cpp b/app/Splitter/combiner.cpp
index 8eac9f812..58d05e7d4 100644
--- a/app/Splitter/combiner.cpp
+++ b/app/Splitter/combiner.cpp
@@ -13,6 +13,7 @@
 
 #include <KFileItem>
 #include <KIO/Job>
+#include <KIO/StatJob>
 #include <KIO/JobUiDelegate>
 #include <KLocalizedString>
 #include <KMessageBox>
@@ -165,11 +166,7 @@ void Combiner::statDest()
             writeURL.setPath(writeURL.path() + baseURL.fileName());
     }
 
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 69, 0)
-    statJob = KIO::statDetails(writeURL, KIO::StatJob::DestinationSide, KIO::StatNoDetails, KIO::HideProgressInfo);
-#else
-    statJob = KIO::stat(writeURL, KIO::StatJob::DestinationSide, 0, KIO::HideProgressInfo);
-#endif
+    statJob = KIO::stat(writeURL, KIO::StatJob::DestinationSide, KIO::StatNoDetails, KIO::HideProgressInfo);
     connect(statJob, &KIO::StatJob::result, this, &Combiner::statDestResult);
 }
 
@@ -185,7 +182,7 @@ void Combiner::statDestResult(KJob *job)
             reject();
         }
     } else { // destination already exists
-        KIO::RenameDialog_Options mode = dynamic_cast<KIO::StatJob *>(job)->statResult().isDir() ? KIO::RenameDialog_IsDirectory : KIO::RenameDialog_Overwrite;
+        KIO::RenameDialog_Options mode = dynamic_cast<KIO::StatJob *>(job)->statResult().isDir() ? KIO::RenameDialog_DestIsDirectory : KIO::RenameDialog_Overwrite;
         KIO::RenameDialog dlg(this, i18n("File Already Exists"), QUrl(), writeURL, mode);
         switch (dlg.exec()) {
         case KIO::Result_Overwrite:
diff --git a/app/Splitter/combiner.h b/app/Splitter/combiner.h
index d4eb3bebf..818faf307 100644
--- a/app/Splitter/combiner.h
+++ b/app/Splitter/combiner.h
@@ -15,6 +15,8 @@
 #include <QProgressDialog>
 
 #include <KIO/Job>
+#include <KIO/Global>
+#include <KIO/TransferJob>
 
 #include "crc32.h"
 
diff --git a/app/Splitter/splitter.cpp b/app/Splitter/splitter.cpp
index 0e43001db..f2aff9593 100644
--- a/app/Splitter/splitter.cpp
+++ b/app/Splitter/splitter.cpp
@@ -16,6 +16,7 @@
 #include <KFileItem>
 #include <KIO/Job>
 #include <KIO/JobUiDelegate>
+#include <KIO/StatJob>
 #include <KLocalizedString>
 #include <KMessageBox>
 #include <kio_version.h>
@@ -152,11 +153,7 @@ void Splitter::nextOutputFile()
     if (overwrite)
         openOutputFile();
     else {
-#if KIO_VERSION >= QT_VERSION_CHECK(5, 69, 0)
-        statJob = KIO::statDetails(writeURL, KIO::StatJob::DestinationSide, KIO::StatNoDetails, KIO::HideProgressInfo);
-#else
-        statJob = KIO::stat(writeURL, KIO::StatJob::DestinationSide, 0, KIO::HideProgressInfo);
-#endif
+        statJob = KIO::stat(writeURL, KIO::StatJob::DestinationSide, KIO::StatNoDetails, KIO::HideProgressInfo);
         connect(statJob, &KIO::Job::result, this, &Splitter::statOutputFileResult);
     }
 }
@@ -177,7 +174,7 @@ void Splitter::statOutputFileResult(KJob *job)
                               i18n("File Already Exists"),
                               QUrl(),
                               writeURL,
-                              static_cast<KIO::RenameDialog_Options>(KIO::M_MULTI | KIO::M_OVERWRITE | KIO::M_NORENAME));
+                              static_cast<KIO::RenameDialog_Options>(KIO::RenameDialog_MultipleItems  | KIO::RenameDialog_Overwrite | KIO::RenameDialog_NoRename));
         switch (dlg.exec()) {
         case KIO::Result_Overwrite:
             openOutputFile();
diff --git a/app/Splitter/splitter.h b/app/Splitter/splitter.h
index aebf5e901..3b5adb668 100644
--- a/app/Splitter/splitter.h
+++ b/app/Splitter/splitter.h
@@ -15,6 +15,8 @@
 #include <QProgressDialog>
 
 #include <KIO/Job>
+#include <KIO/TransferJob>
+#include <KIO/Global>
 
 #include "crc32.h"
 
diff --git a/app/Synchronizer/synchronizer.cpp b/app/Synchronizer/synchronizer.cpp
index 5997ffcdc..7735d9693 100644
--- a/app/Synchronizer/synchronizer.cpp
+++ b/app/Synchronizer/synchronizer.cpp
@@ -35,6 +35,9 @@
 #include <KIO/DeleteJob>
 #include <KIO/JobUiDelegate>
 #include <KIO/SkipDialog>
+#include <KIO/MkdirJob>
+#include <KIO/FileCopyJob>
+#include <KIO/WidgetsAskUserActionHandler>
 #include <KLocalizedString>
 #include <KMessageBox>
 #include <KProcess>
@@ -1316,64 +1319,68 @@ void Synchronizer::slotTaskFinished(KJob *job)
             }
         } else {
             if (job->error() == KIO::ERR_FILE_ALREADY_EXIST && item->task() != TT_DELETE) {
-                KIO::RenameDialog_Result result;
-                QString newDest;
 
                 if (autoSkip)
                     break;
 
-                auto *ui = dynamic_cast<KIO::JobUiDelegate *>(job->uiDelegate());
-                ui->setWindow(syncDlgWidget);
-
-                if (item->task() == TT_COPY_TO_LEFT) {
-                    result = ui->askFileRename(job,
-                                               i18n("File Already Exists"),
-                                               rightURL,
-                                               leftURL,
-                                               KIO::RenameDialog_Overwrite | KIO::RenameDialog_Skip | KIO::RenameDialog_MultipleItems,
-                                               newDest,
-                                               item->rightSize(),
-                                               item->leftSize(),
-                                               QDateTime(),
-                                               QDateTime(),
-                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())),
-                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())));
-                } else {
-                    result = ui->askFileRename(job,
-                                               i18n("File Already Exists"),
-                                               leftURL,
-                                               rightURL,
-                                               KIO::RenameDialog_Overwrite | KIO::RenameDialog_Skip | KIO::RenameDialog_MultipleItems,
-                                               newDest,
-                                               item->leftSize(),
-                                               item->rightSize(),
-                                               QDateTime(),
-                                               QDateTime(),
-                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())),
-                                               QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())));
-                }
-
-                switch (result) {
-                case KIO::Result_Rename:
-                    item->setDestination(newDest);
-                    executeTask(item);
-                    inTaskFinished--;
-                    return;
-                case KIO::Result_Overwrite:
-                    item->setOverWrite();
-                    executeTask(item);
-                    inTaskFinished--;
-                    return;
-                case KIO::Result_OverwriteAll:
-                    overWrite = true;
-                    executeTask(item);
-                    inTaskFinished--;
-                    return;
-                case KIO::Result_AutoSkip:
-                    autoSkip = true;
-                case KIO::Result_Skip:
-                default:
-                    break;
+                if (auto *askUserActionInterface = dynamic_cast<KIO::AskUserActionInterface *>(job->uiDelegate())) {
+                    auto renameSignal = &KIO::AskUserActionInterface::askUserRenameResult;
+                    QEventLoop loop;
+                    QObject::connect(askUserActionInterface, renameSignal, job, [=, this]( KIO::RenameDialog_Result result, const QUrl & newUrl, KJob *parentJob) {
+                        Q_ASSERT(parentJob == job);
+
+                        switch (result) {
+                        case KIO::Result_Rename:
+                            item->setDestination(newUrl.toString());
+                            executeTask(item);
+                            inTaskFinished--;
+                            return;
+                        case KIO::Result_Overwrite:
+                            item->setOverWrite();
+                            executeTask(item);
+                            inTaskFinished--;
+                            return;
+                        case KIO::Result_OverwriteAll:
+                            overWrite = true;
+                            executeTask(item);
+                            inTaskFinished--;
+                            return;
+                        case KIO::Result_AutoSkip:
+                            autoSkip = true;
+                        case KIO::Result_Skip:
+                        default:
+                            break;
+                        }
+                    });
+                    connect(askUserActionInterface, renameSignal, &loop, &QEventLoop::quit );
+                    //TODO: What is the correct call here?
+                    if (item->task() == TT_COPY_TO_LEFT) {
+                        askUserActionInterface->askUserRename(job,
+                                                i18n("File Already Exists"),
+                                                rightURL,
+                                                leftURL,
+                                                KIO::RenameDialog_Overwrite | KIO::RenameDialog_Skip | KIO::RenameDialog_MultipleItems,
+                                                item->rightSize(),
+                                                item->leftSize(),
+                                                QDateTime(),
+                                                QDateTime(),
+                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())),
+                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())));
+                    } else {
+                        askUserActionInterface->askUserRename(job,
+                                                i18n("File Already Exists"),
+                                                leftURL,
+                                                rightURL,
+                                                KIO::RenameDialog_Overwrite | KIO::RenameDialog_Skip | KIO::RenameDialog_MultipleItems,
+                                                item->leftSize(),
+                                                item->rightSize(),
+                                                QDateTime(),
+                                                QDateTime(),
+                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())),
+                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())));
+                    }
+                    // Wait till the quit the quit signal is emmited above, is this enough??
+                    loop.exec();
                 }
                 break;
             }
@@ -1402,20 +1409,27 @@ void Synchronizer::slotTaskFinished(KJob *job)
                     break;
                 }
 
-                auto *ui = dynamic_cast<KIO::JobUiDelegate *>(job->uiDelegate());
-                ui->setWindow(syncDlgWidget);
-
-                KIO::SkipDialog_Result result = ui->askSkip(job, KIO::SkipDialog_MultipleItems, error);
-
-                switch (result) {
-                case KIO::Result_Cancel:
-                    executeTask(item); /* simply retry */
-                    inTaskFinished--;
-                    return;
-                case KIO::Result_AutoSkip:
-                    autoSkip = true;
-                default:
-                    break;
+                if (auto *askUserActionInterface = dynamic_cast<KIO::AskUserActionInterface *>(job->uiDelegate())) {
+                    auto skipSignal = &KIO::AskUserActionInterface::askUserSkipResult;
+                    QEventLoop loop;
+                    QObject::connect(askUserActionInterface, skipSignal, job, [=, this](KIO::SkipDialog_Result result, KJob *parentJob) {
+                        Q_ASSERT(parentJob == job);
+
+                        switch (result) {
+                        case KIO::Result_Cancel:
+                            executeTask(item); /* simply retry */
+                            inTaskFinished--;
+                            return;
+                        case KIO::Result_AutoSkip:
+                            autoSkip = true;
+                        default:
+                            break;
+                        }
+                    });
+                    connect(askUserActionInterface, skipSignal, &loop, &QEventLoop::quit );
+                    askUserActionInterface->askUserSkip(job, KIO::SkipDialog_MultipleItems, error);
+                    // Wait till the quit the quit signal is emmited above, is this enough??
+                    loop.exec();
                 }
             }
         }
diff --git a/app/Synchronizer/synchronizerdirlist.cpp b/app/Synchronizer/synchronizerdirlist.cpp
index 360816955..7407d78c8 100644
--- a/app/Synchronizer/synchronizerdirlist.cpp
+++ b/app/Synchronizer/synchronizerdirlist.cpp
@@ -22,6 +22,7 @@
 
 #include <KFileItem>
 #include <KIO/JobUiDelegate>
+#include <KIO/ListJob>
 #include <KLocalizedString>
 #include <KMessageBox>
 
@@ -137,7 +138,7 @@ bool SynchronizerDirList::load(const QString &urlIn, bool wait)
         emit finished(result = true);
         return true;
     } else {
-        KIO::ListJob *job = KIO::listDir(KrServices::escapeFileUrl(url), KIO::HideProgressInfo, true);
+        KIO::ListJob *job = KIO::listDir(KrServices::escapeFileUrl(url), KIO::HideProgressInfo, KIO::ListJob::ListFlag::IncludeHidden);
         connect(job, &KIO::ListJob::entries, this, &SynchronizerDirList::slotEntries);
         connect(job, &KIO::ListJob::result, this, &SynchronizerDirList::slotListResult);
         busy = true;
diff --git a/app/Synchronizer/synchronizertask.h b/app/Synchronizer/synchronizertask.h
index dd1e282db..6b188156c 100644
--- a/app/Synchronizer/synchronizertask.h
+++ b/app/Synchronizer/synchronizertask.h
@@ -12,6 +12,7 @@
 #include <QObject>
 
 #include <KIO/Job>
+#include <KIO/TransferJob>
 
 class Synchronizer;
 class SynchronizerDirList;
diff --git a/app/krslots.cpp b/app/krslots.cpp
index 872e86e93..c89b3ccfd 100644
--- a/app/krslots.cpp
+++ b/app/krslots.cpp
@@ -21,6 +21,7 @@
 // QtWidgets
 #include <QApplication>
 
+#include <KIO/FileCopyJob>
 #include <KLocalizedString>
 #include <KMessageBox>
 #include <KSharedConfig>
-- 
GitLab


From 3c369cb7f4329934121fe5a7135e615f00b83852 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 10:55:39 +0300
Subject: [PATCH 18/68] Adapt to the new KBookmarkManager interface

---
 app/BookMan/krbookmarkhandler.cpp | 6 +++---
 app/BookMan/krbookmarkhandler.h   | 2 +-
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/app/BookMan/krbookmarkhandler.cpp b/app/BookMan/krbookmarkhandler.cpp
index 0b8944a86..a41dcdac0 100644
--- a/app/BookMan/krbookmarkhandler.cpp
+++ b/app/BookMan/krbookmarkhandler.cpp
@@ -69,7 +69,7 @@ KrBookmarkHandler::KrBookmarkHandler(KrMainWindow *mainWindow)
 
     // create bookmark manager
     QString filename = QStandardPaths::writableLocation(QStandardPaths::GenericDataLocation) + QLatin1Char('/') + BOOKMARKS_FILE;
-    manager = KBookmarkManager::managerForFile(filename, QStringLiteral("krusader"));
+    manager = new KBookmarkManager(filename);
     connect(manager, &KBookmarkManager::changed, this, &KrBookmarkHandler::bookmarksChanged);
 
     // create the quick search bar and action
@@ -393,7 +393,7 @@ void KrBookmarkHandler::buildMenu(KrBookmark *parent, QMenu *menu, int depth)
         newMenu->setTitle(bm->text());
         QAction *menuAction = menu->addMenu(newMenu);
         QVariant v;
-        v.setValue<KrBookmark *>(bm);
+        v.setValue(bm);
         menuAction->setData(v);
 
         buildMenu(bm, newMenu, depth + 1);
@@ -557,7 +557,7 @@ void KrBookmarkHandler::clearBookmarks(KrBookmark *root, bool removeBookmarks)
     }
 }
 
-void KrBookmarkHandler::bookmarksChanged(const QString &, const QString &)
+void KrBookmarkHandler::bookmarksChanged(const QString &)
 {
     importFromFile();
 }
diff --git a/app/BookMan/krbookmarkhandler.h b/app/BookMan/krbookmarkhandler.h
index 2dedde81b..0591803db 100644
--- a/app/BookMan/krbookmarkhandler.h
+++ b/app/BookMan/krbookmarkhandler.h
@@ -59,7 +59,7 @@ protected:
     void removeReferences(KrBookmark *root, KrBookmark *bmToRemove);
 
 protected slots:
-    void bookmarksChanged(const QString &, const QString &);
+    void bookmarksChanged(const QString &);
     void slotActivated(const QUrl &url);
 
 private:
-- 
GitLab


From 67c0dd53d25c3a8b05e89f4318146f5d972b1a1c Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Fri, 31 May 2024 22:48:11 +0300
Subject: [PATCH 19/68] QByteArray does not implicitly convert to char * for
 libc calls

data() needs to be explicity called or constData() in some cases
toLocal8bit also needs data() added.
---
 app/ActionMan/addplaceholderpopup.cpp | 34 +++++++++++++--------------
 app/FileSystem/defaultfilesystem.cpp  |  2 +-
 app/FileSystem/filesystemprovider.cpp |  2 +-
 app/Panel/panelfunc.cpp               |  8 +++----
 app/Splitter/combiner.cpp             |  2 +-
 app/Synchronizer/synchronizer.cpp     | 32 ++++++++++++-------------
 plugins/krarc/krarc.cpp               | 20 ++++++++--------
 7 files changed, 50 insertions(+), 50 deletions(-)

diff --git a/app/ActionMan/addplaceholderpopup.cpp b/app/ActionMan/addplaceholderpopup.cpp
index c50b24707..ac88b90c2 100644
--- a/app/ActionMan/addplaceholderpopup.cpp
+++ b/app/ActionMan/addplaceholderpopup.cpp
@@ -74,16 +74,16 @@ AddPlaceholderPopup::AddPlaceholderPopup(QWidget *parent)
             QAction *action;
 
             if (expander.placeholder(i)->needPanel()) {
-                action = _activeSub->addAction(i18n(expander.placeholder(i)->description().toUtf8()));
+                action = _activeSub->addAction(i18n(expander.placeholder(i)->description().toUtf8().data()));
                 action->setData(QVariant(i | ACTIVE_MASK));
-                action = _otherSub->addAction(i18n(expander.placeholder(i)->description().toUtf8()));
+                action = _otherSub->addAction(i18n(expander.placeholder(i)->description().toUtf8().data()));
                 action->setData(QVariant(i | OTHER_MASK));
-                action = _leftSub->addAction(i18n(expander.placeholder(i)->description().toUtf8()));
+                action = _leftSub->addAction(i18n(expander.placeholder(i)->description().toUtf8().data()));
                 action->setData(QVariant(i | LEFT_MASK));
-                action = _rightSub->addAction(i18n(expander.placeholder(i)->description().toUtf8()));
+                action = _rightSub->addAction(i18n(expander.placeholder(i)->description().toUtf8().data()));
                 action->setData(QVariant(i | RIGHT_MASK));
             } else {
-                action = _independentSub->addAction(i18n(expander.placeholder(i)->description().toUtf8()));
+                action = _independentSub->addAction(i18n(expander.placeholder(i)->description().toUtf8().data()));
                 action->setData(QVariant(i | INDEPENDENT_MASK));
             }
         }
@@ -252,7 +252,7 @@ ParameterText::ParameterText(const exp_parameter &parameter, QWidget *parent)
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     layout->addWidget(_lineEdit = new KLineEdit(parameter.preset(), this));
     _preset = parameter.preset();
 }
@@ -285,7 +285,7 @@ ParameterPlaceholder::ParameterPlaceholder(const exp_parameter &parameter, QWidg
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     QWidget *hboxWidget = new QWidget(this);
     layout->addWidget(hboxWidget);
     auto *hbox = new QHBoxLayout(hboxWidget);
@@ -335,7 +335,7 @@ ParameterYes::ParameterYes(const exp_parameter &parameter, QWidget *parent)
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(_checkBox = new QCheckBox(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(_checkBox = new QCheckBox(i18n(parameter.description().toUtf8().data()), this));
     _checkBox->setChecked(true);
 }
 
@@ -367,7 +367,7 @@ ParameterNo::ParameterNo(const exp_parameter &parameter, QWidget *parent)
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(_checkBox = new QCheckBox(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(_checkBox = new QCheckBox(i18n(parameter.description().toUtf8().data()), this));
     _checkBox->setChecked(false);
 }
 
@@ -399,7 +399,7 @@ ParameterFile::ParameterFile(const exp_parameter &parameter, QWidget *parent)
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
 
     QWidget *hboxWidget = new QWidget(this);
     layout->addWidget(hboxWidget);
@@ -448,7 +448,7 @@ ParameterChoose::ParameterChoose(const exp_parameter &parameter, QWidget *parent
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     layout->addWidget(_combobox = new KComboBox(this));
     _combobox->addItems(parameter.preset().section(':', 1).split(';'));
 }
@@ -478,7 +478,7 @@ ParameterSelect::ParameterSelect(const exp_parameter &parameter, QWidget *parent
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     layout->addWidget(_combobox = new KComboBox(this));
     _combobox->setEditable(true);
 
@@ -515,7 +515,7 @@ ParameterGoto::ParameterGoto(const exp_parameter &parameter, QWidget *parent)
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
 
     QWidget *hboxWidget = new QWidget(this);
     auto *hbox = new QHBoxLayout(hboxWidget);
@@ -578,7 +578,7 @@ ParameterSyncprofile::ParameterSyncprofile(const exp_parameter &parameter, QWidg
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     layout->addWidget(_combobox = new KComboBox(this));
 
     _combobox->addItems(ProfileManager::availableProfiles("SynchronizerProfile"));
@@ -609,7 +609,7 @@ ParameterSearch::ParameterSearch(const exp_parameter &parameter, QWidget *parent
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     layout->addWidget(_combobox = new KComboBox(this));
 
     _combobox->addItems(ProfileManager::availableProfiles("SearcherProfile"));
@@ -640,7 +640,7 @@ ParameterPanelprofile::ParameterPanelprofile(const exp_parameter &parameter, QWi
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     layout->addWidget(_combobox = new KComboBox(this));
 
     _combobox->addItems(ProfileManager::availableProfiles("Panel"));
@@ -671,7 +671,7 @@ ParameterInt::ParameterInt(const exp_parameter &parameter, QWidget *parent)
     layout->setSpacing(6);
     layout->setContentsMargins(0, 0, 0, 0);
 
-    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8()), this));
+    layout->addWidget(new QLabel(i18n(parameter.description().toUtf8().data()), this));
     layout->addWidget(_spinbox = new QSpinBox(this));
     QStringList para = parameter.preset().section(':', 1).split(';');
 
diff --git a/app/FileSystem/defaultfilesystem.cpp b/app/FileSystem/defaultfilesystem.cpp
index a446df634..2a8584392 100644
--- a/app/FileSystem/defaultfilesystem.cpp
+++ b/app/FileSystem/defaultfilesystem.cpp
@@ -347,7 +347,7 @@ bool DefaultFileSystem::refreshLocal(const QUrl &directory, bool onlyScan)
     // Note: we are using low-level Qt functions here.
     // It's around twice as fast as using the QDir class.
 
-    QT_DIR *dir = QT_OPENDIR(path.toLocal8Bit());
+    QT_DIR *dir = QT_OPENDIR(path.toLocal8Bit().data());
     if (!dir) {
         emit error(i18n("Cannot open the folder %1.", path));
         return false;
diff --git a/app/FileSystem/filesystemprovider.cpp b/app/FileSystem/filesystemprovider.cpp
index 1ca72af04..0d0f47282 100644
--- a/app/FileSystem/filesystemprovider.cpp
+++ b/app/FileSystem/filesystemprovider.cpp
@@ -172,7 +172,7 @@ QString FileSystemProvider::getACL(const QString &path, int type)
 #ifdef HAVE_POSIX_ACL
     acl_t acl = nullptr;
     // do we have an acl for the file, and/or a default acl for the dir, if it is one?
-    if ((acl = acl_get_file(path.toLocal8Bit(), type)) != nullptr) {
+    if ((acl = acl_get_file(path.toLocal8Bit().constData(), type)) != nullptr) {
         bool aclExtended = false;
 
 #ifdef HAVE_NON_POSIX_ACL_EXTENSIONS
diff --git a/app/Panel/panelfunc.cpp b/app/Panel/panelfunc.cpp
index 3837070d5..718257b81 100644
--- a/app/Panel/panelfunc.cpp
+++ b/app/Panel/panelfunc.cpp
@@ -386,12 +386,12 @@ void ListPanelFunc::redirectLink()
     if (!ok || newLink == currentLink)
         return;
     // delete the current link
-    if (unlink(file.toLocal8Bit()) == -1) {
+    if (unlink(file.toLocal8Bit().data()) == -1) {
         KMessageBox::error(krMainWindow, i18n("Cannot remove old link: %1", file));
         return;
     }
     // try to create a new symlink
-    if (symlink(newLink.toLocal8Bit(), file.toLocal8Bit()) == -1) {
+    if (symlink(newLink.toLocal8Bit().data(), file.toLocal8Bit().data()) == -1) {
         KMessageBox::/* --=={ Patch by Heiner <h.eichmann@gmx.de> }==-- */ error(krMainWindow, i18n("Failed to create a new link: %1", file));
         return;
     }
@@ -426,10 +426,10 @@ void ListPanelFunc::krlink(bool sym)
     name = files()->getUrl(name).path();
 
     if (sym) {
-        if (symlink(name.toLocal8Bit(), linkName.toLocal8Bit()) == -1)
+        if (symlink(name.toLocal8Bit().data(), linkName.toLocal8Bit().data()) == -1)
             KMessageBox::error(krMainWindow, i18n("Failed to create a new symlink '%1' to: '%2'", linkName, name));
     } else {
-        if (link(name.toLocal8Bit(), linkName.toLocal8Bit()) == -1)
+        if (link(name.toLocal8Bit().data(), linkName.toLocal8Bit().data()) == -1)
             KMessageBox::error(krMainWindow, i18n("Failed to create a new link '%1' to '%2'", linkName, name));
     }
 }
diff --git a/app/Splitter/combiner.cpp b/app/Splitter/combiner.cpp
index 58d05e7d4..3265bb8ef 100644
--- a/app/Splitter/combiner.cpp
+++ b/app/Splitter/combiner.cpp
@@ -124,7 +124,7 @@ void Combiner::combineSplitFileFinished(KJob *job)
                 hasFileName = true;
             } else if (token == "size") {
                 // FIXME - don't use c functions !!!
-                sscanf(value.trimmed().toLocal8Bit(), "%llu", &expectedSize);
+                sscanf(value.trimmed().toLocal8Bit().data(), "%llu", &expectedSize);
                 hasSize = true;
             }
             if (token == "crc32") {
diff --git a/app/Synchronizer/synchronizer.cpp b/app/Synchronizer/synchronizer.cpp
index 7735d9693..cd70a12e9 100644
--- a/app/Synchronizer/synchronizer.cpp
+++ b/app/Synchronizer/synchronizer.cpp
@@ -1241,33 +1241,33 @@ void Synchronizer::slotTaskFinished(KJob *job)
                     timestamp.actime = time(nullptr);
                     timestamp.modtime = item->rightDate() - timeOffset;
 
-                    utime((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), &timestamp);
+                    utime((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), &timestamp);
 
                     auto newOwnerID = (uid_t)-1; // chown(2) : -1 means no change
                     if (!item->rightOwner().isEmpty()) {
-                        struct passwd *pw = getpwnam(QFile::encodeName(item->rightOwner()));
+                        struct passwd *pw = getpwnam(QFile::encodeName(item->rightOwner()).data());
                         if (pw != nullptr)
                             newOwnerID = pw->pw_uid;
                     }
                     auto newGroupID = (gid_t)-1; // chown(2) : -1 means no change
                     if (!item->rightGroup().isEmpty()) {
-                        struct group *g = getgrnam(QFile::encodeName(item->rightGroup()));
+                        struct group *g = getgrnam(QFile::encodeName(item->rightGroup()).data());
                         if (g != nullptr)
                             newGroupID = g->gr_gid;
                     }
-                    int status1 = chown((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), newOwnerID, (gid_t)-1);
-                    int status2 = chown((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), (uid_t)-1, newGroupID);
+                    int status1 = chown((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), newOwnerID, (gid_t)-1);
+                    int status2 = chown((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), (uid_t)-1, newGroupID);
                     if (status1 < 0 || status2 < 0) {
                         // synchronizer currently ignores chown errors
                     }
 
-                    chmod((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), item->rightMode() & 07777);
+                    chmod((const char *)(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), item->rightMode() & 07777);
 
 #ifdef HAVE_POSIX_ACL
                     if (!item->rightACL().isNull()) {
-                        acl_t acl = acl_from_text(item->rightACL().toLatin1());
+                        acl_t acl = acl_from_text(item->rightACL().toLatin1().data());
                         if (acl && !acl_valid(acl))
-                            acl_set_file(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit(), ACL_TYPE_ACCESS, acl);
+                            acl_set_file(leftURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data(), ACL_TYPE_ACCESS, acl);
                         if (acl)
                             acl_free(acl);
                     }
@@ -1281,33 +1281,33 @@ void Synchronizer::slotTaskFinished(KJob *job)
                     timestamp.actime = time(nullptr);
                     timestamp.modtime = item->leftDate() + timeOffset;
 
-                    utime((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), &timestamp);
+                    utime((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), &timestamp);
 
                     auto newOwnerID = (uid_t)-1; // chown(2) : -1 means no change
                     if (!item->leftOwner().isEmpty()) {
-                        struct passwd *pw = getpwnam(QFile::encodeName(item->leftOwner()));
+                        struct passwd *pw = getpwnam(QFile::encodeName(item->leftOwner()).data());
                         if (pw != nullptr)
                             newOwnerID = pw->pw_uid;
                     }
                     auto newGroupID = (gid_t)-1; // chown(2) : -1 means no change
                     if (!item->leftGroup().isEmpty()) {
-                        struct group *g = getgrnam(QFile::encodeName(item->leftGroup()));
+                        struct group *g = getgrnam(QFile::encodeName(item->leftGroup()).data());
                         if (g != nullptr)
                             newGroupID = g->gr_gid;
                     }
-                    int status1 = chown((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), newOwnerID, (uid_t)-1);
-                    int status2 = chown((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), (uid_t)-1, newGroupID);
+                    int status1 = chown((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), newOwnerID, (uid_t)-1);
+                    int status2 = chown((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), (uid_t)-1, newGroupID);
                     if (status1 < 0 || status2 < 0) {
                         // synchronizer currently ignores chown errors
                     }
 
-                    chmod((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit()), item->leftMode() & 07777);
+                    chmod((const char *)(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data()), item->leftMode() & 07777);
 
 #ifdef HAVE_POSIX_ACL
                     if (!item->leftACL().isNull()) {
-                        acl_t acl = acl_from_text(item->leftACL().toLatin1());
+                        acl_t acl = acl_from_text(item->leftACL().toLatin1().data());
                         if (acl && !acl_valid(acl))
-                            acl_set_file(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit(), ACL_TYPE_ACCESS, acl);
+                            acl_set_file(rightURL.adjusted(QUrl::StripTrailingSlash).path().toLocal8Bit().data(), ACL_TYPE_ACCESS, acl);
                         if (acl)
                             acl_free(acl);
                     }
diff --git a/plugins/krarc/krarc.cpp b/plugins/krarc/krarc.cpp
index 4d2355564..8c56c4051 100644
--- a/plugins/krarc/krarc.cpp
+++ b/plugins/krarc/krarc.cpp
@@ -265,7 +265,7 @@ KIO::WorkerResult kio_krarcProtocol::mkdir(const QUrl &url, int permissions)
     for (int i = 0; i < tempDir.length() && i >= 0; i = tempDir.indexOf(DIR_SEPARATOR, i + 1)) {
         QByteArray newDirs = encodeString(tempDir.left(i));
         newDirs.prepend(arcTempDirEnc);
-        QT_MKDIR(newDirs, permissions);
+        QT_MKDIR(newDirs.constData(), permissions);
     }
 
     if (tempDir.endsWith(DIR_SEPARATOR))
@@ -338,14 +338,14 @@ KIO::WorkerResult kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::
     for (int i = 0; i < tempDir.length() && i >= 0; i = tempDir.indexOf(DIR_SEPARATOR, i + 1)) {
         QByteArray newDirs = encodeString(tempDir.left(i));
         newDirs.prepend(arcTempDirEnc);
-        QT_MKDIR(newDirs, 0755);
+        QT_MKDIR(newDirs.constData(), 0755);
     }
 
     int fd;
     if (resume) {
         QByteArray ba = encodeString(tempFile);
         ba.prepend(arcTempDirEnc);
-        fd = QT_OPEN(ba, O_RDWR); // append if resuming
+        fd = QT_OPEN(ba.constData(), O_RDWR); // append if resuming
         QT_LSEEK(fd, 0, SEEK_END); // Seek to end
     } else {
         // WABA: Make sure that we keep writing permissions ourselves,
@@ -358,7 +358,7 @@ KIO::WorkerResult kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::
 
         QByteArray ba = encodeString(tempFile);
         ba.prepend(arcTempDirEnc);
-        fd = QT_OPEN(ba, O_CREAT | O_TRUNC | O_WRONLY, initialMode);
+        fd = QT_OPEN(ba.constData(), O_CREAT | O_TRUNC | O_WRONLY, initialMode);
     }
 
     QByteArray buffer;
@@ -367,7 +367,7 @@ KIO::WorkerResult kio_krarcProtocol::put(const QUrl &url, int permissions, KIO::
     do {
         dataReq();
         readResult = readData(buffer);
-        auto bytesWritten = ::write(fd, buffer.data(), buffer.size());
+        auto bytesWritten = ::write(fd, buffer.constData(), buffer.size());
         if (bytesWritten < buffer.size()) {
             isIncomplete = true;
             break;
@@ -533,7 +533,7 @@ KIO::WorkerResult kio_krarcProtocol::get(const QUrl &url, int tries)
         // $Id: krarc.cpp,v 1.43 2007/01/13 13:39:51 ckarai Exp $
         QByteArray _path(QFile::encodeName(arcTempDir + file));
         QT_STATBUF buff;
-        if (QT_LSTAT(_path.data(), &buff) == -1) {
+        if (QT_LSTAT(_path.constData(), &buff) == -1) {
             if (errno == EACCES)
                 return WorkerResult::fail(KIO::ERR_ACCESS_DENIED, getPath(url));
             return WorkerResult::fail(KIO::ERR_DOES_NOT_EXIST, getPath(url));
@@ -544,7 +544,7 @@ KIO::WorkerResult kio_krarcProtocol::get(const QUrl &url, int tries)
         if (!S_ISREG(buff.st_mode)) {
             return WorkerResult::fail(KIO::ERR_CANNOT_OPEN_FOR_READING, getPath(url));
         }
-        int fd = QT_OPEN(_path.data(), O_RDONLY);
+        int fd = QT_OPEN(_path.constData(), O_RDONLY);
         if (fd < 0) {
             return WorkerResult::fail(KIO::ERR_CANNOT_OPEN_FOR_READING, getPath(url));
         }
@@ -680,7 +680,7 @@ KIO::WorkerResult kio_krarcProtocol::stat(const QUrl &url)
     // we might be stating a real file
     if (QFileInfo::exists(path)) {
         QT_STATBUF buff;
-        QT_STAT(path.toLocal8Bit(), &buff);
+        QT_STAT(path.toLocal8Bit().constData(), &buff);
         QString mime;
         QMimeDatabase db;
         QMimeType result = db.mimeTypeForFile(path);
@@ -970,7 +970,7 @@ bool kio_krarcProtocol::setArcFile(const QUrl &url)
             QFileInfo qfi(newPath.left(pos));
             if (qfi.exists() && !qfi.isDir()) {
                 QT_STATBUF stat_p;
-                QT_LSTAT(newPath.left(pos).toLocal8Bit(), &stat_p);
+                QT_LSTAT(newPath.left(pos).toLocal8Bit().constData(), &stat_p);
                 arcFile = new KFileItem(QUrl::fromLocalFile(newPath.left(pos)), QString(), stat_p.st_mode);
                 break;
             }
@@ -2027,7 +2027,7 @@ QString kio_krarcProtocol::localeEncodedString(QString str)
     int size = array.size();
     QString result;
 
-    const char *data = array.data();
+    const char *data = array.constData();
     for (int i = 0; i != size; i++) {
         unsigned int ch = (((int)data[i]) & 0xFF) + 0xE000; // user defined character
         result.append(QChar(ch));
-- 
GitLab


From 0cc6a86fd97e7a5fc6d00f46008bce00b8e3369d Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:01:27 +0300
Subject: [PATCH 20/68] QString/QChar inconsitencies

char also doesn't cast to QChar implicitly
---
 app/KViewer/lister.cpp                   | 2 +-
 app/Panel/PanelView/krsort.cpp           | 4 ++--
 app/Splitter/combiner.cpp                | 2 +-
 app/Synchronizer/synchronizerdirlist.cpp | 2 +-
 4 files changed, 5 insertions(+), 5 deletions(-)

diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index 8e06b092e..f15dfa3a4 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -2096,7 +2096,7 @@ QStringList Lister::readLines(qint64 &filePos, const qint64 endPos, const int co
         }
 
         // replace unreadable characters
-        if ((chr[0] < 32) && (chr[0] != '\n') && (chr[0] != '\t')) {
+        if ((chr[0] < QChar(32)) && (chr[0] != '\n') && (chr[0] != '\t')) {
             chr = QChar(' ');
         }
 
diff --git a/app/Panel/PanelView/krsort.cpp b/app/Panel/PanelView/krsort.cpp
index 862b2a014..bdd18d4c5 100644
--- a/app/Panel/PanelView/krsort.cpp
+++ b/app/Panel/PanelView/krsort.cpp
@@ -119,8 +119,8 @@ bool compareTextsAlphabetical(QString &aS1, QString &aS2, const KrViewProperties
             if (j != 0)
                 return j < 0;
         } else if (lUseLocaleAware
-                   && ((lchar1 >= 128 && ((lchar2 >= 'A' && lchar2 <= 'Z') || (lchar2 >= 'a' && lchar2 <= 'z') || lchar2 >= 128))
-                       || (lchar2 >= 128 && ((lchar1 >= 'A' && lchar1 <= 'Z') || (lchar1 >= 'a' && lchar1 <= 'z') || lchar1 >= 128)))) {
+                   && ((lchar1 >= QChar(128) && ((lchar2 >= 'A' && lchar2 <= 'Z') || (lchar2 >= 'a' && lchar2 <= 'z') || lchar2 >= QChar(128)))
+                       || (lchar2 >= QChar(128) && ((lchar1 >= 'A' && lchar1 <= 'Z') || (lchar1 >= 'a' && lchar1 <= 'z') || lchar1 >= QChar(128))))) {
             // use localeAwareCompare when a unicode character is encountered
             j = QString::localeAwareCompare(lchar1, lchar2);
             if (j != 0)
diff --git a/app/Splitter/combiner.cpp b/app/Splitter/combiner.cpp
index 3265bb8ef..605f91514 100644
--- a/app/Splitter/combiner.cpp
+++ b/app/Splitter/combiner.cpp
@@ -210,7 +210,7 @@ void Combiner::openNextFile()
             QChar ch;
 
             do {
-                ch = name.at(pos).toLatin1() + 1;
+                ch = QChar(name.at(pos).toLatin1() + 1);
                 if (ch == QChar('Z' + 1))
                     ch = 'A';
                 if (ch == QChar('z' + 1))
diff --git a/app/Synchronizer/synchronizerdirlist.cpp b/app/Synchronizer/synchronizerdirlist.cpp
index 7407d78c8..3f7025f67 100644
--- a/app/Synchronizer/synchronizerdirlist.cpp
+++ b/app/Synchronizer/synchronizerdirlist.cpp
@@ -112,7 +112,7 @@ bool SynchronizerDirList::load(const QString &urlIn, bool wait)
     if (url.isLocalFile()) {
         const QString dir = FileSystem::ensureTrailingSlash(url).path();
 
-        QT_DIR *qdir = QT_OPENDIR(dir.toLocal8Bit());
+        QT_DIR *qdir = QT_OPENDIR(dir.toLocal8Bit().data());
         if (!qdir) {
             KMessageBox::error(parentWidget, i18n("Cannot open the folder %1.", dir), i18n("Error"));
             emit finished(result = false);
-- 
GitLab


From 54443575977d4aa024982ce6e398fa4d013de625 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:03:53 +0300
Subject: [PATCH 21/68] Implement the = operator for PredefinedDevice

---
 app/Splitter/splittergui.cpp | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/app/Splitter/splittergui.cpp b/app/Splitter/splittergui.cpp
index 962a2e0b4..705468682 100644
--- a/app/Splitter/splittergui.cpp
+++ b/app/Splitter/splittergui.cpp
@@ -43,7 +43,10 @@ struct SplitterGUI::PredefinedDevice {
         , capacity(other.capacity)
     {
     }
-    PredefinedDevice &operator=(const PredefinedDevice &other);
+    PredefinedDevice &operator=(const PredefinedDevice &other)
+    {
+        return *this;
+    }
 
     QString name;
     KIO::filesize_t capacity;
-- 
GitLab


From f5834234773cb6fb1962d3b06e09635b14e25b84 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:07:30 +0300
Subject: [PATCH 22/68] Updaters for QAbstractItemView

The virtual viewOptions() method that previously returned a
QStyleOptionViewItem object has been renamed to initViewItemOption, and
initializes a QStyleOptionViewItem object that's passed in through a
pointer.

https://doc.qt.io/qt-6/widgets-changes-qt6.html
---
 app/GUI/krtreewidget.cpp                 | 3 ++-
 app/Panel/PanelView/krinterbriefview.cpp | 3 ++-
 2 files changed, 4 insertions(+), 2 deletions(-)

diff --git a/app/GUI/krtreewidget.cpp b/app/GUI/krtreewidget.cpp
index 48b069a59..95f98fe0c 100644
--- a/app/GUI/krtreewidget.cpp
+++ b/app/GUI/krtreewidget.cpp
@@ -167,7 +167,8 @@ bool KrTreeWidget::event(QEvent *event)
 
                 QIcon icon = item->icon(column);
                 if (!icon.isNull()) {
-                    QStyleOptionViewItem opts = viewOptions();
+                    QStyleOptionViewItem opts;
+                    initViewItemOption(&opts);
                     QSize iconSize = icon.actualSize(opts.decorationSize);
                     requiredWidth += iconSize.width();
 
diff --git a/app/Panel/PanelView/krinterbriefview.cpp b/app/Panel/PanelView/krinterbriefview.cpp
index f2e690dc6..1759d5078 100644
--- a/app/Panel/PanelView/krinterbriefview.cpp
+++ b/app/Panel/PanelView/krinterbriefview.cpp
@@ -390,7 +390,8 @@ bool KrInterBriefView::isIndexHidden(const QModelIndex &ndx) const
 
 void KrInterBriefView::paintEvent(QPaintEvent *e)
 {
-    QStyleOptionViewItem option = viewOptions();
+    QStyleOptionViewItem option;
+    initViewItemOption(&option);
     option.widget = this;
     option.decorationSize = QSize(_fileIconSize, _fileIconSize);
     option.decorationPosition = QStyleOptionViewItem::Left;
-- 
GitLab


From 1a7804ba2e70a08c0a739f82bceeb678061a6b44 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:11:23 +0300
Subject: [PATCH 23/68] Change to new QLocale

---
 app/KViewer/lister.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index f15dfa3a4..bba78a2da 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -1998,7 +1998,7 @@ void Lister::print()
     QPainter painter;
     painter.begin(&printer);
 
-    const QString dateString = QDate::currentDate().toString(Qt::SystemLocaleShortDate);
+    const QString dateString = QLocale().toString(QDate::currentDate(), QLocale::ShortFormat);
 
 #if QT_VERSION >= QT_VERSION_CHECK(5, 15, 0)
     const QRect pageRect = printer.pageLayout().paintRectPixels(printer.resolution());
-- 
GitLab


From b92b3ba1411067d0c491df4a43f2f10aee3395bf Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:11:55 +0300
Subject: [PATCH 24/68] Update KViewer to the new KPart creation code

The new code should use KParts/PartLoader rather than KService
---
 app/KViewer/panelviewer.cpp | 57 +------------------------------------
 app/KViewer/panelviewer.h   |  2 +-
 2 files changed, 2 insertions(+), 57 deletions(-)

diff --git a/app/KViewer/panelviewer.cpp b/app/KViewer/panelviewer.cpp
index 98e762f37..ec2f3407e 100644
--- a/app/KViewer/panelviewer.cpp
+++ b/app/KViewer/panelviewer.cpp
@@ -16,27 +16,16 @@
 
 #include <kservice_version.h>
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 82, 0)
-#define CREATE_KPART_5_82 1
-#else
-#define CREATE_KPART_5_82 0
-#endif
-
 #include <KLocalizedString>
 #include <KParts/NavigationExtension>
 #include <KParts/ReadWritePart>
 #include <KSharedConfig>
-
-#if CREATE_KPART_5_82
 #include <KParts/PartLoader>
-#endif
 #include <KIO/StatJob>
 #include <KService>
 
 #include <KFileItem>
 #include <KMessageBox>
-#include <KMimeTypeTrader>
-#include <KServiceTypeProfile>
 
 #include "../defaults.h"
 #include "lister.h"
@@ -158,8 +147,7 @@ KParts::ReadOnlyPart *PanelViewer::getHexPart()
             // Okteta >= 0.26 provides a desktop file, prefer that as the binary changes name
             KService::Ptr service = KService::serviceByDesktopName("oktetapart");
             if (service) {
-                KPluginName name = *service.data();
-                factory = KPluginFactory::loadFactory(name.name()).plugin;
+                factory = KPluginFactory::loadFactory(service.data()->name()).plugin;
             } else {
                 // fallback to search for desktopfile-less old variant
                 factory = KPluginFactory::loadFactory(QStringLiteral("oktetapart")).plugin;
@@ -281,11 +269,7 @@ void PanelViewer::openFile(KFileItem fi)
             qDebug() << "openFile completed: '" << curl << "'";
         };
         connect(cpart.data(), QOverload<>::of(&KParts::ReadOnlyPart::completed), this, cPartCompleted);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 81, 0)
         connect(cpart.data(), &KParts::ReadOnlyPart::completedWithPendingAction, this, cPartCompleted);
-#else
-        connect(cpart.data(), QOverload<bool>::of(&KParts::ReadOnlyPart::completed), this, cPartCompleted);
-#endif
 
         // Note: Don't rely on return value of openUrl as the call is async in general
         cpart->openUrl(curl);
@@ -307,8 +291,6 @@ bool PanelViewer::closeUrl()
     return false;
 }
 
-#if CREATE_KPART_5_82
-
 template<typename T>
 static T *createKPartForMimeType(QString mimetype, QWidget *parentWidget)
 {
@@ -324,27 +306,11 @@ static T *createKPartForMimeType(QString mimetype, QWidget *parentWidget)
     return pluginFactory->create<T>(parentWidget, parentWidget);
 }
 
-#endif // CREATE_KPART_5_82
-
 KParts::ReadOnlyPart *PanelViewer::createPart(QString mimetype)
 {
     KParts::ReadOnlyPart *part = nullptr;
 
-#if CREATE_KPART_5_82
     part = createKPartForMimeType<KParts::ReadOnlyPart>(mimetype, this);
-#else
-    KService::Ptr ptr = KMimeTypeTrader::self()->preferredService(mimetype, "KParts/ReadOnlyPart");
-    if (ptr) {
-        QVariantList args;
-        QVariant argsProp = ptr->property("X-KDE-BrowserView-Args");
-        if (argsProp.isValid())
-            args << argsProp;
-        QVariant prop = ptr->property("X-KDE-BrowserView-AllowAsDefault");
-        if (!prop.isValid() || prop.toBool()) // defaults to true
-            part = ptr->createInstance<KParts::ReadOnlyPart>(this, this, args);
-    }
-#endif
-
     if (part) {
         KParts::NavigationExtension *ext = KParts::NavigationExtension::childObject(part);
         if (ext) {
@@ -368,14 +334,7 @@ void PanelEditor::configureDeps()
 {
     bool foundPlugin = false;
 
-#if CREATE_KPART_5_82
     foundPlugin = !KParts::PartLoader::partsForMimeType("text/plain").isEmpty();
-#else
-    KService::Ptr ptr = KMimeTypeTrader::self()->preferredService("text/plain", "KParts/ReadWritePart");
-    if (!ptr)
-        ptr = KMimeTypeTrader::self()->preferredService("all/allfiles", "KParts/ReadWritePart");
-    foundPlugin = (ptr != nullptr);
-#endif
 
     if (!foundPlugin)
         KMessageBox::error(nullptr, missingKPartMsg(), i18n("Missing Plugin"), KMessageBox::AllowLink);
@@ -458,21 +417,7 @@ KParts::ReadOnlyPart *PanelEditor::createPart(QString mimetype)
 {
     KParts::ReadWritePart *part = nullptr;
 
-#if CREATE_KPART_5_82
     part = createKPartForMimeType<KParts::ReadWritePart>(mimetype, this);
-#else
-    KService::Ptr ptr = KMimeTypeTrader::self()->preferredService(mimetype, "KParts/ReadWritePart");
-    if (ptr) {
-        QVariantList args;
-        QVariant argsProp = ptr->property("X-KDE-BrowserView-Args");
-        if (argsProp.isValid())
-            args << argsProp;
-        QVariant prop = ptr->property("X-KDE-BrowserView-AllowAsDefault");
-        if (!prop.isValid() || prop.toBool()) // defaults to true
-            part = ptr->createInstance<KParts::ReadWritePart>(this, this, args);
-    }
-#endif
-
     if (part) {
         KParts::NavigationExtension *ext = KParts::NavigationExtension::childObject(part);
         if (ext) {
diff --git a/app/KViewer/panelviewer.h b/app/KViewer/panelviewer.h
index 659b314bb..dde146b10 100644
--- a/app/KViewer/panelviewer.h
+++ b/app/KViewer/panelviewer.h
@@ -16,7 +16,7 @@
 // QtWidgets
 #include <QLabel>
 #include <QStackedWidget>
-
+#include <KFileItem>
 #include <KParts/Part>
 
 #include "krviewer.h"
-- 
GitLab


From 2ef1b87fe283ebb6ccb5fd4adfb249af7c497d9d Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:12:17 +0300
Subject: [PATCH 25/68] Use the new QRegExp API

---
 app/Locate/locate.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/Locate/locate.cpp b/app/Locate/locate.cpp
index 1235cb17e..f73045840 100644
--- a/app/Locate/locate.cpp
+++ b/app/Locate/locate.cpp
@@ -601,7 +601,7 @@ bool LocateDlg::find()
         QString item = findCurrentItem->text(0);
 
         if (findOptions & KFind::RegularExpression) {
-            if (item.contains(QRegExp(findPattern, ((findOptions & KFind::CaseSensitive) != 0) ? Qt::CaseSensitive : Qt::CaseInsensitive)))
+            if (QRegExp(findPattern, ((findOptions & KFind::CaseSensitive) != 0) ? Qt::CaseSensitive : Qt::CaseInsensitive).indexIn(item) >= 0)
                 return true;
         } else {
             if (item.contains(findPattern, ((findOptions & KFind::CaseSensitive) != 0) ? Qt::CaseSensitive : Qt::CaseInsensitive))
-- 
GitLab


From fe2257b07cfea76c46942c15b93e8752e80e6d06 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:13:05 +0300
Subject: [PATCH 26/68] QPalette enums have changed

Use Background instead of Window
---
 app/Panel/PanelView/krinterbriefview.cpp    | 2 +-
 app/Panel/PanelView/krinterdetailedview.cpp | 2 +-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/app/Panel/PanelView/krinterbriefview.cpp b/app/Panel/PanelView/krinterbriefview.cpp
index 1759d5078..f1a4d99cb 100644
--- a/app/Panel/PanelView/krinterbriefview.cpp
+++ b/app/Panel/PanelView/krinterbriefview.cpp
@@ -416,7 +416,7 @@ void KrInterBriefView::paintEvent(QPaintEvent *e)
             QStyleOptionFocusRect o;
             o.QStyleOption::operator=(option);
             QPalette::ColorGroup cg = QPalette::Normal;
-            o.backgroundColor = option.palette.color(cg, QPalette::Background);
+            o.backgroundColor = option.palette.color(cg, QPalette::Window);
 
             style()->drawPrimitive(QStyle::PE_FrameFocusRect, &o, &painter);
         }
diff --git a/app/Panel/PanelView/krinterdetailedview.cpp b/app/Panel/PanelView/krinterdetailedview.cpp
index 7604a73c7..cbffff727 100644
--- a/app/Panel/PanelView/krinterdetailedview.cpp
+++ b/app/Panel/PanelView/krinterdetailedview.cpp
@@ -408,7 +408,7 @@ void KrInterDetailedView::drawRow(QPainter *painter, const QStyleOptionViewItem
     // QTreeView::drawRow() only when panel is focused, we have to repeat it here.
     if (index == currentIndex() && drawCurrent()) {
         QStyleOptionFocusRect o;
-        o.backgroundColor = options.palette.color(QPalette::Normal, QPalette::Background);
+        o.backgroundColor = options.palette.color(QPalette::Normal, QPalette::Window);
 
         const QRect focusRect(0, options.rect.y(), header()->length(), options.rect.height());
         o.rect = style()->visualRect(layoutDirection(), viewport()->rect(), focusRect);
-- 
GitLab


From 2128ff3249371f918b0e2533850882771dcdd03e Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:30:03 +0300
Subject: [PATCH 27/68] Add missing headers

Remove some too
---
 app/Panel/PanelView/krinterbriefview.cpp    | 2 +-
 app/Panel/PanelView/krinterdetailedview.cpp | 2 +-
 app/Panel/krfiletreeview.cpp                | 5 ++++-
 app/Panel/krpanel.cpp                       | 1 +
 app/Panel/krpreviews.h                      | 1 +
 app/Panel/panelcontextmenu.cpp              | 2 +-
 app/UserAction/useraction.h                 | 1 -
 7 files changed, 9 insertions(+), 5 deletions(-)

diff --git a/app/Panel/PanelView/krinterbriefview.cpp b/app/Panel/PanelView/krinterbriefview.cpp
index f1a4d99cb..3c1a9d3b7 100644
--- a/app/Panel/PanelView/krinterbriefview.cpp
+++ b/app/Panel/PanelView/krinterbriefview.cpp
@@ -19,7 +19,7 @@
 #include <QRegion>
 // QtWidgets
 #include <QApplication>
-#include <QDirModel>
+#include <QFileSystemModel>
 #include <QMenu>
 #include <QScrollBar>
 
diff --git a/app/Panel/PanelView/krinterdetailedview.cpp b/app/Panel/PanelView/krinterdetailedview.cpp
index cbffff727..bda2e08dd 100644
--- a/app/Panel/PanelView/krinterdetailedview.cpp
+++ b/app/Panel/PanelView/krinterdetailedview.cpp
@@ -14,7 +14,7 @@
 #include <QHashIterator>
 // QtWidgets
 #include <QApplication>
-#include <QDirModel>
+#include <QFileSystemModel>
 #include <QHeaderView>
 #include <QMenu>
 #include <QToolTip>
diff --git a/app/Panel/krfiletreeview.cpp b/app/Panel/krfiletreeview.cpp
index d047bf0cc..181fd6bba 100644
--- a/app/Panel/krfiletreeview.cpp
+++ b/app/Panel/krfiletreeview.cpp
@@ -6,16 +6,19 @@
 */
 #include "krfiletreeview.h"
 
-#include "panelfunc.h"
 
+#include "../FileSystem/sizecalculator.h"
 #include "../FileSystem/filesystemprovider.h"
 #include "../compat.h"
 #include "../defaults.h"
 #include "../icon.h"
 #include "../krglobal.h"
 
+#include "panelfunc.h"
+
 #include <QAction>
 #include <QApplication>
+#include <QActionGroup>
 #include <QCursor>
 #include <QDir>
 #include <QDropEvent>
diff --git a/app/Panel/krpanel.cpp b/app/Panel/krpanel.cpp
index 31cad7659..9c75af71b 100644
--- a/app/Panel/krpanel.cpp
+++ b/app/Panel/krpanel.cpp
@@ -5,6 +5,7 @@
     SPDX-License-Identifier: GPL-2.0-or-later
 */
 
+#include "../FileSystem/sizecalculator.h"
 #include "krpanel.h"
 
 #include "../abstractpanelmanager.h"
diff --git a/app/Panel/krpreviews.h b/app/Panel/krpreviews.h
index 89ae646d5..1f3f2aee0 100644
--- a/app/Panel/krpreviews.h
+++ b/app/Panel/krpreviews.h
@@ -9,6 +9,7 @@
 #define KRPREVIEWS_H
 
 // QtCore
+#include <QObject>
 #include <QHash>
 #include <QList>
 // QtGui
diff --git a/app/Panel/panelcontextmenu.cpp b/app/Panel/panelcontextmenu.cpp
index f7c652297..e0f92d30f 100644
--- a/app/Panel/panelcontextmenu.cpp
+++ b/app/Panel/panelcontextmenu.cpp
@@ -19,8 +19,8 @@
 #include <KLocalizedString>
 #include <KMessageBox>
 #include <KPluginMetaData>
+#include <KPluginFactory>
 #include <KProcess>
-#include <KRun>
 #include <kio_version.h>
 #include <kservice_version.h>
 
diff --git a/app/UserAction/useraction.h b/app/UserAction/useraction.h
index 4391f6dd2..a119ef3b3 100644
--- a/app/UserAction/useraction.h
+++ b/app/UserAction/useraction.h
@@ -15,7 +15,6 @@
 
 class QDomDocument;
 class QDomElement;
-class QStringList;
 class KrAction;
 class QUrl;
 class KActionMenu;
-- 
GitLab


From e222c5886fb05973c56ff0927e24c1f9fe1a2341 Mon Sep 17 00:00:00 2001
From: Valentin Manea <valentin.manea@gmail.com>
Date: Thu, 11 Apr 2024 10:25:26 +0300
Subject: [PATCH 28/68] Fix the crash at startup - KToolBarPopupAction needs
 popupMenu()

Don't use menu() in Qt6
---
 app/MountMan/kmountman.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/app/MountMan/kmountman.cpp b/app/MountMan/kmountman.cpp
index 3f6521f01..6f7bfb0de 100644
--- a/app/MountMan/kmountman.cpp
+++ b/app/MountMan/kmountman.cpp
@@ -58,9 +58,9 @@ KMountMan::KMountMan(QWidget *parent)
     _action = new KToolBarPopupAction(Icon("kr_mountman"), i18n("&MountMan..."), this);
     connect(_action, &QAction::triggered, this, &KMountMan::mainWindow);
     connect(_action->menu(), &QMenu::aboutToShow, this, &KMountMan::quickList);
-    _manageAction = _action->menu()->addAction(i18n("Open &MountMan"));
+    _manageAction = _action->popupMenu()->addAction(i18n("Open &MountMan"));
     connect(_manageAction, &QAction::triggered, this, &KMountMan::mainWindow);
-    _action->menu()->addSeparator();
+    _action->popupMenu()->addSeparator();
 
     // added as a precaution, although we use kde services now
     _operational = KrServices::cmdExist("mount");
-- 
GitLab


From 9d341205725147103fcae6be4f169eeac296873e Mon Sep 17 00:00:00 2001
From: Valentin Manea <valentin.manea@gmail.com>
Date: Thu, 11 Apr 2024 10:25:26 +0300
Subject: [PATCH 29/68] Use the kf6 part for the dock

Fix terminal to kf6 part
---
 app/GUI/terminaldock.cpp | 3 +--
 1 file changed, 1 insertion(+), 2 deletions(-)

diff --git a/app/GUI/terminaldock.cpp b/app/GUI/terminaldock.cpp
index d94661e22..7045e89c0 100644
--- a/app/GUI/terminaldock.cpp
+++ b/app/GUI/terminaldock.cpp
@@ -28,7 +28,6 @@
 #include <KLocalizedString>
 #include <KMessageBox>
 #include <KPluginFactory>
-#include <KPluginLoader>
 #include <KService>
 #include <KToggleAction>
 #include <kde_terminal_interface.h>
@@ -65,7 +64,7 @@ TerminalDock::~TerminalDock() = default;
 bool TerminalDock::initialise()
 {
     if (!initialised) { // konsole part is not yet loaded or it has already failed
-        KPluginFactory *pluginFactory = KPluginFactory::loadFactory(QStringLiteral("konsolepart")).plugin;
+        KPluginFactory *pluginFactory = KPluginFactory::loadFactory(KPluginMetaData(QStringLiteral("kf6/parts/konsolepart"))).plugin;
 
         if (pluginFactory) {
             QWidget *focusW = qApp->focusWidget();
-- 
GitLab


From aae878bd1b7f5111ed8ee8f3cfb485ba0f4f2203 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 11:55:35 +0300
Subject: [PATCH 30/68] Adapt printDialog to qt6

---
 app/KViewer/lister.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index bba78a2da..4fc2987c2 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -1980,7 +1980,7 @@ void Lister::print()
     QScopedPointer<QPrintDialog> printDialog(new QPrintDialog(&printer, _textArea));
 
     if (hasSelection) {
-        printDialog->addEnabledOption(QAbstractPrintDialog::PrintSelection);
+        printDialog->setOption(QAbstractPrintDialog::PrintSelection);
     }
 
     if (!printDialog->exec()) {
-- 
GitLab


From 3cb54fd517f800bc1b2ffbdb5eded5c4fb3dce43 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 1 Jun 2024 10:58:37 +0300
Subject: [PATCH 31/68] Codec fixes - especially KrViewer

Can't apply a codec(decode to unicode) to a QTextStream anymore
---
 app/BookMan/krbookmarkhandler.cpp |  2 +-
 app/KViewer/lister.cpp            | 24 +++++++++++++-----------
 app/UserAction/useraction.cpp     |  2 +-
 3 files changed, 15 insertions(+), 13 deletions(-)

diff --git a/app/BookMan/krbookmarkhandler.cpp b/app/BookMan/krbookmarkhandler.cpp
index a41dcdac0..cebc7a154 100644
--- a/app/BookMan/krbookmarkhandler.cpp
+++ b/app/BookMan/krbookmarkhandler.cpp
@@ -213,7 +213,7 @@ void KrBookmarkHandler::exportToFile()
     QFile file(filename);
     if (file.open(QIODevice::WriteOnly)) {
         QTextStream stream(&file);
-        stream.setCodec("UTF-8");
+         // By default, UTF-8 is used for reading and writing in QTextStream
         stream << doc.toString();
         file.close();
     } else {
diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index 4fc2987c2..0e635318c 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -13,6 +13,7 @@
 #include <QRect>
 #include <QTemporaryFile>
 #include <QTextStream>
+#include <QStringConverter>
 // QtGui
 #include <QClipboard>
 #include <QFontDatabase>
@@ -196,8 +197,9 @@ qint64 ListerTextArea::textToFilePositionOnScreen(const int x, const int y, bool
     const int maxBytes = 2 * _sizeX * MAX_CHAR_LENGTH;
     QByteArray chunk = _lister->cacheChunk(rowStart, maxBytes);
 
-    QTextStream stream(&chunk);
-    stream.setCodec(_lister->codec());
+    QString s = _lister->codec()->toUnicode(chunk);
+    QTextStream stream(&s);
+
     stream.read(x);
     return rowStart + stream.pos();
 }
@@ -236,9 +238,10 @@ void ListerTextArea::fileToTextPositionOnScreen(const qint64 p, const bool isfir
             const qint64 previousRow = _rowStarts[y - 1];
             const QByteArray chunk = _lister->cacheChunk(previousRow, maxBytes);
             QByteArray cachedBuffer = chunk.left(static_cast<int>(p - previousRow));
+            QTextCodec *codec = _lister->codec();
+            QString decoded = codec->toUnicode(cachedBuffer);
+            QTextStream stream(&decoded);
 
-            QTextStream stream(&cachedBuffer);
-            stream.setCodec(_lister->codec());
             stream.read(_rowContent[y - 1].length());
             if (previousRow + stream.pos() == p) {
                 y--;
@@ -429,12 +432,12 @@ QString ListerTextArea::readSection(const qint64 p1, const qint64 p2)
         return section;
     }
 
-    qint64 pos = sel1;
+    qsizetype pos = sel1;
 
     QScopedPointer<QTextDecoder> decoder(_lister->codec()->makeDecoder());
 
     do {
-        const int maxBytes = std::min(_sizeX * _sizeY * MAX_CHAR_LENGTH, (int)(sel2 - pos));
+        const qsizetype maxBytes = std::min(_sizeX * _sizeY * MAX_CHAR_LENGTH, sel2 - pos);
         const QByteArray chunk = _lister->cacheChunk(pos, maxBytes);
         if (chunk.isEmpty())
             break;
@@ -1185,8 +1188,7 @@ protected:
 
     void chooseEncoding(QString encodingName) override
     {
-        QString charset = KCharsets::charsets()->encodingForName(encodingName);
-        _lister->setCharacterSet(charset);
+        _lister->setCharacterSet(encodingName);
     }
 
     Lister *_lister;
@@ -1667,9 +1669,8 @@ void Lister::slotSearchMore()
 
                 if (_searchQuery.checkLine(row, !_searchIsForward)) {
                     QByteArray cachedBuffer = chunk.mid(static_cast<int>(rowStart), static_cast<int>(chunkSize - rowStart));
-
-                    QTextStream stream(&cachedBuffer);
-                    stream.setCodec(_codec);
+                    QString decoded = _codec->toUnicode(cachedBuffer);
+                    QTextStream stream(&decoded);
 
                     stream.read(_searchQuery.matchIndex());
                     foundAnchor = searchPos + rowStart + stream.pos();
@@ -1962,6 +1963,7 @@ void Lister::setCharacterSet(const QString &set)
     } else {
         // Should move from this with KF6 migration
         _codec = QTextCodec::codecForName(_characterSet.toUtf8());
+        Q_ASSERT(_codec != nullptr);
     }
     _textArea->redrawTextArea(true);
 }
diff --git a/app/UserAction/useraction.cpp b/app/UserAction/useraction.cpp
index 2e0469e92..c48bf6801 100644
--- a/app/UserAction/useraction.cpp
+++ b/app/UserAction/useraction.cpp
@@ -278,8 +278,8 @@ bool UserAction::writeToFile(const QDomDocument &doc, const QString &filename)
        }
     */
 
+    //By default, UTF-8 is used for reading and writing
     QTextStream ts(&file);
-    ts.setCodec("UTF-8");
     ts << doc.toString();
 
     file.close();
-- 
GitLab


From b02708970b537cc7fb303ed5b881c40cbbe0c5e6 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sun, 2 Jun 2024 18:58:41 +0300
Subject: [PATCH 32/68] Fix the loading of the layout from resource

QResource seems to return empty file, it's easier to stream it
---
 app/CMakeLists.txt            |  2 +-
 app/Panel/krlayoutfactory.cpp | 15 +++++++--------
 app/Panel/krlayoutfactory.h   |  2 +-
 3 files changed, 9 insertions(+), 10 deletions(-)

diff --git a/app/CMakeLists.txt b/app/CMakeLists.txt
index 29e2e3eac..0ae8f84c3 100644
--- a/app/CMakeLists.txt
+++ b/app/CMakeLists.txt
@@ -43,7 +43,7 @@ set(krusader_SRCS
 file(GLOB ICONS_SRCS "${CMAKE_CURRENT_SOURCE_DIR}/icons/*-apps-krusader_user.png")
 ecm_add_app_icon(krusader_SRCS ICONS ${ICONS_SRCS})
 
-qt6_add_resources(krusader_RC_SRCS "${CMAKE_CURRENT_SOURCE_DIR}/resources.qrc" )
+qt_add_resources(krusader_RC_SRCS "${CMAKE_CURRENT_SOURCE_DIR}/resources.qrc" )
 
 add_executable(krusader ${krusader_SRCS} ${krusader_RC_SRCS})
 
diff --git a/app/Panel/krlayoutfactory.cpp b/app/Panel/krlayoutfactory.cpp
index 869e164b5..a28ca2544 100644
--- a/app/Panel/krlayoutfactory.cpp
+++ b/app/Panel/krlayoutfactory.cpp
@@ -87,13 +87,12 @@ bool KrLayoutFactory::parseFile(const QString &path, QDomDocument &doc)
 
 bool KrLayoutFactory::parseResource(const QString &path, QDomDocument &doc)
 {
-    QResource res(path);
-    if (res.isValid()) {
-        QByteArray data;
-        if (QRESOURCE_ISCOMPRESSED(res))
-            data = qUncompress(res.data(), static_cast<int>(res.size()));
-        else
-            data = QByteArray(reinterpret_cast<const char *>(res.data()), static_cast<int>(res.size()));
+    QFile f(path);
+
+    if (f.open( QIODevice::ReadOnly)) {
+        QTextStream t( &f );
+        t.setEncoding(QStringConverter::Utf8);
+        QString data = t.readAll();
         return parseContent(data, path, doc);
     } else {
         qWarning() << "resource does not exist:" << path;
@@ -101,7 +100,7 @@ bool KrLayoutFactory::parseResource(const QString &path, QDomDocument &doc)
     }
 }
 
-bool KrLayoutFactory::parseContent(const QByteArray &content, const QString &fileName, QDomDocument &doc)
+bool KrLayoutFactory::parseContent(const QString &content, const QString &fileName, QDomDocument &doc)
 {
     bool success = false;
 
diff --git a/app/Panel/krlayoutfactory.h b/app/Panel/krlayoutfactory.h
index b3d0ec27f..c910d438b 100644
--- a/app/Panel/krlayoutfactory.h
+++ b/app/Panel/krlayoutfactory.h
@@ -41,7 +41,7 @@ private:
     static bool parseFiles();
     static bool parseFile(const QString &path, QDomDocument &doc);
     static bool parseResource(const QString &path, QDomDocument &doc);
-    static bool parseContent(const QByteArray &content, const QString &fileName, QDomDocument &doc);
+    static bool parseContent(const QString &content, const QString &fileName, QDomDocument &doc);
     static void getLayoutNames(const QDomDocument &doc, QStringList &names);
     static QDomElement findLayout(const QDomDocument &doc, const QString &layoutName);
 
-- 
GitLab


From 9cb9bdf27b3e186cfa2ce2b91225a88ca56ccbe3 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sun, 2 Jun 2024 20:04:40 +0300
Subject: [PATCH 33/68] ListJob doesn't have a percent signal anymore

The name of the signal is percentChanged() now
---
 app/Panel/listpanel.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/Panel/listpanel.cpp b/app/Panel/listpanel.cpp
index 57d53c806..e81a87212 100644
--- a/app/Panel/listpanel.cpp
+++ b/app/Panel/listpanel.cpp
@@ -1083,7 +1083,7 @@ void ListPanel::slotRefreshJobStarted(KIO::Job *job)
 
     // connect to the job interface to provide in-panel refresh notification
     connect(job, &KIO::Job::infoMessage, this, &ListPanel::inlineRefreshInfoMessage);
-    connect(job, SIGNAL(percent(KJob *, ulong)), SLOT(inlineRefreshPercent(KJob *, ulong)));
+    connect(job, SIGNAL(percentChanged(KJob *, ulong)), SLOT(inlineRefreshPercent(KJob *, ulong)));
     connect(job, &KIO::Job::result, this, &ListPanel::inlineRefreshListResult);
 
     inlineRefreshJob = job;
-- 
GitLab


From 4352ef6234a6629f6e688293d08a151c506f30a6 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sun, 2 Jun 2024 20:05:13 +0300
Subject: [PATCH 34/68] Action in MountMan should use popupmenu not menu

---
 app/MountMan/kmountman.cpp | 12 ++++++------
 1 file changed, 6 insertions(+), 6 deletions(-)

diff --git a/app/MountMan/kmountman.cpp b/app/MountMan/kmountman.cpp
index 6f7bfb0de..852fc45dc 100644
--- a/app/MountMan/kmountman.cpp
+++ b/app/MountMan/kmountman.cpp
@@ -57,7 +57,7 @@ KMountMan::KMountMan(QWidget *parent)
 {
     _action = new KToolBarPopupAction(Icon("kr_mountman"), i18n("&MountMan..."), this);
     connect(_action, &QAction::triggered, this, &KMountMan::mainWindow);
-    connect(_action->menu(), &QMenu::aboutToShow, this, &KMountMan::quickList);
+    connect(_action->popupMenu(), &QMenu::aboutToShow, this, &KMountMan::quickList);
     _manageAction = _action->popupMenu()->addAction(i18n("Open &MountMan"));
     connect(_manageAction, &QAction::triggered, this, &KMountMan::mainWindow);
     _action->popupMenu()->addSeparator();
@@ -360,11 +360,11 @@ void KMountMan::quickList()
     }
 
     // clear mount / unmount actions
-    for (QAction *action : _action->menu()->actions()) {
+    for (QAction *action : _action->popupMenu()->actions()) {
         if (action == _manageAction || action->isSeparator()) {
             continue;
         }
-        _action->menu()->removeAction(action);
+        _action->popupMenu()->removeAction(action);
     }
 
     // create lists of current and possible mount points
@@ -390,11 +390,11 @@ void KMountMan::quickList()
         const QString text =
             QString("%1 %2 (%3)").arg(needUmount ? i18n("Unmount") : i18n("Mount"), possibleMountPoint->mountPoint(), possibleMountPoint->mountedFrom());
 
-        QAction *act = _action->menu()->addAction(text);
+        QAction *act = _action->popupMenu()->addAction(text);
         act->setData(QList<QVariant>(
             {QVariant(needUmount ? KMountMan::ActionType::Unmount : KMountMan::ActionType::Mount), QVariant(possibleMountPoint->mountPoint())}));
     }
-    connect(_action->menu(), &QMenu::triggered, this, &KMountMan::delayedPerformAction);
+    connect(_action->popupMenu(), &QMenu::triggered, this, &KMountMan::delayedPerformAction);
 }
 
 void KMountMan::delayedPerformAction(const QAction *action)
@@ -403,7 +403,7 @@ void KMountMan::delayedPerformAction(const QAction *action)
         return;
     }
 
-    disconnect(_action->menu(), &QMenu::triggered, nullptr, nullptr);
+    disconnect(_action->popupMenu(), &QMenu::triggered, nullptr, nullptr);
 
     const QList<QVariant> actData = action->data().toList();
     const int actionType = actData[0].toInt();
-- 
GitLab


From 2c69149c364716802c69f9825d3bff2fdf9d738f Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sun, 2 Jun 2024 20:19:36 +0300
Subject: [PATCH 35/68] Working version of the freespace info

This code will just wait for all the KIO:Job to finish getting the free
space info and then it will continue.

This seems less than ideal, but calling updateList() freeSpaceResult
wastes a lot of space because the icons are updated all the time, which
takes a lot of time. Perhaps freeSpaceResult() could call a less
demanding version?
---
 app/MountMan/kmountmangui.cpp | 31 +++++++++++++++----------------
 1 file changed, 15 insertions(+), 16 deletions(-)

diff --git a/app/MountMan/kmountmangui.cpp b/app/MountMan/kmountmangui.cpp
index b9b13ea86..576254d45 100644
--- a/app/MountMan/kmountmangui.cpp
+++ b/app/MountMan/kmountmangui.cpp
@@ -209,14 +209,12 @@ void KMountManGUI::getSpaceData()
 
     // Potentially long running
     this->setCursor(Qt::WaitCursor);
+    int started = 0;
     for (auto &it : mounted) {
         // don't bother with invalid file systems
         if (mountMan->invalidFilesystem(it->mountType())) {
             continue;
         }
-        QTimer timer;
-        timer.setSingleShot(true);
-        QEventLoop loop;
         fsData data;
 
         data.setMntPoint(it->mountPoint());
@@ -224,32 +222,33 @@ void KMountManGUI::getSpaceData()
         data.setName(it->mountedFrom());
         data.setType(it->mountType());
         KIO::FileSystemFreeSpaceJob *job = KIO::fileSystemFreeSpace(QUrl::fromLocalFile(it->mountPoint()));
+        Q_ASSERT(job != nullptr);
+
         connect(job, &KIO::FileSystemFreeSpaceJob::finished, this,
                 [this, data](KJob *job){ this->freeSpaceResult(job, data); });
-        // Add a timeout and also wait for each info job to complete, this way they are added in sequence
-        connect(job, &KIO::FileSystemFreeSpaceJob::result, &loop, &QEventLoop::quit);
-        connect(&timer, &QTimer::timeout, &loop, &QEventLoop::quit);
+        started++;
+    }
+    QTimer timer;
+    timer.setSingleShot(true);
+    QEventLoop loop;
+    connect(&timer, &QTimer::timeout, &loop, &QEventLoop::quit);
+
+    //TODO: How better to wait for all to finish?
+    while (started != fileSystems.size()) {
         timer.start(100); // 100ms Maybe this should be configurable
         loop.exec();
-
-        // Timed out, delete the job and add a dummy entry
-        if (!timer.isActive()) {
-            delete job;
-            data.setTotalBlks(0);
-            data.setFreeBlks(0);
-            fileSystems.append(data);
-        }
     }
+    updateList();
+
     this->setCursor(Qt::ArrowCursor);
     addNonMounted();
-    updateList();
 }
 
 void KMountManGUI::freeSpaceResult(KJob *job, fsData data)
 {
     if (!job->error()) {
         KIO::FileSystemFreeSpaceJob *freeSpaceJob = qobject_cast<KIO::FileSystemFreeSpaceJob *>(job);
-        Q_ASSERT(freeSpaceJob);
+        Q_ASSERT(job != nullptr);
         // Set the missing information, with the assumption the caller already set the rest
         data.setTotalBlks(freeSpaceJob->size() / 1024);
         data.setFreeBlks(freeSpaceJob->availableSize() / 1024);
-- 
GitLab


From 0bd4430d38c34a40ad4f7ed631bd26af72966a32 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sun, 2 Jun 2024 21:04:53 +0300
Subject: [PATCH 36/68] Bookmark manager doesn't provide a slot for editing
 bookmarks

Instead it provides an action through KBookmarkMenu that can be used
directly
---
 app/BookMan/CMakeLists.txt        | 1 +
 app/BookMan/krbookmarkhandler.cpp | 9 ++++++++-
 app/BookMan/krbookmarkhandler.h   | 2 ++
 3 files changed, 11 insertions(+), 1 deletion(-)

diff --git a/app/BookMan/CMakeLists.txt b/app/BookMan/CMakeLists.txt
index be54cc859..e948e3a8c 100644
--- a/app/BookMan/CMakeLists.txt
+++ b/app/BookMan/CMakeLists.txt
@@ -9,6 +9,7 @@ add_library(BookMan STATIC ${BookMan_SRCS})
 target_link_libraries(BookMan
     KF6::Archive
     KF6::Bookmarks
+    KF6::BookmarksWidgets
     KF6::Completion
     KF6::ConfigCore
     KF6::ConfigWidgets
diff --git a/app/BookMan/krbookmarkhandler.cpp b/app/BookMan/krbookmarkhandler.cpp
index cebc7a154..ccb39f033 100644
--- a/app/BookMan/krbookmarkhandler.cpp
+++ b/app/BookMan/krbookmarkhandler.cpp
@@ -32,6 +32,7 @@
 
 #include <KActionCollection>
 #include <KBookmarkManager>
+#include <KBookmarkMenu>
 #include <KLocalizedString>
 #include <KMessageBox>
 #include <KSharedConfig>
@@ -70,6 +71,7 @@ KrBookmarkHandler::KrBookmarkHandler(KrMainWindow *mainWindow)
     // create bookmark manager
     QString filename = QStandardPaths::writableLocation(QStandardPaths::GenericDataLocation) + QLatin1Char('/') + BOOKMARKS_FILE;
     manager = new KBookmarkManager(filename);
+
     connect(manager, &KBookmarkManager::changed, this, &KrBookmarkHandler::bookmarksChanged);
 
     // create the quick search bar and action
@@ -82,8 +84,11 @@ KrBookmarkHandler::KrBookmarkHandler(KrMainWindow *mainWindow)
 
     // fill a dummy menu to properly init actions (allows toolbar bookmark buttons to work properly)
     auto menu = new QMenu(mainWindow->widget());
+    bookmarksMenu = new KBookmarkMenu(manager, nullptr, menu);
+
     populate(menu);
     menu->deleteLater();
+
 }
 
 KrBookmarkHandler::~KrBookmarkHandler()
@@ -527,7 +532,9 @@ void KrBookmarkHandler::buildMenu(KrBookmark *parent, QMenu *menu, int depth)
             menu->addAction(KrActions::actAddBookmark);
             _specialBookmarks.append(KrActions::actAddBookmark);
         }
-        QAction *bmAct = menu->addAction(Icon("bookmarks"), i18n("Manage Bookmarks"), manager, SLOT(slotEditBookmarks()));
+
+        QAction *bmAct = bookmarksMenu->editBookmarksAction();
+        menu->addAction(bmAct);
         _specialBookmarks.append(bmAct);
 
         // make sure the menu is connected to us
diff --git a/app/BookMan/krbookmarkhandler.h b/app/BookMan/krbookmarkhandler.h
index 0591803db..4de85fd2a 100644
--- a/app/BookMan/krbookmarkhandler.h
+++ b/app/BookMan/krbookmarkhandler.h
@@ -26,6 +26,7 @@
 
 class KActionCollection;
 class KBookmarkManager;
+class KBookmarkMenu;
 class KrMainWindow;
 
 class KrBookmarkHandler : public QObject
@@ -68,6 +69,7 @@ private:
     KrBookmark *_root;
     // the whole KBookmarkManager is an ugly hack. use it until we have our own
     KBookmarkManager *manager;
+    KBookmarkMenu *bookmarksMenu;
     bool _middleClick; // if true, the user clicked the middle button to open the bookmark
 
     QPointer<QMenu> _mainBookmarkPopup; // main bookmark popup menu
-- 
GitLab


From fcb59f355d066eecf07a3a7c16b02b54fdb71b4a Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sun, 2 Jun 2024 21:13:57 +0300
Subject: [PATCH 37/68] Fix the configure shortcuts dialog, switch to
 showConfigureShortcutsDialog

KXMLGui had a refactoring where configureHsortcuts was removed and a new
method showConfigureShortcutsDialog was added.

https://invent.kde.org/frameworks/kxmlgui/-/commit/1c56174b8c1be0ea45f214390afdee12cfb0da11
---
 app/kractions.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/kractions.cpp b/app/kractions.cpp
index eeba0c74f..8bfd2521f 100644
--- a/app/kractions.cpp
+++ b/app/kractions.cpp
@@ -186,7 +186,7 @@ void KrActions::setupActions(Krusader *krusaderApp)
     actShowStatusBar = KStandardAction::showStatusbar(SLOTS, SLOT(updateStatusbarVisibility()), krusaderApp->actionCollection());
     KStandardAction::quit(krusaderApp, SLOT(quit()), krusaderApp->actionCollection());
     KStandardAction::configureToolbars(krusaderApp, SLOT(configureToolbars()), krusaderApp->actionCollection());
-    KStandardAction::keyBindings(krusaderApp->guiFactory(), SLOT(configureShortcuts()), krusaderApp->actionCollection());
+    KStandardAction::keyBindings(krusaderApp->guiFactory(), SLOT(showConfigureShortcutsDialog()), krusaderApp->actionCollection());
 
     // the toggle actions
     NEW_KTOGGLEACTION(actToggleFnkeys, i18n("Show &FN Keys Bar"), nullptr, 0, SLOTS, SLOT(toggleFnkeys()), "toggle fn bar");
-- 
GitLab


From 83103f138f2e6ac55ab578ec4fab287ad719b810 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Tue, 11 Jun 2024 22:17:47 +0300
Subject: [PATCH 38/68] KRArk switch to QRegularExpression

QRegExp has been deprecated in Qt6
---
 plugins/krarc/krarc.cpp | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/plugins/krarc/krarc.cpp b/plugins/krarc/krarc.cpp
index 8c56c4051..e170a946c 100644
--- a/plugins/krarc/krarc.cpp
+++ b/plugins/krarc/krarc.cpp
@@ -18,7 +18,7 @@
 #include <QFileInfo>
 #include <QMimeDatabase>
 #include <QMimeType>
-#include <QRegExp>
+#include <QRegularExpression>
 #include <QTemporaryFile>
 #include <QTextCodec>
 #include <qplatformdefs.h>
@@ -170,7 +170,7 @@ kio_krarcProtocol::kio_krarcProtocol(const QByteArray &pool_socket, const QByteA
 
     arcTempDir = tmpDirPath + DIR_SEPARATOR;
     QString dirName = "krArc" + QDateTime::currentDateTime().toString(Qt::ISODate);
-    dirName.replace(QRegExp(":"), "_");
+    dirName.replace(QRegularExpression(":"), "_");
     tmpDir.mkdir(dirName);
     arcTempDir = arcTempDir + dirName + DIR_SEPARATOR;
 
-- 
GitLab


From 81d10e7d9a6cb66d370ac0fcf8efe0a05371ed76 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Tue, 11 Jun 2024 22:18:41 +0300
Subject: [PATCH 39/68] KrArc Fix the default value for getPath

nullptr can't convert to QUrl::FormattingOptions so use  QUrl::None
---
 plugins/krarc/krarc.h | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/plugins/krarc/krarc.h b/plugins/krarc/krarc.h
index fcd55f8fb..90b8d1a9c 100644
--- a/plugins/krarc/krarc.h
+++ b/plugins/krarc/krarc.h
@@ -53,7 +53,7 @@ protected:
     Q_REQUIRED_RESULT virtual KIO::WorkerResult setArcFile(const QUrl &url);
     Q_REQUIRED_RESULT virtual QString getPassword();
     virtual void invalidatePassword();
-    QString getPath(const QUrl &url, QUrl::FormattingOptions options = nullptr);
+    QString getPath(const QUrl &url, QUrl::FormattingOptions options = QUrl::None);
     /** parses a text line from the listing of an archive. */
     virtual void parseLine(int lineNo, QString line);
 
-- 
GitLab


From cf7a6629dd85bdbf4f985dc5729b462b7d023e47 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Tue, 11 Jun 2024 22:21:12 +0300
Subject: [PATCH 40/68] KrArc remove deprecate Qt5 support code

Remove the ifdef code that supported old versions, can't work in Kf6
anymore
---
 plugins/krarc/krarc.cpp | 128 +---------------------------------------
 1 file changed, 1 insertion(+), 127 deletions(-)

diff --git a/plugins/krarc/krarc.cpp b/plugins/krarc/krarc.cpp
index e170a946c..577bb21d7 100644
--- a/plugins/krarc/krarc.cpp
+++ b/plugins/krarc/krarc.cpp
@@ -788,7 +788,6 @@ KIO::WorkerResult kio_krarcProtocol::rename(const QUrl &src, const QUrl &dest, K
     KRDEBUG("renaming from: " << src.path() << " to: " << dest.path());
     KRDEBUG("command: " << arcPath);
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto writeSupportResult = checkWriteSupport();
     if (!writeSupportResult.success())
         return writeSupportResult;
@@ -800,20 +799,6 @@ KIO::WorkerResult kio_krarcProtocol::rename(const QUrl &src, const QUrl &dest, K
     if (src.fileName() == dest.fileName()) {
         return WorkerResult::pass();
     }
-#else
-    if (!checkWriteSupport()) {
-        return;
-    }
-
-    if (renCmd.isEmpty()) {
-        error(KIO::ERR_CANNOT_RENAME, src.fileName());
-        return;
-    }
-
-    if (src.fileName() == dest.fileName()) {
-        return;
-    }
-#endif
 
     KrLinecountingProcess proc;
     proc << renCmd << arcPath << src.path().remove(arcPath + '/') << dest.path().remove(arcPath + '/');
@@ -821,43 +806,22 @@ KIO::WorkerResult kio_krarcProtocol::rename(const QUrl &src, const QUrl &dest, K
     proc.waitForFinished();
 
     if (proc.exitStatus() != QProcess::NormalExit || !checkStatus(proc.exitCode())) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::fail(KIO::ERR_CANNOT_RENAME, src.fileName());
     }
 
     return WorkerResult::pass();
-#else
-        error(KIO::ERR_CANNOT_RENAME, src.fileName());
-        return;
-    }
-
-    finished();
-#endif
 }
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
+
 KIO::WorkerResult kio_krarcProtocol::listDir(const QUrl &url)
-#else
-void kio_krarcProtocol::listDir(const QUrl &url)
-#endif
 {
     KRFUNC;
     KRDEBUG(getPath(url));
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto setArcFileResult = setArcFile(url);
     if (!setArcFileResult.success()) {
         return setArcFileResult;
     }
     if (listCmd.isEmpty()) {
         return WorkerResult::fail(ERR_UNSUPPORTED_ACTION, i18n("Listing folders is not supported for %1 archives", arcType));
-#else
-    if (!setArcFile(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-    if (listCmd.isEmpty()) {
-        error(ERR_UNSUPPORTED_ACTION, i18n("Listing folders is not supported for %1 archives", arcType));
-        return;
-#endif
     }
     QString path = getPath(url);
     if (path.right(1) != DIR_SEPARATOR)
@@ -869,7 +833,6 @@ void kio_krarcProtocol::listDir(const QUrl &url)
             QUrl redir;
             redir.setPath(getPath(url));
             redirection(redir);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
             return WorkerResult::pass();
         }
         // maybe it's an archive !
@@ -878,18 +841,6 @@ void kio_krarcProtocol::listDir(const QUrl &url)
     if (!initDirDict(url)) {
         return WorkerResult::fail(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
     }
-#else
-            finished();
-        } else { // maybe it's an archive !
-            error(ERR_IS_FILE, path);
-        }
-        return;
-    }
-    if (!initDirDict(url)) {
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-    }
-#endif
 
     QString arcDir = path.mid(getPath(arcFile->url()).length());
     arcDir.truncate(arcDir.lastIndexOf(DIR_SEPARATOR));
@@ -897,28 +848,15 @@ void kio_krarcProtocol::listDir(const QUrl &url)
         arcDir = arcDir + DIR_SEPARATOR;
 
     if (dirDict.find(arcDir) == dirDict.end()) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::fail(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-#else
-        error(ERR_CANNOT_ENTER_DIRECTORY, getPath(url));
-        return;
-#endif
     }
     UDSEntryList *dirList = dirDict[arcDir];
     totalSize(dirList->size());
     listEntries(*dirList);
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     return WorkerResult::pass();
-#else
-    finished();
-#endif
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::setArcFile(const QUrl &url)
-#else
-bool kio_krarcProtocol::setArcFile(const QUrl &url)
-#endif
 {
     KRFUNC;
     KRDEBUG(url.fileName());
@@ -946,11 +884,7 @@ bool kio_krarcProtocol::setArcFile(const QUrl &url)
             delete newArcFile;
             archiveChanged = false;
             if (encrypted && password.isNull())
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
                 (void)initArcParameters();
-#else
-                initArcParameters();
-#endif
         }
     } else { // it's a new file...
         extArcReady = false;
@@ -977,12 +911,7 @@ bool kio_krarcProtocol::setArcFile(const QUrl &url)
         }
         if (!arcFile) {
             // KRDEBUG("ERROR: " << path << " does not exist.");
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
             return WorkerResult::fail(KIO::ERR_DOES_NOT_EXIST, url.toString());
-#else
-            error(ERR_DOES_NOT_EXIST, path);
-            return false; // file not found
-#endif
         }
         currentCharset = metaData("Charset");
 
@@ -1039,15 +968,10 @@ bool kio_krarcProtocol::initDirDict(const QUrl &url, bool forced)
 
     extArcReady = false;
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     const auto setArcFileResult = setArcFile(url);
     if (!setArcFileResult.success()) { /* if the archive was changed refresh the file information */
         return false;
     }
-#else
-    if (!setArcFile(url))
-        return false; /* if the archive was changed refresh the file information */
-#endif
 
     // write the temp file
     KrLinecountingProcess proc;
@@ -1055,9 +979,6 @@ bool kio_krarcProtocol::initDirDict(const QUrl &url, bool forced)
 
     // parse the temp file
     if (!temp.open()) {
-#if KSERVICE_VERSION < QT_VERSION_CHECK(5, 96, 0)
-        error(ERR_CANNOT_READ, temp.fileName());
-#endif
         return false;
     }
 
@@ -1284,12 +1205,7 @@ UDSEntryList *kio_krarcProtocol::addNewDir(const QString &path)
     if (name == "." || name == "..") { // entries with these names wouldn't be displayed
         // don't translate since this is an internal error
         QString err = QString("Cannot handle path: ") + path;
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         KRDEBUG("ERROR: " << err);
-#else
-        // KRDEBUG("ERROR: " << err);
-        error(KIO::ERR_INTERNAL, err);
-#endif
         exit();
     }
 
@@ -1630,11 +1546,7 @@ void kio_krarcProtocol::parseLine(int lineNo, QString line)
     dir->append(entry);
 }
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
 KIO::WorkerResult kio_krarcProtocol::initArcParameters()
-#else
-bool kio_krarcProtocol::initArcParameters()
-#endif
 {
     KRFUNC;
     KRDEBUG("arcType: " << arcType);
@@ -1803,11 +1715,7 @@ bool kio_krarcProtocol::initArcParameters()
         noencoding = true;
         cmd = find7zExecutable();
         if (cmd.isEmpty()) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
             return WorkerResult::fail(KIO::ERR_CANNOT_LAUNCH_PROCESS, {});
-#else
-            return false;
-#endif
         }
 
         listCmd << cmd << "l"
@@ -1834,34 +1742,18 @@ bool kio_krarcProtocol::initArcParameters()
     // checking if it's an absolute path
 #ifdef Q_OS_WIN
     if (cmd.length() > 2 && cmd[0].isLetter() && cmd[1] == ':')
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::pass();
-#else
-        return true;
-#endif
 
 #else
     if (cmd.startsWith(DIR_SEPARATOR))
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         return WorkerResult::pass();
-#else
-        return true;
-#endif
 
 #endif
     if (QStandardPaths::findExecutable(cmd).isEmpty()) {
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
         KRDEBUG("Failed to find cmd: " << cmd);
         return WorkerResult::fail(KIO::ERR_CANNOT_LAUNCH_PROCESS, cmd + i18n("\nMake sure that the %1 binary is installed properly on your system.", cmd));
     }
     return WorkerResult::pass();
-#else
-        error(KIO::ERR_CANNOT_LAUNCH_PROCESS, cmd + i18n("\nMake sure that the %1 binary is installed properly on your system.", cmd));
-        KRDEBUG("Failed to find cmd: " << cmd);
-        return false;
-    }
-    return true;
-#endif
 }
 
 bool kio_krarcProtocol::checkStatus(int exitCode)
@@ -1984,7 +1876,6 @@ QString kio_krarcProtocol::getPassword()
 
     authInfo.password.clear();
 
-#if KSERVICE_VERSION >= QT_VERSION_CHECK(5, 96, 0)
     int errCode = openPasswordDialog(authInfo, i18n("Accessing the file requires a password."));
     if (!errCode && !authInfo.password.isNull()) {
         KRDEBUG(authInfo.password);
@@ -1992,23 +1883,6 @@ QString kio_krarcProtocol::getPassword()
     } else {
         password.clear();
     }
-#else
-
-#if KIO_VERSION_MINOR >= 24
-    int errCode = openPasswordDialogV2(authInfo, i18n("Accessing the file requires a password."));
-    if (!errCode && !authInfo.password.isNull()) {
-#else
-    if (openPasswordDialog(authInfo, i18n("Accessing the file requires a password.")) && !authInfo.password.isNull()) {
-#endif
-        KRDEBUG(authInfo.password);
-        return (password = authInfo.password);
-#if KIO_VERSION_MINOR >= 24
-    } else {
-        error(errCode, QString());
-#endif
-    }
-
-#endif
 
     KRDEBUG(password);
     return password;
-- 
GitLab


From bfc4539180597aee492f418e16ba4f9f0920d7f5 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Tue, 11 Jun 2024 22:21:59 +0300
Subject: [PATCH 41/68] KrArc add the AuthInfo header from KIO

Required in Kf6
---
 plugins/krarc/krarc.cpp | 1 +
 1 file changed, 1 insertion(+)

diff --git a/plugins/krarc/krarc.cpp b/plugins/krarc/krarc.cpp
index 577bb21d7..fd26ff49e 100644
--- a/plugins/krarc/krarc.cpp
+++ b/plugins/krarc/krarc.cpp
@@ -25,6 +25,7 @@
 
 #include <KFileItem>
 #include <KIO/Job>
+#include <KIO/AuthInfo>
 #include <KLocalizedString>
 #include <KProcess>
 #include <KTar>
-- 
GitLab


From 18e512b11276be8dfd334ca2c677760bb86ef524 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Tue, 11 Jun 2024 22:22:36 +0300
Subject: [PATCH 42/68] Replace KIO::ERR_SLAVE_DEFINED
 withKIO::ERR_WORKER_DEFINED

KIO::ERR_SLAVE_DEFINED has already been deprecated in Kf5
---
 plugins/krarc/krarc.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/plugins/krarc/krarc.cpp b/plugins/krarc/krarc.cpp
index fd26ff49e..450cadc54 100644
--- a/plugins/krarc/krarc.cpp
+++ b/plugins/krarc/krarc.cpp
@@ -504,7 +504,7 @@ KIO::WorkerResult kio_krarcProtocol::get(const QUrl &url, int tries)
 
     // Wait until the external unpacker has finished
     if (!proc.waitForFinished(-1)) {
-        return WorkerResult::fail(KIO::ERR_SLAVE_DEFINED,
+        return WorkerResult::fail(KIO::ERR_WORKER_DEFINED,
                                   i18n("An error has happened, related to the external program '%1'. "
                                        "The error message is: '%2'.",
                                        cmd,
-- 
GitLab


From ef8d12b03bba2b06a504e2d290534ae4e3082a05 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 8 Jun 2024 10:29:24 +0300
Subject: [PATCH 43/68] Fix FreeBSD C++ build

std::mem_fun_ref has been deprecated - replace with mem_fn, also
std::not1 cannot be used with std::mem_fn
---
 app/UserAction/expander.cpp | 5 ++---
 1 file changed, 2 insertions(+), 3 deletions(-)

diff --git a/app/UserAction/expander.cpp b/app/UserAction/expander.cpp
index ca73dd6a0..cee1f875c 100644
--- a/app/UserAction/expander.cpp
+++ b/app/UserAction/expander.cpp
@@ -5,7 +5,6 @@
 
     SPDX-License-Identifier: GPL-2.0-or-later
 */
-
 #include "expander.h"
 
 #include "../FileSystem/filesystemprovider.h"
@@ -629,7 +628,7 @@ TagString exp_Copy::expFunc(const KrPanel *, const TagStringList &parameter, con
     // or transform(...) ?
     const QUrl dest = QUrl::fromUserInput(parameter[1].string(), QString(), QUrl::AssumeLocalFile);
 
-    if (!dest.isValid() || find_if(sourceURLs.constBegin(), sourceURLs.constEnd(), not1(mem_fun_ref(&QUrl::isValid))) != sourceURLs.constEnd()) {
+    if (!dest.isValid() || find_if(sourceURLs.constBegin(), sourceURLs.constEnd(), std::not_fn(std::bind(std::mem_fn(&QUrl::isValid), std::placeholders::_1))) != sourceURLs.constEnd()) {
         setError(exp, Error(Error::exp_S_FATAL, Error::exp_C_ARGUMENT, i18n("Expander: invalid URLs in %_Copy(\"src\", \"dest\")%")));
         return QString();
     }
@@ -668,7 +667,7 @@ TagString exp_Move::expFunc(const KrPanel *, const TagStringList &parameter, con
     // or transform(...) ?
     QUrl dest = QUrl::fromUserInput(parameter[1].string(), QString(), QUrl::AssumeLocalFile);
 
-    if (!dest.isValid() || find_if(src.constBegin(), src.constEnd(), not1(mem_fun_ref(&QUrl::isValid))) != src.constEnd()) {
+    if (!dest.isValid() || find_if(src.constBegin(), src.constEnd(), std::not_fn(std::bind(std::mem_fn(&QUrl::isValid), std::placeholders::_1))) != src.constEnd()) {
         setError(exp, Error(Error::exp_S_FATAL, Error::exp_C_ARGUMENT, i18n("Expander: invalid URLs in %_Move(\"src\", \"dest\")%")));
         return QString();
     }
-- 
GitLab


From 7b2c37b40b57a6b82dee38eb69327aba4bea9a59 Mon Sep 17 00:00:00 2001
From: Valentin Manea <email_kde@mors.eu.org>
Date: Sat, 8 Jun 2024 10:12:56 +0300
Subject: [PATCH 44/68] Fix CI build with kf6

Move all the frameworks version to kf6, same with qt to qt6.
Add required kstatusnotifier
---
 .gitlab-ci.yml |  4 ++--
 .kde-ci.yml    | 47 ++++++++++++++++++++++++-----------------------
 2 files changed, 26 insertions(+), 25 deletions(-)

diff --git a/.gitlab-ci.yml b/.gitlab-ci.yml
index b0b964987..e3b3aaa4b 100644
--- a/.gitlab-ci.yml
+++ b/.gitlab-ci.yml
@@ -1,5 +1,5 @@
 include:
   - project: sysadmin/ci-utilities
     file:
-      - /gitlab-templates/linux.yml
-      - /gitlab-templates/freebsd.yml
+      - /gitlab-templates/linux-qt6.yml
+      - /gitlab-templates/freebsd-qt6.yml
diff --git a/.kde-ci.yml b/.kde-ci.yml
index 383bf3ed4..2ca4f9052 100644
--- a/.kde-ci.yml
+++ b/.kde-ci.yml
@@ -2,29 +2,30 @@
 # SPDX-License-Identifier: CC0-1.0
 
 Dependencies:
-- 'on': ['@all']
+- 'on': ['Linux/Qt6', 'FreeBSD/Qt6']
   'require':
-    'frameworks/extra-cmake-modules': '@stable'
-    'frameworks/karchive': '@stable'
-    'frameworks/kbookmarks': '@stable'
-    'frameworks/kcodecs': '@stable'
-    'frameworks/kcompletion': '@stable'
-    'frameworks/kcoreaddons': '@stable'
-    'frameworks/kconfig': '@stable'
-    'frameworks/kdoctools': '@stable'
-    'frameworks/ki18n': '@stable'
-    'frameworks/kiconthemes': '@stable'
-    'frameworks/kitemviews': '@stable'
-    'frameworks/kio': '@stable'
-    'frameworks/knotifications': '@stable'
-    'frameworks/kparts': '@stable'
-    'frameworks/solid': '@stable'
-    'frameworks/ktextwidgets': '@stable'
-    'frameworks/kwallet': '@stable'
-    'frameworks/kwidgetsaddons': '@stable'
-    'frameworks/kwindowsystem': '@stable'
-    'frameworks/kxmlgui': '@stable'
-    'frameworks/kguiaddons': '@stable'
+    'frameworks/extra-cmake-modules': '@latest-kf6'
+    'frameworks/karchive': '@latest-kf6'
+    'frameworks/kbookmarks': '@latest-kf6'
+    'frameworks/kcodecs': '@latest-kf6'
+    'frameworks/kcompletion': '@latest-kf6'
+    'frameworks/kcoreaddons': '@latest-kf6'
+    'frameworks/kconfig': '@latest-kf6'
+    'frameworks/kdoctools': '@latest-kf6'
+    'frameworks/ki18n': '@latest-kf6'
+    'frameworks/kiconthemes': '@latest-kf6'
+    'frameworks/kitemviews': '@latest-kf6'
+    'frameworks/kio': '@latest-kf6'
+    'frameworks/knotifications': '@latest-kf6'
+    'frameworks/kparts': '@latest-kf6'
+    'frameworks/solid': '@latest-kf6'
+    'frameworks/kstatusnotifieritem': '@latest-kf6'
+    'frameworks/ktextwidgets': '@latest-kf6'
+    'frameworks/kwallet': '@latest-kf6'
+    'frameworks/kwidgetsaddons': '@latest-kf6'
+    'frameworks/kwindowsystem': '@latest-kf6'
+    'frameworks/kxmlgui': '@latest-kf6'
+    'frameworks/kguiaddons': '@latest-kf6'
 
 Options:
-  require-passing-tests-on: ['Linux', 'FreeBSD', 'Windows']
+  require-passing-tests-on: ['Linux', 'FreeBSD']
-- 
GitLab


From 9e775bad9e367baf0d36b9db653c0f48ea0994d0 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Thu, 20 Jun 2024 12:06:17 +0200
Subject: [PATCH 46/68] Fix percent signal of various jobs not connected

---
 app/JobMan/jobman.cpp     | 5 ++---
 app/Panel/listpanel.cpp   | 4 ++--
 app/Splitter/combiner.cpp | 2 +-
 app/Splitter/splitter.cpp | 2 +-
 4 files changed, 6 insertions(+), 7 deletions(-)

diff --git a/app/JobMan/jobman.cpp b/app/JobMan/jobman.cpp
index 775d9b559..f7b741930 100644
--- a/app/JobMan/jobman.cpp
+++ b/app/JobMan/jobman.cpp
@@ -141,7 +141,7 @@ private slots:
     void slotStarted(KJob *job)
     {
         connect(job, &KJob::description, this, &JobMenuAction::slotDescription);
-        connect(job, SIGNAL(percent(KJob *, ulong)), this, SLOT(slotPercent(KJob *, ulong)));
+        connect(job, &KJob::percentChanged, this, &JobMenuAction::slotPercent);
         connect(job, &KJob::suspended, this, &JobMenuAction::updatePauseResumeButton);
         connect(job, &KJob::resumed, this, &JobMenuAction::updatePauseResumeButton);
         connect(job, &KJob::result, this, &JobMenuAction::slotResult);
@@ -277,8 +277,7 @@ void JobMan::manageStartedJob(KrJob *krJob, KJob *kJob)
 
 void JobMan::slotKJobStarted(KJob *job)
 {
-    // KJob has two percent() functions
-    connect(job, SIGNAL(percent(KJob *, ulong)), this, SLOT(slotPercent(KJob *, ulong)));
+    connect(job, &KJob::percentChanged, this, &JobMan::slotPercent);
     connect(job, &KJob::description, this, &JobMan::slotDescription);
     connect(job, &KJob::suspended, this, &JobMan::updateUI);
     connect(job, &KJob::resumed, this, &JobMan::updateUI);
diff --git a/app/Panel/listpanel.cpp b/app/Panel/listpanel.cpp
index e81a87212..fa6c5dd73 100644
--- a/app/Panel/listpanel.cpp
+++ b/app/Panel/listpanel.cpp
@@ -1042,7 +1042,7 @@ void ListPanel::panelHidden()
 void ListPanel::slotPreviewJobStarted(KJob *job)
 {
     previewJob = job;
-    connect(job, SIGNAL(percent(KJob *, ulong)), SLOT(slotPreviewJobPercent(KJob *, ulong)));
+    connect(job, &KJob::percentChanged, this, &ListPanel::slotPreviewJobPercent);
     connect(job, &KJob::result, this, &ListPanel::slotPreviewJobResult);
     cancelProgressButton->setMaximumHeight(sidebarButton->height());
     cancelProgressButton->show();
@@ -1083,7 +1083,7 @@ void ListPanel::slotRefreshJobStarted(KIO::Job *job)
 
     // connect to the job interface to provide in-panel refresh notification
     connect(job, &KIO::Job::infoMessage, this, &ListPanel::inlineRefreshInfoMessage);
-    connect(job, SIGNAL(percentChanged(KJob *, ulong)), SLOT(inlineRefreshPercent(KJob *, ulong)));
+    connect(job, &KIO::Job::percentChanged, this, &ListPanel::inlineRefreshPercent);
     connect(job, &KIO::Job::result, this, &ListPanel::inlineRefreshListResult);
 
     inlineRefreshJob = job;
diff --git a/app/Splitter/combiner.cpp b/app/Splitter/combiner.cpp
index 605f91514..9ffb5c1d7 100644
--- a/app/Splitter/combiner.cpp
+++ b/app/Splitter/combiner.cpp
@@ -234,7 +234,7 @@ void Combiner::openNextFile()
     connect(combineReadJob, &KIO::TransferJob::data, this, &Combiner::combineDataReceived);
     connect(combineReadJob, &KIO::TransferJob::result, this, &Combiner::combineReceiveFinished);
     if (hasValidSplitFile)
-        connect(combineReadJob, SIGNAL(percent(KJob *, ulong)), this, SLOT(combineWritePercent(KJob *, ulong)));
+        connect(combineReadJob, &KJob::percentChanged, this, &Combiner::combineWritePercent);
 }
 
 void Combiner::combineDataReceived(KIO::Job *, const QByteArray &byteArray)
diff --git a/app/Splitter/splitter.cpp b/app/Splitter/splitter.cpp
index f2aff9593..db7fefdfe 100644
--- a/app/Splitter/splitter.cpp
+++ b/app/Splitter/splitter.cpp
@@ -82,7 +82,7 @@ void Splitter::split(KIO::filesize_t splitSizeIn)
 
     connect(splitReadJob, &KIO::TransferJob::data, this, &Splitter::splitDataReceived);
     connect(splitReadJob, &KIO::TransferJob::result, this, &Splitter::splitReceiveFinished);
-    connect(splitReadJob, SIGNAL(percent(KJob *, ulong)), this, SLOT(splitReceivePercent(KJob *, ulong)));
+    connect(splitReadJob, &KJob::percentChanged, this, &Splitter::splitReceivePercent);
 
     exec();
 }
-- 
GitLab


From b5df3c544321e5fa07eef5b3dd738124e83a74ef Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Thu, 20 Jun 2024 12:17:28 +0200
Subject: [PATCH 47/68] Fix wrong position of file drop menu in Wayland

---
 app/FileSystem/defaultfilesystem.cpp  | 5 +++--
 app/FileSystem/defaultfilesystem.h    | 2 +-
 app/FileSystem/filesystem.h           | 2 +-
 app/FileSystem/filesystemprovider.cpp | 4 ++--
 app/FileSystem/filesystemprovider.h   | 2 +-
 app/FileSystem/virtualfilesystem.cpp  | 2 +-
 app/FileSystem/virtualfilesystem.h    | 2 +-
 app/Panel/krfiletreeview.cpp          | 2 +-
 app/Panel/krpanel.h                   | 2 +-
 app/Panel/listpanel.cpp               | 4 ++--
 10 files changed, 14 insertions(+), 13 deletions(-)

diff --git a/app/FileSystem/defaultfilesystem.cpp b/app/FileSystem/defaultfilesystem.cpp
index 2a8584392..ee2f18cd1 100644
--- a/app/FileSystem/defaultfilesystem.cpp
+++ b/app/FileSystem/defaultfilesystem.cpp
@@ -20,7 +20,7 @@
 #include <KIO/ListJob>
 #include <KIO/MkdirJob>
 #include <KIO/MkpathJob>
-#include <KIO/FileSystemFreeSpaceJob>
+#include <KJobWidgets>
 #include <KLocalizedString>
 #include <KMountPoint>
 #include <KProtocolManager>
@@ -65,7 +65,7 @@ void DefaultFileSystem::copyFiles(const QList<QUrl> &urls,
     krJobMan->manageJob(krJob, startMode);
 }
 
-void DefaultFileSystem::dropFiles(const QUrl &destination, QDropEvent *event)
+void DefaultFileSystem::dropFiles(const QUrl &destination, QDropEvent *event, QWidget *targetWidget)
 {
     qDebug() << "destination=" << destination;
 
@@ -73,6 +73,7 @@ void DefaultFileSystem::dropFiles(const QUrl &destination, QDropEvent *event)
     const QUrl dest = resolveRelativePath(destination);
 
     KIO::DropJob *job = KIO::drop(event, dest);
+    KJobWidgets::setWindow(job, targetWidget);
 
     // NOTE: a DropJob "starts" with showing a menu. If the operation is chosen (copy/move/link)
     // the actual CopyJob starts automatically - we cannot manage the start of the CopyJob (see
diff --git a/app/FileSystem/defaultfilesystem.h b/app/FileSystem/defaultfilesystem.h
index 3e8a868ea..5af104af1 100644
--- a/app/FileSystem/defaultfilesystem.h
+++ b/app/FileSystem/defaultfilesystem.h
@@ -39,7 +39,7 @@ public:
                    KIO::CopyJob::CopyMode mode = KIO::CopyJob::Copy,
                    bool showProgressInfo = true,
                    JobMan::StartMode startMode = JobMan::Default) override;
-    void dropFiles(const QUrl &destination, QDropEvent *event) override;
+    void dropFiles(const QUrl &destination, QDropEvent *event, QWidget *targetWidget) override;
 
     void addFiles(const QList<QUrl> &fileUrls, KIO::CopyJob::CopyMode mode, const QString &dir = "") override;
     void mkDir(const QString &name) override;
diff --git a/app/FileSystem/filesystem.h b/app/FileSystem/filesystem.h
index d310ac1ad..636b3855d 100644
--- a/app/FileSystem/filesystem.h
+++ b/app/FileSystem/filesystem.h
@@ -75,7 +75,7 @@ public:
                            bool showProgressInfo = true,
                            JobMan::StartMode startMode = JobMan::Default) = 0;
     /// Handle file dropping in this filesystem. Destination is absolute URL. May implemented async.
-    virtual void dropFiles(const QUrl &destination, QDropEvent *event) = 0;
+    virtual void dropFiles(const QUrl &destination, QDropEvent *event, QWidget *targetWidget) = 0;
 
     /// Copy (copy, move or link) files to the current filesystem directory or to "dir", the
     /// directory name relative to the current dir. May implemented async.
diff --git a/app/FileSystem/filesystemprovider.cpp b/app/FileSystem/filesystemprovider.cpp
index 0d0f47282..03fa7a677 100644
--- a/app/FileSystem/filesystemprovider.cpp
+++ b/app/FileSystem/filesystemprovider.cpp
@@ -49,10 +49,10 @@ void FileSystemProvider::startCopyFiles(const QList<QUrl> &urls,
     fs->copyFiles(urls, destination, mode, showProgressInfo, startMode);
 }
 
-void FileSystemProvider::startDropFiles(QDropEvent *event, const QUrl &destination)
+void FileSystemProvider::startDropFiles(QDropEvent *event, const QUrl &destination, QWidget *targetWidget)
 {
     FileSystem *fs = getFilesystemInstance(destination);
-    fs->dropFiles(destination, event);
+    fs->dropFiles(destination, event, targetWidget);
 }
 
 void FileSystemProvider::startDeleteFiles(const QList<QUrl> &urls, bool moveToTrash)
diff --git a/app/FileSystem/filesystemprovider.h b/app/FileSystem/filesystemprovider.h
index 0f278555a..972c03849 100644
--- a/app/FileSystem/filesystemprovider.h
+++ b/app/FileSystem/filesystemprovider.h
@@ -52,7 +52,7 @@ public:
      *
      * Operation may implemented async depending on destination filesystem.
      */
-    void startDropFiles(QDropEvent *event, const QUrl &destination);
+    void startDropFiles(QDropEvent *event, const QUrl &destination, QWidget *targetWidget);
 
     /**
      * Start a delete job for trashing or deleting files.
diff --git a/app/FileSystem/virtualfilesystem.cpp b/app/FileSystem/virtualfilesystem.cpp
index 8df32e871..731080ca1 100644
--- a/app/FileSystem/virtualfilesystem.cpp
+++ b/app/FileSystem/virtualfilesystem.cpp
@@ -72,7 +72,7 @@ void VirtualFileSystem::copyFiles(const QList<QUrl> &urls,
     emit fileSystemChanged(QUrl("virt:///" + dir), false); // may call refresh()
 }
 
-void VirtualFileSystem::dropFiles(const QUrl &destination, QDropEvent *event)
+void VirtualFileSystem::dropFiles(const QUrl &destination, QDropEvent *event, QWidget *targetWidget)
 {
     const QList<QUrl> &urls = KUrlMimeData::urlsFromMimeData(event->mimeData());
     // dropping on virtual filesystem is always copy operation
diff --git a/app/FileSystem/virtualfilesystem.h b/app/FileSystem/virtualfilesystem.h
index 2ff0c838f..56d92bdbb 100644
--- a/app/FileSystem/virtualfilesystem.h
+++ b/app/FileSystem/virtualfilesystem.h
@@ -42,7 +42,7 @@ public:
                    bool showProgressInfo = false,
                    JobMan::StartMode startMode = JobMan::Start) override;
     /// Handle file dropping in this filesystem: Always creates virtual files.
-    void dropFiles(const QUrl &destination, QDropEvent *event) override;
+    void dropFiles(const QUrl &destination, QDropEvent *event, QWidget *targetWidget) override;
 
     /// Add virtual files to the current directory.
     void addFiles(const QList<QUrl> &fileUrls, KIO::CopyJob::CopyMode mode = KIO::CopyJob::Copy, const QString &dir = "") override;
diff --git a/app/Panel/krfiletreeview.cpp b/app/Panel/krfiletreeview.cpp
index 181fd6bba..faa9244f3 100644
--- a/app/Panel/krfiletreeview.cpp
+++ b/app/Panel/krfiletreeview.cpp
@@ -160,7 +160,7 @@ void KrFileTreeView::dropEvent(QDropEvent *event)
         return;
     }
 
-    FileSystemProvider::instance().startDropFiles(event, destination);
+    FileSystemProvider::instance().startDropFiles(event, destination, this);
 }
 
 void KrFileTreeView::slotExpanded(const QModelIndex &baseIndex)
diff --git a/app/Panel/krpanel.h b/app/Panel/krpanel.h
index a6250e6f9..b0455e509 100644
--- a/app/Panel/krpanel.h
+++ b/app/Panel/krpanel.h
@@ -40,7 +40,7 @@ public:
 
     ListPanel *const gui;
     ListPanelFunc *const func;
-    KrView *view;
+    KrView *view; // the view of file items in this panel
 
 protected:
     AbstractPanelManager *_manager;
diff --git a/app/Panel/listpanel.cpp b/app/Panel/listpanel.cpp
index fa6c5dd73..f72d07093 100644
--- a/app/Panel/listpanel.cpp
+++ b/app/Panel/listpanel.cpp
@@ -867,7 +867,7 @@ void ListPanel::handleDrop(QDropEvent *event, bool onView)
     QUrl destination = QUrl(virtualPath());
     destination.setPath(destination.path() + '/' + destinationDir);
 
-    func->files()->dropFiles(destination, event);
+    func->files()->dropFiles(destination, event, view->widget());
 
     if (KConfigGroup(krConfig, "Look&Feel").readEntry("UnselectBeforeOperation", _UnselectBeforeOperation)) {
         KrPanel *p = dragFromThisPanel ? this : otherPanel();
@@ -878,7 +878,7 @@ void ListPanel::handleDrop(QDropEvent *event, bool onView)
 
 void ListPanel::handleDrop(const QUrl &destination, QDropEvent *event)
 {
-    func->files()->dropFiles(destination, event);
+    func->files()->dropFiles(destination, event, view->widget());
 }
 
 void ListPanel::startDragging(const QStringList &names, const QPixmap &px)
-- 
GitLab


From ee6a425044a8430eaed990dd137aac5cf66e638e Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Thu, 20 Jun 2024 14:48:19 +0200
Subject: [PATCH 48/68] Fix click on system tray icon does not toggle window
 state

Same bugfix in KTorrent with more detailed description: network/ktorrent!114
---
 app/krusader.cpp | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/app/krusader.cpp b/app/krusader.cpp
index 825efbfa6..033aba6f3 100644
--- a/app/krusader.cpp
+++ b/app/krusader.cpp
@@ -245,6 +245,11 @@ Krusader::Krusader(const QCommandLineParser &parser)
         show();
     }
 
+    if (sysTray) {
+        // (re)set main window for system tray, Qt loses the window handle after showing the window
+        sysTray->setAssociatedWindow(this->windowHandle());
+    }
+
     KrTrashHandler::startWatcher();
     isStarting = false;
 
-- 
GitLab


From ee9eb33cbb57a7c369b942ad485ebb1ecb3e6058 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Thu, 20 Jun 2024 16:32:18 +0200
Subject: [PATCH 49/68] Fix file filter of import and export dialog for user
 actions

---
 app/ActionMan/useractionpage.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/ActionMan/useractionpage.cpp b/app/ActionMan/useractionpage.cpp
index 353c5f298..6e40817c2 100644
--- a/app/ActionMan/useractionpage.cpp
+++ b/app/ActionMan/useractionpage.cpp
@@ -35,7 +35,7 @@
 #include "useractionlistview.h"
 
 // This is the filter in the QFileDialog of Import/Export:
-static const KLazyLocalizedString FILE_FILTER = kli18n("*.xml|XML files\n*|All files");
+static constexpr KLazyLocalizedString FILE_FILTER = kli18n("XML files (*.xml);;All files (*)");
 
 UserActionPage::UserActionPage(QWidget *parent)
     : QWidget(parent)
-- 
GitLab


From ad2261e20cf705204332e47bde6f00a97526a371 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Wed, 26 Jun 2024 12:38:10 +0200
Subject: [PATCH 50/68] Fix unmounted filesystems not shown in MountMan

---
 app/MountMan/kmountmangui.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/MountMan/kmountmangui.cpp b/app/MountMan/kmountmangui.cpp
index 576254d45..7bb3e57a0 100644
--- a/app/MountMan/kmountmangui.cpp
+++ b/app/MountMan/kmountmangui.cpp
@@ -238,10 +238,10 @@ void KMountManGUI::getSpaceData()
         timer.start(100); // 100ms Maybe this should be configurable
         loop.exec();
     }
-    updateList();
 
     this->setCursor(Qt::ArrowCursor);
     addNonMounted();
+    updateList();
 }
 
 void KMountManGUI::freeSpaceResult(KJob *job, fsData data)
-- 
GitLab


From af94d8e6499eb11bd45df7833071e32ac15a2509 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Wed, 26 Jun 2024 16:01:30 +0200
Subject: [PATCH 51/68] Synchronizer: Fix showing rename dialog for existing
 desting file

---
 app/Synchronizer/synchronizer.cpp | 113 ++++++++++++++----------------
 1 file changed, 54 insertions(+), 59 deletions(-)

diff --git a/app/Synchronizer/synchronizer.cpp b/app/Synchronizer/synchronizer.cpp
index cd70a12e9..3d3d4443b 100644
--- a/app/Synchronizer/synchronizer.cpp
+++ b/app/Synchronizer/synchronizer.cpp
@@ -1319,69 +1319,64 @@ void Synchronizer::slotTaskFinished(KJob *job)
             }
         } else {
             if (job->error() == KIO::ERR_FILE_ALREADY_EXIST && item->task() != TT_DELETE) {
-
-                if (autoSkip)
+                if (autoSkip) {
                     break;
+                }
 
-                if (auto *askUserActionInterface = dynamic_cast<KIO::AskUserActionInterface *>(job->uiDelegate())) {
-                    auto renameSignal = &KIO::AskUserActionInterface::askUserRenameResult;
-                    QEventLoop loop;
-                    QObject::connect(askUserActionInterface, renameSignal, job, [=, this]( KIO::RenameDialog_Result result, const QUrl & newUrl, KJob *parentJob) {
-                        Q_ASSERT(parentJob == job);
+                QUrl srcUrl, destUrl;
+                KIO::filesize_t srcSize, destSize;
+                time_t srcTime, destTime;
+                if (item->task() == TT_COPY_TO_LEFT) {
+                    srcUrl = rightURL;
+                    destUrl = leftURL;
+                    srcSize = item->rightSize();
+                    destSize = item->leftSize();
+                    srcTime = item->rightDate();
+                    destTime = item->leftDate();
+                } else {
+                    srcUrl = leftURL;
+                    destUrl = rightURL;
+                    srcSize = item->leftSize();
+                    destSize = item->rightSize();
+                    srcTime = item->leftDate();
+                    destTime = item->rightDate();
+                }
 
-                        switch (result) {
-                        case KIO::Result_Rename:
-                            item->setDestination(newUrl.toString());
-                            executeTask(item);
-                            inTaskFinished--;
-                            return;
-                        case KIO::Result_Overwrite:
-                            item->setOverWrite();
-                            executeTask(item);
-                            inTaskFinished--;
-                            return;
-                        case KIO::Result_OverwriteAll:
-                            overWrite = true;
-                            executeTask(item);
-                            inTaskFinished--;
-                            return;
-                        case KIO::Result_AutoSkip:
-                            autoSkip = true;
-                        case KIO::Result_Skip:
-                        default:
-                            break;
-                        }
-                    });
-                    connect(askUserActionInterface, renameSignal, &loop, &QEventLoop::quit );
-                    //TODO: What is the correct call here?
-                    if (item->task() == TT_COPY_TO_LEFT) {
-                        askUserActionInterface->askUserRename(job,
-                                                i18n("File Already Exists"),
-                                                rightURL,
-                                                leftURL,
-                                                KIO::RenameDialog_Overwrite | KIO::RenameDialog_Skip | KIO::RenameDialog_MultipleItems,
-                                                item->rightSize(),
-                                                item->leftSize(),
-                                                QDateTime(),
-                                                QDateTime(),
-                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())),
-                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())));
-                    } else {
-                        askUserActionInterface->askUserRename(job,
-                                                i18n("File Already Exists"),
-                                                leftURL,
-                                                rightURL,
-                                                KIO::RenameDialog_Overwrite | KIO::RenameDialog_Skip | KIO::RenameDialog_MultipleItems,
-                                                item->leftSize(),
-                                                item->rightSize(),
-                                                QDateTime(),
-                                                QDateTime(),
-                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->leftDate())),
-                                                QDateTime::fromSecsSinceEpoch(static_cast<uint>(item->rightDate())));
-                    }
-                    // Wait till the quit the quit signal is emmited above, is this enough??
-                    loop.exec();
+                KIO::RenameDialog dialog(syncDlgWidget,
+                                         i18n("File Already Exists"),
+                                         srcUrl,
+                                         destUrl,
+                                         KIO::RenameDialog_Overwrite | KIO::RenameDialog_Skip | KIO::RenameDialog_MultipleItems,
+                                         srcSize,
+                                         destSize,
+                                         QDateTime(),
+                                         QDateTime(),
+                                         QDateTime::fromSecsSinceEpoch(static_cast<uint>(srcTime)),
+                                         QDateTime::fromSecsSinceEpoch(static_cast<uint>(destTime)));
+
+                switch (dialog.exec()) {
+                case KIO::Result_Rename:
+                    item->setDestination(dialog.newDestUrl().toString());
+                    executeTask(item);
+                    inTaskFinished--;
+                    return;
+                case KIO::Result_Overwrite:
+                    item->setOverWrite();
+                    executeTask(item);
+                    inTaskFinished--;
+                    return;
+                case KIO::Result_OverwriteAll:
+                    overWrite = true;
+                    executeTask(item);
+                    inTaskFinished--;
+                    return;
+                case KIO::Result_AutoSkip:
+                    autoSkip = true;
+                case KIO::Result_Skip:
+                default:
+                    break;
                 }
+
                 break;
             }
 
-- 
GitLab


From 0b2f5240dbcf85d05b7c2c7e7921b0af8c5df2c6 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Wed, 26 Jun 2024 16:51:50 +0200
Subject: [PATCH 52/68] Synchronizer: Fix showing skip dialog for non-existing
 source file

---
 app/Synchronizer/synchronizer.cpp | 32 +++++++++++--------------------
 1 file changed, 11 insertions(+), 21 deletions(-)

diff --git a/app/Synchronizer/synchronizer.cpp b/app/Synchronizer/synchronizer.cpp
index 3d3d4443b..56446c5bd 100644
--- a/app/Synchronizer/synchronizer.cpp
+++ b/app/Synchronizer/synchronizer.cpp
@@ -1404,27 +1404,17 @@ void Synchronizer::slotTaskFinished(KJob *job)
                     break;
                 }
 
-                if (auto *askUserActionInterface = dynamic_cast<KIO::AskUserActionInterface *>(job->uiDelegate())) {
-                    auto skipSignal = &KIO::AskUserActionInterface::askUserSkipResult;
-                    QEventLoop loop;
-                    QObject::connect(askUserActionInterface, skipSignal, job, [=, this](KIO::SkipDialog_Result result, KJob *parentJob) {
-                        Q_ASSERT(parentJob == job);
-
-                        switch (result) {
-                        case KIO::Result_Cancel:
-                            executeTask(item); /* simply retry */
-                            inTaskFinished--;
-                            return;
-                        case KIO::Result_AutoSkip:
-                            autoSkip = true;
-                        default:
-                            break;
-                        }
-                    });
-                    connect(askUserActionInterface, skipSignal, &loop, &QEventLoop::quit );
-                    askUserActionInterface->askUserSkip(job, KIO::SkipDialog_MultipleItems, error);
-                    // Wait till the quit the quit signal is emmited above, is this enough??
-                    loop.exec();
+                KIO::SkipDialog dialog(syncDlgWidget, KIO::SkipDialog_MultipleItems, error);
+
+                switch (dialog.exec()) {
+                case KIO::Result_Cancel:
+                    executeTask(item); /* simply retry */
+                    inTaskFinished--;
+                    return;
+                case KIO::Result_AutoSkip:
+                    autoSkip = true;
+                default:
+                    break;
                 }
             }
         }
-- 
GitLab


From 09c7c7c5794de71664af9a0e7e81dd81c0c6bef8 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Tue, 2 Jul 2024 16:03:42 +0200
Subject: [PATCH 53/68] Move usage of FileSystem/sizecalculator.h closer to
 usage

---
 app/GUI/krremoteencodingmenu.cpp | 1 -
 app/Panel/panelfunc.h            | 3 ++-
 2 files changed, 2 insertions(+), 2 deletions(-)

diff --git a/app/GUI/krremoteencodingmenu.cpp b/app/GUI/krremoteencodingmenu.cpp
index 4f36f8ab5..0a4a8841e 100644
--- a/app/GUI/krremoteencodingmenu.cpp
+++ b/app/GUI/krremoteencodingmenu.cpp
@@ -21,7 +21,6 @@
 #include <KLocalizedString>
 #include <KProtocolManager>
 
-#include "../FileSystem/sizecalculator.h"
 #include "../Panel/krpanel.h"
 #include "../Panel/panelfunc.h"
 #include "../compat.h"
diff --git a/app/Panel/panelfunc.h b/app/Panel/panelfunc.h
index 5a94eb805..4e435172a 100644
--- a/app/Panel/panelfunc.h
+++ b/app/Panel/panelfunc.h
@@ -20,12 +20,13 @@
 #include <KJob>
 #include <KService>
 
+#include "../FileSystem/sizecalculator.h"
+
 class DirHistoryQueue;
 class FileItem;
 class FileSystem;
 class KrViewItem;
 class ListPanel;
-class SizeCalculator;
 
 class ListPanelFunc : public QObject
 {
-- 
GitLab


From 934541dceef8d36dff519014733fec21b5fa6b38 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Tue, 2 Jul 2024 16:57:21 +0200
Subject: [PATCH 54/68] Set C++17 as explicit C++ standard for compiler

---
 CMakeLists.txt | 2 ++
 1 file changed, 2 insertions(+)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index a9307923f..9b60b5628 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -5,6 +5,8 @@ project(krusader)
 set(VERSION "2.9.0-dev")
 set(RELEASE_NAME "Bleeding Edge")
 
+set(CMAKE_CXX_STANDARD 17)
+
 set(MIN_QT_VERSION "6.4.0")
 set(KF6_MIN_VERSION "5.240.0")
 
-- 
GitLab


From 7ea0bc4e6bac5871286d66e1249e9ceee62cb051 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Tue, 2 Jul 2024 16:31:57 +0200
Subject: [PATCH 55/68] Replace qAsConst() by std::as_const() globally

---
 app/Archive/abstractthreadedjob.cpp      |  2 +-
 app/GUI/kfnkeys.cpp                      |  2 +-
 app/JobMan/jobman.cpp                    | 10 +++++-----
 app/KViewer/lister.cpp                   |  4 ++--
 app/Konfigurator/kgprotocols.cpp         |  2 +-
 app/Konfigurator/konfiguratoritems.cpp   |  2 +-
 app/Panel/PanelView/krinterbriefview.cpp |  2 +-
 app/Panel/PanelView/krinterview.cpp      |  4 ++--
 app/Panel/PanelView/krviewfactory.cpp    |  4 ++--
 app/Panel/PanelView/listmodel.cpp        |  4 ++--
 app/Panel/dirhistoryqueue.cpp            |  2 +-
 app/Panel/krlayoutfactory.cpp            |  4 ++--
 app/Panel/listpanelactions.cpp           |  2 +-
 app/Panel/panelcontextmenu.cpp           |  2 +-
 app/Search/krsearchdialog.cpp            |  2 +-
 app/UserAction/useraction.cpp            |  6 +++---
 app/krservices.cpp                       |  2 +-
 17 files changed, 28 insertions(+), 28 deletions(-)

diff --git a/app/Archive/abstractthreadedjob.cpp b/app/Archive/abstractthreadedjob.cpp
index 2b73c4daa..1a789f7ff 100644
--- a/app/Archive/abstractthreadedjob.cpp
+++ b/app/Archive/abstractthreadedjob.cpp
@@ -546,7 +546,7 @@ bool AbstractJobThread::uploadTempFiles()
             QList<QUrl> urlList;
             QDir tempDir(_tempDirName);
             QStringList list = tempDir.entryList();
-            for (const QString &name : qAsConst(list)) {
+            for (const QString &name : std::as_const(list)) {
                 if (name == "." || name == "..")
                     continue;
                 QUrl url = QUrl::fromLocalFile(_tempDirName).adjusted(QUrl::StripTrailingSlash);
diff --git a/app/GUI/kfnkeys.cpp b/app/GUI/kfnkeys.cpp
index 6fcfd77d2..852a4e3d8 100644
--- a/app/GUI/kfnkeys.cpp
+++ b/app/GUI/kfnkeys.cpp
@@ -35,7 +35,7 @@ KFnKeys::KFnKeys(QWidget *parent, KrMainWindow *mainWindow)
     layout->setSpacing(0);
 
     int pos = 0;
-    for (QPair<QPushButton *, QPair<QAction *, const QString &>> entry : qAsConst(buttonList)) {
+    for (QPair<QPushButton *, QPair<QAction *, const QString &>> entry : std::as_const(buttonList)) {
         layout->addWidget(entry.first, 0, pos++);
     }
     layout->activate();
diff --git a/app/JobMan/jobman.cpp b/app/JobMan/jobman.cpp
index f7b741930..57417cb5a 100644
--- a/app/JobMan/jobman.cpp
+++ b/app/JobMan/jobman.cpp
@@ -232,7 +232,7 @@ bool JobMan::waitForJobs(bool waitForUserInput)
     m_messageBox->addButton(QMessageBox::Abort);
     m_messageBox->addButton(QMessageBox::Cancel);
     m_messageBox->setDefaultButton(QMessageBox::Cancel);
-    for (KrJob *job : qAsConst(m_jobs))
+    for (KrJob *job : std::as_const(m_jobs))
         connect(job, &KrJob::terminated, this, &JobMan::slotUpdateMessageBox);
     slotUpdateMessageBox();
 
@@ -242,7 +242,7 @@ bool JobMan::waitForJobs(bool waitForUserInput)
 
     // accepted -> cancel all jobs
     if (result == QMessageBox::Abort) {
-        for (KrJob *job : qAsConst(m_jobs)) {
+        for (KrJob *job : std::as_const(m_jobs)) {
             job->cancel();
         }
         return true;
@@ -295,7 +295,7 @@ void JobMan::slotControlActionTriggered()
     if (!anyRunning && m_queueMode) {
         m_jobs.first()->start();
     } else {
-        for (KrJob *job : qAsConst(m_jobs)) {
+        for (KrJob *job : std::as_const(m_jobs)) {
             if (anyRunning)
                 job->pause();
             else
@@ -327,7 +327,7 @@ void JobMan::slotTerminated(KrJob *krJob)
     // NOTE: ignoring queue mode here. We assume that if queue mode is turned off, the user created
     // jobs which were not already started with a "queue" option and still wants queue behaviour.
     if (!m_jobs.isEmpty() && !jobsAreRunning()) {
-        for (KrJob *job : qAsConst(m_jobs)) {
+        for (KrJob *job : std::as_const(m_jobs)) {
             if (!job->isPaused()) {
                 // start next job
                 job->start();
@@ -409,7 +409,7 @@ void JobMan::cleanupMenu()
 void JobMan::updateUI()
 {
     int totalPercent = 0;
-    for (KrJob *job : qAsConst(m_jobs)) {
+    for (KrJob *job : std::as_const(m_jobs)) {
         totalPercent += job->percent();
     }
     const bool hasJobs = !m_jobs.isEmpty();
diff --git a/app/KViewer/lister.cpp b/app/KViewer/lister.cpp
index 0e635318c..86170af2d 100644
--- a/app/KViewer/lister.cpp
+++ b/app/KViewer/lister.cpp
@@ -266,7 +266,7 @@ void ListerTextArea::getScreenPosition(const int position, int &x, int &y)
 {
     x = position;
     y = 0;
-    for (const QString &row : qAsConst(_rowContent)) {
+    for (const QString &row : std::as_const(_rowContent)) {
         const int rowLen = row.length() + 1;
         if (x < rowLen) {
             return;
@@ -2064,7 +2064,7 @@ void Lister::print()
 
         painter.setFont(fixedFont);
         int yOffset = normalFontHeight + 1;
-        for (const QString &row : qAsConst(rows)) {
+        for (const QString &row : std::as_const(rows)) {
             painter.drawText(0, yOffset + fixedFontHeight, row);
             yOffset += fixedFontHeight;
         }
diff --git a/app/Konfigurator/kgprotocols.cpp b/app/Konfigurator/kgprotocols.cpp
index 60aa3db92..34eb09357 100644
--- a/app/Konfigurator/kgprotocols.cpp
+++ b/app/Konfigurator/kgprotocols.cpp
@@ -127,7 +127,7 @@ void KgProtocols::loadProtocols()
     QStringList protocols = KProtocolInfo::protocols();
     protocols.sort();
 
-    for (const QString &protocol : qAsConst(protocols)) {
+    for (const QString &protocol : std::as_const(protocols)) {
         QUrl u;
         u.setScheme(protocol);
         if (KProtocolManager::inputType(u) == KProtocolInfo::T_FILESYSTEM) {
diff --git a/app/Konfigurator/konfiguratoritems.cpp b/app/Konfigurator/konfiguratoritems.cpp
index 1f0d98fc0..52130e4e3 100644
--- a/app/Konfigurator/konfiguratoritems.cpp
+++ b/app/Konfigurator/konfiguratoritems.cpp
@@ -128,7 +128,7 @@ void KonfiguratorCheckBox::addDep(KonfiguratorCheckBox *dep)
 
 void KonfiguratorCheckBox::updateDeps()
 {
-    for (KonfiguratorCheckBox *dep : qAsConst(deps))
+    for (KonfiguratorCheckBox *dep : std::as_const(deps))
         dep->setEnabled(isChecked());
 }
 
diff --git a/app/Panel/PanelView/krinterbriefview.cpp b/app/Panel/PanelView/krinterbriefview.cpp
index 3c1a9d3b7..0691bf241 100644
--- a/app/Panel/PanelView/krinterbriefview.cpp
+++ b/app/Panel/PanelView/krinterbriefview.cpp
@@ -404,7 +404,7 @@ void KrInterBriefView::paintEvent(QPaintEvent *e)
     area.adjust(horizontalOffset(), verticalOffset(), horizontalOffset(), verticalOffset());
     intersectionSet(area, intersectVector);
 
-    for (const QModelIndex &mndx : qAsConst(intersectVector)) {
+    for (const QModelIndex &mndx : std::as_const(intersectVector)) {
         option.rect = visualRect(mndx);
         painter.save();
 
diff --git a/app/Panel/PanelView/krinterview.cpp b/app/Panel/PanelView/krinterview.cpp
index 5f0ed8b65..61d7e3384 100644
--- a/app/Panel/PanelView/krinterview.cpp
+++ b/app/Panel/PanelView/krinterview.cpp
@@ -358,7 +358,7 @@ KIO::filesize_t KrInterView::calcSize()
 KIO::filesize_t KrInterView::calcSelectedSize()
 {
     KIO::filesize_t size = 0;
-    for (const FileItem *fileitem : qAsConst(_selection)) {
+    for (const FileItem *fileitem : std::as_const(_selection)) {
         size += fileitem->getSize();
     }
     return size;
@@ -367,7 +367,7 @@ KIO::filesize_t KrInterView::calcSelectedSize()
 QList<QUrl> KrInterView::selectedUrls()
 {
     QList<QUrl> list;
-    for (const FileItem *fileitem : qAsConst(_selection)) {
+    for (const FileItem *fileitem : std::as_const(_selection)) {
         list << fileitem->getUrl();
     }
     return list;
diff --git a/app/Panel/PanelView/krviewfactory.cpp b/app/Panel/PanelView/krviewfactory.cpp
index 5af2eec98..fc2e8949a 100644
--- a/app/Panel/PanelView/krviewfactory.cpp
+++ b/app/Panel/PanelView/krviewfactory.cpp
@@ -86,12 +86,12 @@ void KrViewFactory::registerView(KrViewInstance *inst)
 
 KrViewInstance *KrViewFactory::viewInstance(int id)
 {
-    for (KrViewInstance *inst : qAsConst(m_registeredViews)) {
+    for (KrViewInstance *inst : std::as_const(m_registeredViews)) {
         if (inst->id() == id)
             return inst;
     }
 
-    for (KrViewInstance *inst_dflt : qAsConst(m_registeredViews)) {
+    for (KrViewInstance *inst_dflt : std::as_const(m_registeredViews)) {
         if (inst_dflt->id() == m_defaultViewId)
             return inst_dflt;
     }
diff --git a/app/Panel/PanelView/listmodel.cpp b/app/Panel/PanelView/listmodel.cpp
index ec2d44069..ac93f4420 100644
--- a/app/Panel/PanelView/listmodel.cpp
+++ b/app/Panel/PanelView/listmodel.cpp
@@ -291,7 +291,7 @@ void ListModel::sort(int column, Qt::SortOrder order)
     }
 
     QModelIndexList newPersistentList;
-    for (const QModelIndex &mndx : qAsConst(oldPersistentList))
+    for (const QModelIndex &mndx : std::as_const(oldPersistentList))
         newPersistentList << index(changeMap[mndx.row()], mndx.column());
 
     changePersistentIndexList(oldPersistentList, newPersistentList);
@@ -329,7 +329,7 @@ QModelIndex ListModel::addItem(FileItem *fileitem)
     }
 
     QModelIndexList newPersistentList;
-    for (const QModelIndex &mndx : qAsConst(oldPersistentList)) {
+    for (const QModelIndex &mndx : std::as_const(oldPersistentList)) {
         int newRow = mndx.row();
         if (newRow >= insertIndex)
             newRow++;
diff --git a/app/Panel/dirhistoryqueue.cpp b/app/Panel/dirhistoryqueue.cpp
index b333a688d..cb93fd5bd 100644
--- a/app/Panel/dirhistoryqueue.cpp
+++ b/app/Panel/dirhistoryqueue.cpp
@@ -121,7 +121,7 @@ void DirHistoryQueue::save(KConfigGroup cfg)
     saveCurrentItem();
 
     QList<QUrl> urls;
-    for (const QUrl &url : qAsConst(_urlQueue)) {
+    for (const QUrl &url : std::as_const(_urlQueue)) {
         // make sure no passwords are permanently stored
         QUrl safeUrl(url);
         safeUrl.setPassword(QString());
diff --git a/app/Panel/krlayoutfactory.cpp b/app/Panel/krlayoutfactory.cpp
index a28ca2544..b7eeced9c 100644
--- a/app/Panel/krlayoutfactory.cpp
+++ b/app/Panel/krlayoutfactory.cpp
@@ -142,7 +142,7 @@ QStringList KrLayoutFactory::layoutNames()
     if (parseFiles()) {
         getLayoutNames(_mainDoc, names);
 
-        for (const QDomDocument &doc : qAsConst(_extraDocs))
+        for (const QDomDocument &doc : std::as_const(_extraDocs))
             getLayoutNames(doc, names);
     }
 
@@ -174,7 +174,7 @@ QLayout *KrLayoutFactory::createLayout(QString layoutName)
 
         layoutRoot = findLayout(_mainDoc, layoutName);
         if (layoutRoot.isNull()) {
-            for (const QDomDocument &doc : qAsConst(_extraDocs)) {
+            for (const QDomDocument &doc : std::as_const(_extraDocs)) {
                 layoutRoot = findLayout(doc, layoutName);
                 if (!layoutRoot.isNull())
                     break;
diff --git a/app/Panel/listpanelactions.cpp b/app/Panel/listpanelactions.cpp
index 4c953b633..e0cd5e258 100644
--- a/app/Panel/listpanelactions.cpp
+++ b/app/Panel/listpanelactions.cpp
@@ -145,7 +145,7 @@ void ListPanelActions::activePanelChanged()
 void ListPanelActions::guiUpdated()
 {
     QList<QAction *> actions;
-    for (QAction *action : qAsConst(setViewActions))
+    for (QAction *action : std::as_const(setViewActions))
         actions << action;
     static_cast<KrMainWindow *>(_mainWindow)->plugActionList("view_actionlist", actions);
 }
diff --git a/app/Panel/panelcontextmenu.cpp b/app/Panel/panelcontextmenu.cpp
index e0f92d30f..506fb8be4 100644
--- a/app/Panel/panelcontextmenu.cpp
+++ b/app/Panel/panelcontextmenu.cpp
@@ -64,7 +64,7 @@ void PanelContextMenu::addCompressAndExtractPluginActions()
         return metaData.pluginId() == "compressfileitemaction" || metaData.pluginId() == "extractfileitemaction";
     });
 
-    for (const KPluginMetaData &jsonMetadata : qAsConst(jsonPlugins)) {
+    for (const KPluginMetaData &jsonMetadata : std::as_const(jsonPlugins)) {
         KPluginFactory *pluginFactory = KPluginFactory::loadFactory(jsonMetadata.fileName()).plugin;
 
         auto *abstractPlugin = pluginFactory->create<KAbstractFileItemActionPlugin>();
diff --git a/app/Search/krsearchdialog.cpp b/app/Search/krsearchdialog.cpp
index 90146ae56..bd8d76b8e 100644
--- a/app/Search/krsearchdialog.cpp
+++ b/app/Search/krsearchdialog.cpp
@@ -85,7 +85,7 @@ public:
     void clear()
     {
         emit cleared();
-        for (FileItem *fileitem : qAsConst(_fileItems))
+        for (FileItem *fileitem : std::as_const(_fileItems))
             delete fileitem;
         _fileItems.clear();
         _foundText.clear();
diff --git a/app/UserAction/useraction.cpp b/app/UserAction/useraction.cpp
index c48bf6801..6c043667b 100644
--- a/app/UserAction/useraction.cpp
+++ b/app/UserAction/useraction.cpp
@@ -73,7 +73,7 @@ void UserAction::populateMenu(KActionMenu *menu, const QUrl *currentURL)
     QMap<QString, KActionMenu *> categoryMap;
     QList<KrAction *> uncategorised;
 
-    for (KrAction *action : qAsConst(_actions)) {
+    for (KrAction *action : std::as_const(_actions)) {
         const QString category = action->category();
         if (!action->isEnabled())
             continue;
@@ -98,7 +98,7 @@ void UserAction::populateMenu(KActionMenu *menu, const QUrl *currentURL)
         menu->addAction(mapIter.value());
     }
 
-    for (KrAction *action : qAsConst(uncategorised)) {
+    for (KrAction *action : std::as_const(uncategorised)) {
         menu->addAction(action);
     };
 }
@@ -249,7 +249,7 @@ bool UserAction::writeActionFile()
     QDomDocument doc = createEmptyDoc();
     QDomElement root = doc.documentElement();
 
-    for (const QString &name : qAsConst(_deletedActions)) {
+    for (const QString &name : std::as_const(_deletedActions)) {
         QDomElement element = doc.createElement("deletedAction");
         element.setAttribute("name", name);
         root.appendChild(element);
diff --git a/app/krservices.cpp b/app/krservices.cpp
index 4028d8b24..6865f336d 100644
--- a/app/krservices.cpp
+++ b/app/krservices.cpp
@@ -70,7 +70,7 @@ QString KrServices::fullPathName(const QString &name, QString confName)
 
 QString KrServices::chooseFullPathName(QStringList names, const QString &confName)
 {
-    for (const QString &name : qAsConst(names)) {
+    for (const QString &name : std::as_const(names)) {
         QString foundTool = KrServices::fullPathName(name, confName);
         if (!foundTool.isEmpty()) {
             return foundTool;
-- 
GitLab


From 1b2095d51078ea3169c5e5e550fc3c78649bd8bc Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Wed, 3 Jul 2024 18:00:30 +0200
Subject: [PATCH 56/68] Add KrBookmarkHandler as parent of KBookmarkManager

---
 app/BookMan/krbookmarkhandler.cpp | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/app/BookMan/krbookmarkhandler.cpp b/app/BookMan/krbookmarkhandler.cpp
index ccb39f033..b69ec7c7e 100644
--- a/app/BookMan/krbookmarkhandler.cpp
+++ b/app/BookMan/krbookmarkhandler.cpp
@@ -70,7 +70,7 @@ KrBookmarkHandler::KrBookmarkHandler(KrMainWindow *mainWindow)
 
     // create bookmark manager
     QString filename = QStandardPaths::writableLocation(QStandardPaths::GenericDataLocation) + QLatin1Char('/') + BOOKMARKS_FILE;
-    manager = new KBookmarkManager(filename);
+    manager = new KBookmarkManager(filename, this);
 
     connect(manager, &KBookmarkManager::changed, this, &KrBookmarkHandler::bookmarksChanged);
 
-- 
GitLab


From 63cbf45986e2821033ebc336383b59a2310144fb Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Wed, 3 Jul 2024 18:04:31 +0200
Subject: [PATCH 57/68] Register "Bring Main Window to Top" action as global
 shortcut with default 'Meta+k'

---
 CMakeLists.txt     | 1 +
 app/CMakeLists.txt | 1 +
 app/krusader.cpp   | 5 ++++-
 3 files changed, 6 insertions(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 9b60b5628..3b62bc957 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -49,6 +49,7 @@ find_package(KF6 ${KF6_MIN_VERSION} REQUIRED COMPONENTS
   CoreAddons
   Config
   DocTools
+  GlobalAccel
   I18n
   IconThemes
   ItemViews
diff --git a/app/CMakeLists.txt b/app/CMakeLists.txt
index 0ae8f84c3..766aa3fa5 100644
--- a/app/CMakeLists.txt
+++ b/app/CMakeLists.txt
@@ -69,6 +69,7 @@ target_link_libraries(krusader
                       GUI
                       Archive
                       JobMan
+                      KF6::GlobalAccel
                       KF6::Notifications
                       KF6::Parts
                       KF6::WindowSystem
diff --git a/app/krusader.cpp b/app/krusader.cpp
index 033aba6f3..6bf423969 100644
--- a/app/krusader.cpp
+++ b/app/krusader.cpp
@@ -25,6 +25,7 @@
 #include <KAcceleratorManager>
 #include <KActionCollection>
 #include <KCursor>
+#include <KGlobalAccel>
 #include <KLocalizedString>
 #include <KMessageBox>
 #include <KSharedConfig>
@@ -35,8 +36,8 @@
 #include <KWindowConfig>
 #include <KWindowSystem>
 #include <KXMLGUIFactory>
-#include <utility>
 #include <kx11extras.h>
+#include <utility>
 
 #include "defaults.h"
 #include "kractions.h"
@@ -342,6 +343,8 @@ void Krusader::setupActions()
     actionCollection()->addAction("bring_main_window_to_top", bringToTopAct);
     connect(bringToTopAct, &QAction::triggered, this, &Krusader::moveToTop);
 
+    KGlobalAccel::setGlobalShortcut(bringToTopAct, QKeySequence(Qt::META | Qt::Key_K));
+
     KrActions::setupActions(this);
     _krActions = new KrActions(this);
     _viewActions = new ViewActions(this, this);
-- 
GitLab


From 5a42013c65c77836b29731f46816643c0ea67af5 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Wed, 3 Jul 2024 18:06:52 +0200
Subject: [PATCH 58/68] Fix window focus of "Bring Main Window to Top" in
 Wayland

In tests it still did not work: Only the taskbar entry is activated but the
window is not focused and not moved to top.
---
 app/krusader.cpp | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/app/krusader.cpp b/app/krusader.cpp
index 6bf423969..7a333f0f4 100644
--- a/app/krusader.cpp
+++ b/app/krusader.cpp
@@ -565,7 +565,10 @@ void Krusader::moveToTop()
     if (isHidden())
         show();
 
-    KX11Extras::forceActiveWindow(winId());
+    KWindowSystem::activateWindow(windowHandle());
+    if (KWindowSystem::isPlatformX11()) {
+        KX11Extras::forceActiveWindow(winId());
+    }
 }
 
 bool Krusader::isRunning()
-- 
GitLab


From f6bb9406909711050b126607e4386bc2b83e51eb Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Thu, 4 Jul 2024 18:57:19 +0200
Subject: [PATCH 59/68] Add workaround to show main window with "Bring Main
 Window to Top" action in Wayland

---
 app/krusader.cpp | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/app/krusader.cpp b/app/krusader.cpp
index 7a333f0f4..a57a4efdd 100644
--- a/app/krusader.cpp
+++ b/app/krusader.cpp
@@ -565,7 +565,12 @@ void Krusader::moveToTop()
     if (isHidden())
         show();
 
-    KWindowSystem::activateWindow(windowHandle());
+    QWindow *window = windowHandle();
+    KWindowSystem::activateWindow(window);
+    if (!window->isActive() && KrGlobal::isWaylandPlatform) {
+        window->hide();
+        window->show();
+    }
     if (KWindowSystem::isPlatformX11()) {
         KX11Extras::forceActiveWindow(winId());
     }
-- 
GitLab


From 951b0125efe1954fdef9b6cea2538f069ec41dbf Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Fri, 5 Jul 2024 13:25:39 +0200
Subject: [PATCH 60/68] MountMan: Implement calculating free space of
 filesystems without explicit waiting

---
 app/MountMan/kmountmangui.cpp | 29 +++++++++++++++++------------
 1 file changed, 17 insertions(+), 12 deletions(-)

diff --git a/app/MountMan/kmountmangui.cpp b/app/MountMan/kmountmangui.cpp
index 7bb3e57a0..69d489143 100644
--- a/app/MountMan/kmountmangui.cpp
+++ b/app/MountMan/kmountmangui.cpp
@@ -45,6 +45,8 @@
 #define MTAB "/etc/mtab"
 #endif
 
+constexpr int fileSystemsFreeSpaceTimeout = 5'000; // msec
+
 KMountManGUI::KMountManGUI(KMountMan *mntMan)
     : QDialog(mntMan->parentWindow)
     , mountMan(mntMan)
@@ -209,7 +211,8 @@ void KMountManGUI::getSpaceData()
 
     // Potentially long running
     this->setCursor(Qt::WaitCursor);
-    int started = 0;
+    auto *signalsToWaitFor = new QAtomicInteger(0);
+    auto *eventLoop = new QEventLoop(this);
     for (auto &it : mounted) {
         // don't bother with invalid file systems
         if (mountMan->invalidFilesystem(it->mountType())) {
@@ -224,20 +227,22 @@ void KMountManGUI::getSpaceData()
         KIO::FileSystemFreeSpaceJob *job = KIO::fileSystemFreeSpace(QUrl::fromLocalFile(it->mountPoint()));
         Q_ASSERT(job != nullptr);
 
-        connect(job, &KIO::FileSystemFreeSpaceJob::finished, this,
-                [this, data](KJob *job){ this->freeSpaceResult(job, data); });
-        started++;
+        signalsToWaitFor->operator++();
+        connect(job, &KIO::FileSystemFreeSpaceJob::finished, this, [this, data, eventLoop, signalsToWaitFor](KJob *job) {
+            this->freeSpaceResult(job, data);
+
+            if (!signalsToWaitFor->deref()) {
+                eventLoop->quit(); // all done
+            }
+        });
     }
+
     QTimer timer;
     timer.setSingleShot(true);
-    QEventLoop loop;
-    connect(&timer, &QTimer::timeout, &loop, &QEventLoop::quit);
+    connect(&timer, &QTimer::timeout, eventLoop, &QEventLoop::quit);
+    timer.start(fileSystemsFreeSpaceTimeout);
 
-    //TODO: How better to wait for all to finish?
-    while (started != fileSystems.size()) {
-        timer.start(100); // 100ms Maybe this should be configurable
-        loop.exec();
-    }
+    eventLoop->exec(); // wait for signals until quit()
 
     this->setCursor(Qt::ArrowCursor);
     addNonMounted();
@@ -248,7 +253,7 @@ void KMountManGUI::freeSpaceResult(KJob *job, fsData data)
 {
     if (!job->error()) {
         KIO::FileSystemFreeSpaceJob *freeSpaceJob = qobject_cast<KIO::FileSystemFreeSpaceJob *>(job);
-        Q_ASSERT(job != nullptr);
+        Q_ASSERT(freeSpaceJob != nullptr);
         // Set the missing information, with the assumption the caller already set the rest
         data.setTotalBlks(freeSpaceJob->size() / 1024);
         data.setFreeBlks(freeSpaceJob->availableSize() / 1024);
-- 
GitLab


From d465de1bc4529f987cdf76523a7e23155cda2d57 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Fri, 5 Jul 2024 15:36:05 +0200
Subject: [PATCH 61/68] MountMan: Speed up updating mount points by caching
 Solid devices

---
 app/MountMan/kmountman.cpp    | 37 +++++++++++++++++++++++------------
 app/MountMan/kmountman.h      |  5 +++--
 app/MountMan/kmountmangui.cpp | 28 +++++++++++++++-----------
 app/MountMan/kmountmangui.h   |  2 +-
 4 files changed, 46 insertions(+), 26 deletions(-)

diff --git a/app/MountMan/kmountman.cpp b/app/MountMan/kmountman.cpp
index 852fc45dc..3f596e8e5 100644
--- a/app/MountMan/kmountman.cpp
+++ b/app/MountMan/kmountman.cpp
@@ -419,33 +419,46 @@ void KMountMan::delayedPerformAction(const QAction *action)
 }
 
 QString KMountMan::findUdiForPath(const QString &path, const Solid::DeviceInterface::Type &expType)
+{
+    const std::function deviceGetter = []() {
+        return Solid::Device::listFromType(Solid::DeviceInterface::Block);
+    };
+    return findUdiForPath(path, expType, deviceGetter);
+}
+
+QString KMountMan::findUdiForPath(const QString &path, const Solid::DeviceInterface::Type &expType, const std::function<QList<Solid::Device>()> &devicesGetter)
 {
     KMountPoint::List current = KMountPoint::currentMountPoints();
-    KMountPoint::List possible = KMountPoint::possibleMountPoints();
-    QExplicitlySharedDataPointer<KMountPoint> mp = findInListByMntPoint(current, path);
-    if (!(bool)mp) {
-        mp = findInListByMntPoint(possible, path);
-        if (!(bool)mp)
-            return QString();
+    QExplicitlySharedDataPointer<KMountPoint> mountPoint = findInListByMntPoint(current, path);
+
+    if (!static_cast<bool>(mountPoint)) {
+        KMountPoint::List possible = KMountPoint::possibleMountPoints();
+        mountPoint = findInListByMntPoint(possible, path);
+        if (!static_cast<bool>(mountPoint))
+            return {}; // cannot not find mount point for path
+    }
+    const QString mountPath = QDir(mountPoint->mountedFrom()).canonicalPath();
+    if (mountPath.isEmpty()) {
+        return {}; // mount point does not have a device (e.g. for virtual kernel filesystems)
     }
-    QString dev = QDir(mp->mountedFrom()).canonicalPath();
-    QList<Solid::Device> storageDevices = Solid::Device::listFromType(Solid::DeviceInterface::Block);
 
-    for (int p = storageDevices.count() - 1; p >= 0; p--) {
+    QList<Solid::Device> storageDevices = devicesGetter();
+
+    for (qsizetype p = storageDevices.count() - 1; p >= 0; p--) {
         Solid::Device device = storageDevices[p];
         QString udi = device.udi();
 
         auto *sb = device.as<Solid::Block>();
         if (sb) {
-            QString devb = QDir(sb->device()).canonicalPath();
+            QString devicePath = QDir(sb->device()).canonicalPath();
             if (expType != Solid::DeviceInterface::Unknown && !device.isDeviceInterface(expType))
                 continue;
-            if (devb == dev)
+            if (devicePath == mountPath)
                 return udi;
         }
     }
 
-    return QString();
+    return {}; // device not found
 }
 
 QString KMountMan::pathForUdi(const QString &udi)
diff --git a/app/MountMan/kmountman.h b/app/MountMan/kmountman.h
index e7c8376c2..2dc0290fb 100644
--- a/app/MountMan/kmountman.h
+++ b/app/MountMan/kmountman.h
@@ -59,8 +59,9 @@ public:
     explicit KMountMan(QWidget *parent);
     ~KMountMan();
 
-    // NOTE: this function needs some time (~50msec)
-    QString findUdiForPath(const QString &path, const Solid::DeviceInterface::Type &expType = Solid::DeviceInterface::Unknown);
+    // NOTE: this function may needs some time (~200msec)
+    static QString findUdiForPath(const QString &path, const Solid::DeviceInterface::Type &expType = Solid::DeviceInterface::Unknown);
+    static QString findUdiForPath(const QString &path, const Solid::DeviceInterface::Type &expType, const std::function<QList<Solid::Device>()> &devicesGetter);
     QString pathForUdi(const QString &udi);
 
 public slots:
diff --git a/app/MountMan/kmountmangui.cpp b/app/MountMan/kmountmangui.cpp
index 69d489143..8ba314006 100644
--- a/app/MountMan/kmountmangui.cpp
+++ b/app/MountMan/kmountmangui.cpp
@@ -289,18 +289,21 @@ void KMountManGUI::addNonMounted()
     }
 }
 
-void KMountManGUI::addItemToMountList(KrTreeWidget *lst, fsData &fs)
+void KMountManGUI::addItemToMountList(KrTreeWidget *lst, fsData &fs, const QList<Solid::Device> &blockDevices) const
 {
-    Solid::Device device(mountMan->findUdiForPath(fs.mntPoint(), Solid::DeviceInterface::StorageAccess));
+    const std::function deviceGetter = [blockDevices]() {
+        return blockDevices;
+    };
+    const auto udi = KMountMan::findUdiForPath(fs.mntPoint(), Solid::DeviceInterface::StorageAccess, deviceGetter);
+    Solid::Device device(udi);
 
     if (cbShowOnlyRemovable->isChecked() && !mountMan->removable(device))
         return;
+    const bool mtd = fs.mounted();
 
-    bool mtd = fs.mounted();
-
-    QString tSize = QString("%1").arg(KIO::convertSizeFromKiB(fs.totalBlks()));
-    QString fSize = QString("%1").arg(KIO::convertSizeFromKiB(fs.freeBlks()));
-    QString sPrct = QString("%1%").arg(100 - (fs.usedPerct()));
+    const QString tSize = QString("%1").arg(KIO::convertSizeFromKiB(fs.totalBlks()));
+    const QString fSize = QString("%1").arg(KIO::convertSizeFromKiB(fs.freeBlks()));
+    const QString sPrct = QString("%1%").arg(100 - (fs.usedPerct()));
     auto *item = new QTreeWidgetItem(lst);
     item->setText(0, fs.name());
     item->setText(1, fs.type());
@@ -308,14 +311,14 @@ void KMountManGUI::addItemToMountList(KrTreeWidget *lst, fsData &fs)
     item->setText(3, (mtd ? tSize : QString("N/A")));
     item->setText(4, (mtd ? fSize : QString("N/A")));
     item->setText(5, (mtd ? sPrct : QString("N/A")));
+    const auto *vol = device.as<Solid::StorageVolume>();
 
-    auto *vol = device.as<Solid::StorageVolume>();
     QString iconName;
-
     if (device.isValid())
         iconName = device.icon();
     else if (mountMan->networkFilesystem(fs.type()))
         iconName = "folder-remote";
+
     QStringList overlays;
     if (mtd) {
         overlays << "emblem-mounted";
@@ -341,8 +344,11 @@ void KMountManGUI::updateList()
     mountList->clearSelection();
     mountList->clear();
 
-    for (auto &fileSystem : fileSystems)
-        addItemToMountList(mountList, fileSystem);
+    // getting the list of devices is slow: do it one time for all items
+    const QList<Solid::Device> blockDevices = Solid::Device::listFromType(Solid::DeviceInterface::Block);
+    for (auto &fileSystem : fileSystems) {
+        addItemToMountList(mountList, fileSystem, blockDevices);
+    }
 
     currentItem = mountList->topLevelItem(currentIdx);
     for (int i = 0; i < mountList->topLevelItemCount(); i++) {
diff --git a/app/MountMan/kmountmangui.h b/app/MountMan/kmountmangui.h
index 2bb7f1b27..fa065eee2 100644
--- a/app/MountMan/kmountmangui.h
+++ b/app/MountMan/kmountmangui.h
@@ -60,7 +60,7 @@ protected slots:
 
 protected:
     QLayout *createMainPage(); // creator of the main page - filesystems
-    void addItemToMountList(KrTreeWidget *lst, fsData &fs);
+    void addItemToMountList(KrTreeWidget *lst, fsData &fs, const QList<Solid::Device> &blockDevices) const;
     fsData *getFsData(QTreeWidgetItem *item);
     QString getMntPoint(QTreeWidgetItem *item);
     void addNonMounted();
-- 
GitLab


From fca19e08750549a4924bb017c1323f10af308752 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Mon, 8 Jul 2024 15:51:27 +0200
Subject: [PATCH 62/68] KIO Iso: Create KCompressionDevice only for filename if
 mimetype is empty

---
 plugins/iso/kiso.cpp | 8 ++++++--
 1 file changed, 6 insertions(+), 2 deletions(-)

diff --git a/plugins/iso/kiso.cpp b/plugins/iso/kiso.cpp
index cd1eb58aa..f28fe0083 100644
--- a/plugins/iso/kiso.cpp
+++ b/plugins/iso/kiso.cpp
@@ -19,10 +19,10 @@
 #include <QMimeType>
 #include <qplatformdefs.h>
 
+#include <KCompressionDevice>
 #include <KConfig>
 #include <KConfigGroup>
 #include <KFilterBase>
-#include <KCompressionDevice>
 
 #include "libisofs/isofs.h"
 #include "qfilehack.h"
@@ -161,7 +161,11 @@ void KIso::prepareDevice(const QString &filename, const QString &mimetype, bool
             forced = true;
 
         KCompressionDevice *device;
-        device = new KCompressionDevice(filename, COMPRESSIONTYPEFORMIMETYPE(mimetype));
+        if (mimetype.isEmpty()) {
+            device = new KCompressionDevice(filename);
+        } else {
+            device = new KCompressionDevice(filename, COMPRESSIONTYPEFORMIMETYPE(mimetype));
+        }
         if (device->compressionType() == KCompressionDevice::None && forced) {
             delete device;
         } else {
-- 
GitLab


From e7ffeea7288fd375b49d0de9611e011964bd2ee6 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Fri, 12 Jul 2024 19:27:07 +0200
Subject: [PATCH 63/68] Fix crash on (any) action in toolbar context menu

And use standard GUI initialization of KXmlGui for
* toolbars visibility-
* statusbar visibility-
* configure shortcuts-
* configure toolbars-
actions in settings menu - instead of manual setup of these actions.
---
 app/kractions.cpp | 10 ----------
 app/krusader.cpp  | 25 +------------------------
 app/krusaderui.rc | 10 ++--------
 3 files changed, 3 insertions(+), 42 deletions(-)

diff --git a/app/kractions.cpp b/app/kractions.cpp
index 8bfd2521f..ac3378759 100644
--- a/app/kractions.cpp
+++ b/app/kractions.cpp
@@ -174,19 +174,9 @@ void KrActions::setupActions(Krusader *krusaderApp)
 
     NEW_KACTION(tmp, i18n("Tab-Switch panel"), nullptr, Qt::Key_Tab, MAIN_VIEW, SLOT(panelSwitch()), "tab");
 
-    KToggleToolBarAction *actShowToolBar = new KToggleToolBarAction(krusaderApp->toolBar(), i18n("Show Main Toolbar"), krusaderApp);
-    krusaderApp->actionCollection()->addAction(KStandardAction::name(KStandardAction::ShowToolbar), actShowToolBar);
-
-    KToggleToolBarAction *actShowJobToolBar = new KToggleToolBarAction(krusaderApp->toolBar("jobToolBar"), i18n("Show Job Toolbar"), krusaderApp);
-    krusaderApp->actionCollection()->addAction("toggle show jobbar", actShowJobToolBar);
-
-    KToggleToolBarAction *actShowActionsToolBar = new KToggleToolBarAction(krusaderApp->toolBar("actionsToolBar"), i18n("Show Actions Toolbar"), krusaderApp);
-    krusaderApp->actionCollection()->addAction("toggle actions toolbar", actShowActionsToolBar);
-
     actShowStatusBar = KStandardAction::showStatusbar(SLOTS, SLOT(updateStatusbarVisibility()), krusaderApp->actionCollection());
     KStandardAction::quit(krusaderApp, SLOT(quit()), krusaderApp->actionCollection());
     KStandardAction::configureToolbars(krusaderApp, SLOT(configureToolbars()), krusaderApp->actionCollection());
-    KStandardAction::keyBindings(krusaderApp->guiFactory(), SLOT(showConfigureShortcutsDialog()), krusaderApp->actionCollection());
 
     // the toggle actions
     NEW_KTOGGLEACTION(actToggleFnkeys, i18n("Show &FN Keys Bar"), nullptr, 0, SLOTS, SLOT(toggleFnkeys()), "toggle fn bar");
diff --git a/app/krusader.cpp b/app/krusader.cpp
index a57a4efdd..69a82a172 100644
--- a/app/krusader.cpp
+++ b/app/krusader.cpp
@@ -94,7 +94,6 @@ Krusader::Krusader(const QCommandLineParser &parser)
     App = this;
     krMainWindow = this;
     SLOTS = new KrSlots(this);
-    setXMLFile("krusaderui.rc"); // kpart-related xml file
 
     plzWait = new KrPleaseWaitHandler(this);
 
@@ -195,31 +194,18 @@ Krusader::Krusader(const QCommandLineParser &parser)
 
     // restore gui settings
     {
-        // now, check if we need to create a konsole_part
         // call the XML GUI function to draw the UI
-        createGUI(MAIN_VIEW->terminalDock()->part());
+        setupGUI(Default, "krusaderui.rc"); // kpart-related xml file
 
-        // this needs to be called AFTER createGUI() !!!
         updateUserActions();
         _listPanelActions->guiUpdated();
 
         // not using this. See savePosition()
         // applyMainWindowSettings();
 
-        const KConfigGroup cfgToolbar(krConfig, "Main Toolbar");
-        toolBar()->applySettings(cfgToolbar);
-
-        const KConfigGroup cfgJobBar(krConfig, "Job Toolbar");
-        toolBar("jobToolBar")->applySettings(cfgJobBar);
-
-        const KConfigGroup cfgActionsBar(krConfig, "Actions Toolbar");
-        toolBar("actionsToolBar")->applySettings(cfgActionsBar);
-
         // restore toolbars position and visibility
         restoreState(startupGroup.readEntry("State", QByteArray()));
 
-        statusBar()->setVisible(startupGroup.readEntry("Show status bar", _ShowStatusBar));
-
         MAIN_VIEW->updateGUI(startupGroup);
 
         // popular urls
@@ -391,20 +377,11 @@ void Krusader::saveSettings()
     KConfigGroup noGroup(krConfig, QString());
     noGroup.writeEntry("Config Version", KrGlobal::sConfigVersion);
 
-    // save toolbar settings
     KConfigGroup cfg(krConfig, "Main Toolbar");
-    toolBar()->saveSettings(cfg);
-
-    cfg = krConfig->group("Job Toolbar");
-    toolBar("jobToolBar")->saveSettings(cfg);
-
-    cfg = krConfig->group("Actions Toolbar");
-    toolBar("actionsToolBar")->saveSettings(cfg);
 
     cfg = krConfig->group("Startup");
     // save toolbar visibility and position
     cfg.writeEntry("State", saveState());
-    cfg.writeEntry("Show status bar", statusBar()->isVisible());
 
     // save panel and window settings
     if (cfg.readEntry("Remember Position", _RememberPos))
diff --git a/app/krusaderui.rc b/app/krusaderui.rc
index 3a631dc69..dafd53a24 100644
--- a/app/krusaderui.rc
+++ b/app/krusaderui.rc
@@ -2,7 +2,7 @@
 <!-- NOTE: Always update the version in the gui tag below if you make changes to the menu bar and its actions!
            This will trigger an update of the ~/.local/share/kxmlgui5/krusader/krusaderui.rc file next time
            user opens the application: the menu bar will be replaced with the new version, toolbars updated.  -->
-<gui version="28" name="krusader" >
+<gui version="29" name="krusader" >
  <MenuBar>
   <Menu name="file" >
    <text>&amp;File</text>
@@ -116,13 +116,7 @@
   </Menu>
   <Menu name="settings" noMerge="1">
    <text>&amp;Settings</text>
-   <Action name="options_show_menubar" />
-   <Menu name="show_toolbars" >
-     <text>&amp;Toolbars</text>
-     <Action name="options_show_toolbar" />
-     <Action name="toggle show jobbar" />
-     <Action name="toggle actions toolbar"/>
-   </Menu>
+   <Merge/>
    <Action name="options_show_statusbar" />
    <Action name="toggle fn bar" />
    <Action name="toggle terminal emulator" />
-- 
GitLab


From c7d469238953f74db5d697b668394675a6b1beff Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Sat, 13 Jul 2024 18:35:17 +0200
Subject: [PATCH 64/68] KrViewer: Fix crash on (any) action in toolbar context
 menu

---
 app/KViewer/krviewer.cpp | 6 ++----
 1 file changed, 2 insertions(+), 4 deletions(-)

diff --git a/app/KViewer/krviewer.cpp b/app/KViewer/krviewer.cpp
index 4f41e8e23..bd21a5867 100644
--- a/app/KViewer/krviewer.cpp
+++ b/app/KViewer/krviewer.cpp
@@ -66,7 +66,6 @@ KrViewer::KrViewer(QWidget *parent)
     , sizeY(-1)
 {
     // setWFlags(Qt::WType_TopLevel | WDestructiveClose);
-    setXMLFile("krviewer.rc"); // kpart-related xml file
     setHelpMenuEnabled(false);
 
     connect(&manager, &KParts::PartManager::activePartChanged, this, &KrViewer::createGUI);
@@ -174,6 +173,8 @@ KrViewer::KrViewer(QWidget *parent)
 
     // filtering out the key events
     menuBar()->installEventFilter(this);
+
+    setupGUI(ToolBar | StatusBar | Save | Create, "krviewer.rc");
 }
 
 KrViewer::~KrViewer()
@@ -202,9 +203,6 @@ void KrViewer::createGUI(KParts::Part *part)
 
     updateActions();
 
-    toolBar()->show();
-    statusBar()->show();
-
     // the KParts part may override the viewer shortcuts. We prevent it
     // by installing an event filter on the menuBar() and the part
     reservedKeys.clear();
-- 
GitLab


From 4af1097c3bd2e0d28b6fe86c172c79696b04296e Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Mon, 15 Jul 2024 15:42:15 +0200
Subject: [PATCH 65/68] Fix destroyed() signal of konsole_part connected too
 long to destroyed TerminalDock

Fixes fatal assertion warning and delay on quit.
---
 app/GUI/terminaldock.cpp | 27 +++++++++++++++++----------
 app/GUI/terminaldock.h   |  6 +-----
 2 files changed, 18 insertions(+), 15 deletions(-)

diff --git a/app/GUI/terminaldock.cpp b/app/GUI/terminaldock.cpp
index 7045e89c0..35cc597c3 100644
--- a/app/GUI/terminaldock.cpp
+++ b/app/GUI/terminaldock.cpp
@@ -52,19 +52,26 @@ TerminalDock::TerminalDock(QWidget *parent, KrMainWindow *mainWindow)
     : QWidget(parent)
     , _mainWindow(mainWindow)
     , konsole_part(nullptr)
-    , t(nullptr)
+    , terminal(nullptr)
     , initialised(false)
     , firstInput(true)
 {
     terminal_hbox = new QHBoxLayout(this);
 }
 
-TerminalDock::~TerminalDock() = default;
+TerminalDock::~TerminalDock()
+{
+    if (konsole_part) {
+        disconnect(konsole_part, &KParts::ReadOnlyPart::destroyed, this, &TerminalDock::killTerminalEmulator);
+    }
+};
 
 bool TerminalDock::initialise()
 {
     if (!initialised) { // konsole part is not yet loaded or it has already failed
-        KPluginFactory *pluginFactory = KPluginFactory::loadFactory(KPluginMetaData(QStringLiteral("kf6/parts/konsolepart"))).plugin;
+
+        const KPluginMetaData pluginMetaData(QStringLiteral("kf6/parts/konsolepart"));
+        KPluginFactory *pluginFactory = KPluginFactory::loadFactory(pluginMetaData).plugin;
 
         if (pluginFactory) {
             QWidget *focusW = qApp->focusWidget();
@@ -78,10 +85,10 @@ bool TerminalDock::initialise()
                 // by child widgets of konsole_part->widget()
                 // and would not be received on konsole_part->widget()
                 qApp->installEventFilter(this);
-                t = qobject_cast<TerminalInterface *>(konsole_part);
-                if (t) {
+                terminal = qobject_cast<TerminalInterface *>(konsole_part);
+                if (terminal) {
                     lastPath = QDir::currentPath();
-                    t->showShellInDir(lastPath);
+                    terminal->showShellInDir(lastPath);
                 }
                 initialised = true;
                 firstInput = true;
@@ -113,21 +120,21 @@ void TerminalDock::killTerminalEmulator()
 
     initialised = false;
     konsole_part = nullptr;
-    t = nullptr;
+    terminal = nullptr;
     qApp->removeEventFilter(this);
     MAIN_VIEW->setTerminalEmulator(false);
 }
 
 void TerminalDock::sendInput(const QString &input, bool clearCommand)
 {
-    if (!t)
+    if (!terminal)
         return;
 
     if (clearCommand) {
         // send SIGINT before input command to avoid unwanted behaviour when current line is not empty
         // and command is appended to current input (e.g. "rm -rf x " concatenated with 'cd /usr');
         // code "borrowed" from Dolphin
-        const int processId = t->terminalProcessId();
+        const int processId = terminal->terminalProcessId();
         // workaround (firstInput): kill is sent to terminal if shell is not initialized yet
         if (processId > 0 && !firstInput) {
             kill(processId, SIGINT);
@@ -135,7 +142,7 @@ void TerminalDock::sendInput(const QString &input, bool clearCommand)
     }
     firstInput = false;
 
-    t->sendInput(input);
+    terminal->sendInput(input);
 }
 
 /*! Sends a `cd` command to the embedded terminal emulator so as to synchronize the directory of the actual panel and
diff --git a/app/GUI/terminaldock.h b/app/GUI/terminaldock.h
index a00a28f5d..e3419e93f 100644
--- a/app/GUI/terminaldock.h
+++ b/app/GUI/terminaldock.h
@@ -43,10 +43,6 @@ public:
     void hideEvent(QHideEvent *e) override;
     void showEvent(QShowEvent *e) override;
     void onTerminalFocusChanged(bool focused);
-    inline KParts::Part *part()
-    {
-        return konsole_part;
-    }
 
 private slots:
     void killTerminalEmulator();
@@ -57,7 +53,7 @@ private:
     QString lastPath; // path of the last sendCd
     QHBoxLayout *terminal_hbox; // hbox for terminal_dock
     KParts::ReadOnlyPart *konsole_part; // the actual part pointer
-    TerminalInterface *t; // TerminalInterface of the konsole part
+    TerminalInterface *terminal; // TerminalInterface of the konsole part (same object)
     bool initialised;
     bool firstInput;
     bool applyShortcuts(QKeyEvent *ke);
-- 
GitLab


From 90a8a67bb152deadc58770186d471ad4e295b3c7 Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Thu, 5 Sep 2024 16:55:50 +0200
Subject: [PATCH 66/68] Fix and simplify getting the absolute hard-coded path
 to kdesu executable

* KDE_INSTALL_FULL_LIBEXECDIR_KF is used by default (specific KF6 version does not exist)
* Arch Linux specific path can be set with KDESU_PATH variable for CMake
---
 CMakeLists.txt | 7 +------
 INSTALL        | 2 +-
 2 files changed, 2 insertions(+), 7 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 3b62bc957..dbe167909 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -89,12 +89,7 @@ endif()
 
 # For security reasons, absolute kdesu path is set at build time and is not configurable.
 if(NOT KDESU_PATH)
-    if(EXISTS "${KDE_INSTALL_FULL_LIBDIR}/kf5/kdesu")
-      # Used by Arch distribution
-      set(KDESU_PATH "${KDE_INSTALL_FULL_LIBDIR}/kf5/kdesu")
-    else()
-      set(KDESU_PATH "${KDE_INSTALL_FULL_LIBEXECDIR_KF5}/kdesu")
-    endif()
+    set(KDESU_PATH "${KDE_INSTALL_FULL_LIBEXECDIR_KF}/kdesu")
 endif()
 add_definitions(-DKDESU_PATH="${KDESU_PATH}")
 message(STATUS "kdesu path has been hard-coded: ${KDESU_PATH}")
diff --git a/INSTALL b/INSTALL
index add016e10..b61bac844 100644
--- a/INSTALL
+++ b/INSTALL
@@ -160,7 +160,7 @@ them all (later there's an example):
 
 -DKDESU_PATH=/foo/bar/kdesu
   this needs to be set on distributions that override default kdesu installation
-  path (libexec/kf5/kdesu) or if your install prefix doesn't match KDE's.
+  path (libexec/kf6/kdesu) or if your install prefix doesn't match KDE's.
 
 -DENABLE_SYNCHRONIZER=OFF
   disables building the Synchronizer module. This module caused data loss, now
-- 
GitLab


From 7027c8fc4c16d29e14ae99678f2338e603b69f4c Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Thu, 5 Sep 2024 17:30:54 +0200
Subject: [PATCH 67/68] Remove outdated CMake variables

---
 CMakeLists.txt | 2 --
 1 file changed, 2 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index dbe167909..5afe7c5e1 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -94,8 +94,6 @@ endif()
 add_definitions(-DKDESU_PATH="${KDESU_PATH}")
 message(STATUS "kdesu path has been hard-coded: ${KDESU_PATH}")
 
-add_definitions(${QT_DEFINITIONS} ${KF5_DEFINITIONS})
-
 add_definitions(-DKRARC_ENABLED)
 add_definitions(-DQT_NO_URL_CAST_FROM_STRING)
 
-- 
GitLab


From e475add05ee998ebc963c6adaf10f85c08ea7edb Mon Sep 17 00:00:00 2001
From: Alexander Bikadorov <alex.bikadorov@kdemail.net>
Date: Sat, 7 Sep 2024 16:10:46 +0200
Subject: [PATCH 68/68] Panel: Remove separate adding of archive actions to
 context menu

Actions are already added with all other KFileItemActions and would be added
twice.
---
 app/Panel/panelcontextmenu.cpp | 47 ++++++++--------------------------
 app/Panel/panelcontextmenu.h   |  1 -
 2 files changed, 11 insertions(+), 37 deletions(-)

diff --git a/app/Panel/panelcontextmenu.cpp b/app/Panel/panelcontextmenu.cpp
index 506fb8be4..3374f9f9d 100644
--- a/app/Panel/panelcontextmenu.cpp
+++ b/app/Panel/panelcontextmenu.cpp
@@ -53,28 +53,6 @@ PanelContextMenu *PanelContextMenu::run(const QPoint &pos, KrPanel *panel)
     return menu;
 }
 
-/**
- * Copied from dolphin/src/dolphincontextmenu.cpp and modified to add only compress and extract submenus.
- */
-void PanelContextMenu::addCompressAndExtractPluginActions()
-{
-    KFileItemListProperties props(_items);
-
-    QVector<KPluginMetaData> jsonPlugins = KPluginMetaData::findPlugins("kf5/kfileitemaction", [=](const KPluginMetaData &metaData) {
-        return metaData.pluginId() == "compressfileitemaction" || metaData.pluginId() == "extractfileitemaction";
-    });
-
-    for (const KPluginMetaData &jsonMetadata : std::as_const(jsonPlugins)) {
-        KPluginFactory *pluginFactory = KPluginFactory::loadFactory(jsonMetadata.fileName()).plugin;
-
-        auto *abstractPlugin = pluginFactory->create<KAbstractFileItemActionPlugin>();
-        if (abstractPlugin) {
-            abstractPlugin->setParent(this);
-            addActions(abstractPlugin->actions(props, this));
-        }
-    }
-}
-
 PanelContextMenu::PanelContextMenu(KrPanel *krPanel, QWidget *parent)
     : QMenu(parent)
     , panel(krPanel)
@@ -199,24 +177,21 @@ PanelContextMenu::PanelContextMenu(KrPanel *krPanel, QWidget *parent)
     userAction->setText(i18n("User Actions"));
     addAction(userAction);
 
-    // --------------- compress/extract actions
-    // workaround for Bug 372999: application freezes very long time if many files are selected
-    if (_items.length() < 1000)
-        // add compress and extract plugins (if available)
-        addCompressAndExtractPluginActions();
-
     // --------------- KDE file item actions
-    // NOTE: design and usability problem here. Services disabled in kservicemenurc settings won't
-    // be added to the menu. But Krusader does not provide a way do change these settings (only
-    // Dolphin does).
-    auto *fileItemActions = new KFileItemActions(this);
-    fileItemActions->setItemListProperties(KFileItemListProperties(_items));
-    fileItemActions->setParentWidget(MAIN_VIEW);
+    // workaround for Bug 372999: application freezes very long time if many files are selected
+    if (_items.length() < 1000) {
+        // NOTE: design and usability problem here. Services disabled in kservicemenurc settings won't
+        // be added to the menu. But Krusader does not provide a way do change these settings (only
+        // Dolphin does).
+        auto *fileItemActions = new KFileItemActions(this);
+        fileItemActions->setItemListProperties(KFileItemListProperties(_items));
+        fileItemActions->setParentWidget(MAIN_VIEW);
 #if KIO_VERSION >= QT_VERSION_CHECK(5, 79, 0)
-    fileItemActions->addActionsTo(this);
+        fileItemActions->addActionsTo(this);
 #else
-    fileItemActions->addServiceActionsTo(this);
+        fileItemActions->addServiceActionsTo(this);
 #endif
+    }
 
     addSeparator();
 
diff --git a/app/Panel/panelcontextmenu.h b/app/Panel/panelcontextmenu.h
index 300e3f28b..5e92d6d9f 100644
--- a/app/Panel/panelcontextmenu.h
+++ b/app/Panel/panelcontextmenu.h
@@ -34,7 +34,6 @@ private:
     void performAction(int id);
     void addEmptyMenuEntries(); // adds the choices for a menu without selected items
     void addCreateNewMenu(); // adds a "create new" submenu
-    void addCompressAndExtractPluginActions(); // adds various plugin actions
 
     enum ID {
         OPEN_ID,
-- 
GitLab

